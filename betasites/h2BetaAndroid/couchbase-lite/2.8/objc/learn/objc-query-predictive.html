<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Predictive Query | Couchbase Docs</title>
<link rel="canonical" href="https://ibsoln.github.io/betasites/h2BetaAndroid/couchbase-lite/2.8/objc/learn/objc-query-predictive.html">
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Couchbase mobile database predictive query concepts">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">
<meta name="dcterms.subject" content="couchbase-lite">
<meta name="dcterms.identifier" content="2.8">
<meta name="generator" content="Antora 2.3.3">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">

              <a class="navbar-brand" href="../../../..">
                <img src="../../../../_/img/couchbase-documentation-logo.svg" alt="Couchbase" />
              </a>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/cloud.html">
                      Cloud
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      SDKs
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Tutorials
                      <span class="arrow">
                        <i class="fas fa-arrow-right"></i>
                      </span>
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <form class="navbar-item search">
                  <input type="text" placeholder="Search Docs" class="query" id="search-query" />
                  <button type="button" class="search-btn">
                    <i class="fas fa-search"></i>
                  </button>
                </form>
                <div class="parent-site">
                  <a href="https://www.couchbase.com">
                    Couchbase.com
                  </a>
                </div>
                <a class="btn btn-primary try-btn" href="https://www.couchbase.com/downloads">
                  Try Free
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<nav class="nav">
<div class="left-sidebar-menu">
<div class="version-control-box">
<div class="component-frame">
<div class="frame-icon">
<img src="../../../../_/img/server-icon.png" alt="">
</div>
<div class="frame-body">
<h4 class="title"><span class="">P2pBeta/81620</span></h4>
<a class="navbar-item component" href="../../index.html"> <span class="version">2.8</span></a>
</div>
</div>
</div>
<div class="nav-menu">
<ul class="nav-list">
<li class="nav-item " data-depth="0">

<span class="nav-line "  data-depth="0">
<span class="in-toggle" data-depth="0"></span>
<a class="nav-link" href="../../android/learn/java-android-p2psync.html">Introduction to P2P Sync</a>
</span>
<ul class="nav-list">
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="../../android/advance/java-android-p2psync-websocket-using-passive.html">Passive Peer</a>
</span>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="../../android/advance/java-android-p2psync-websocket-using-active.html">Active Peer</a>
</span>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-android">API References</a>
</span>
</li>
</ul>
</li>
</ul>
</div>
<a href="#" class="menu-expand-toggle"> <span>Navigation</span> <i class="fas fa-times-circle"></i> <i class="fas fa-chevron-circle-left"></i></a>
</div></nav>
<aside class="toc sidebar">
  <div class="sidebar-box">
      <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/ianbridge/CouchbaseDocs/bau/cbl/modules/objc/pages/learn/objc-query-predictive.adoc" title="Edit Page" target="_blank" rel="noopener">Edit on GitHub</a></li>
</ul>
</div>
      <div class="toc-menu"></div>
        <div class="is-this-helpful-box">
          <h4> Is this page helpful?</h4>
            <div class="btn-row">
              <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                     <i class="far fa-thumbs-up"></i>
                 Yes

                 </a>
              <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
            </div>
            <div class="any-feedback">
              <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
            </div>
            <div class="dialog-box" id="dialogBox">
              <form>
                  <div class="form-group " id="additionalFeedbackBox">
                    <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

                    <div class="action-btn-row ">
                      <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                       <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                       <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
                    </div>


                  </div>

              </form>

            </div>
      </div>
   </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../index.html">P2pBeta/81620</a></li>
<li class="crumb"><a href="objc-query-predictive.html">Predictive Query</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Predictive Query</h1>
<div class="labels">
<ul>
<li class="edition"><a href="https://www.couchbase.com/products/editions">Under Development</a></li>
<li class="status"><span>beta -- H2-CBL 81620</span></li>
</ul>
</div>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Couchbase mobile database predictive query concepts
</blockquote>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Enterprise Edition only</div>
Predictive Query is an <a href="https://www.couchbase.com/products/editions">Enterprise Edition</a> feature.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Predictive Query enables Couchbase Lite queries to use machine learning, by providing query functions that can process document data (properties or blobs) via trained ML models.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s consider an image classifier model that takes a picture as input and outputs a label and probability.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/predictive-diagram.png" alt="predictive diagram">
</div>
</div>
<div class="paragraph">
<p>To run a predictive query with a model as the one shown above, you must implement the following steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#integrate-the-model">Integrate the Model</a></p>
</li>
<li>
<p><a href="#register-the-model">Register the Model</a></p>
</li>
<li>
<p><a href="#create-an-index">Create an Index (Optional)</a></p>
</li>
<li>
<p><a href="#run-a-prediction-query">Run a Prediction Query</a></p>
</li>
<li>
<p><a href="#unregister-the-model">Unregister the Model</a></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrate-the-model"><a class="anchor" href="#integrate-the-model"></a>Integrate the Model</h3>
<div class="paragraph">
<p>To integrate a model with Couchbase Lite, you must implement the <code>PredictiveModel</code> interface which has only one function called <code>predict()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/SampleCodeTest.m#L25-L53">// `myMLModel` is a fake implementation
// this would be the implementation of the ml model you have chosen
@interface myMLModel : NSObject

+ (NSDictionary*)predictImage: (NSData*)data;

@end

@interface ImageClassifierModel : NSObject &lt;CBLPredictiveModel&gt;

- (nullable CBLDictionary*) predict: (CBLDictionary*)input;

@end

@implementation ImageClassifierModel

- (nullable CBLDictionary*) predict: (CBLDictionary*)input; {
    CBLBlob* blob = [input blobForKey:@"photo"];

    NSData* imageData = blob.content;
    // `myMLModel` is a fake implementation
    // this would be the implementation of the ml model you have chosen
    NSDictionary* modelOutput = [myMLModel predictImage:imageData];

    CBLMutableDictionary* output = [[CBLMutableDictionary alloc] initWithData: modelOutput];
    return output; <i class="conum" data-value="1"></i><b>(1)</b>
}

@end</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>predict(input) -&gt; output</code> method provides the input and expects the result of using the machine learning model.
The input and output of the predictive model is a <code>DictionaryObject</code>.
Therefore, the supported data type will be constrained by the data type that the <code>DictionaryObject</code> supports.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="register-the-model"><a class="anchor" href="#register-the-model"></a>Register the Model</h3>
<div class="paragraph">
<p>To register the model you must create a new instance and pass it to the <code>Database.prediction.registerModel</code> static method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/SampleCodeTest.m#L920-L921">ImageClassifierModel* model = [[ImageClassifierModel alloc] init];
[[CBLDatabase prediction] registerModel:model withName:@"ImageClassifier"];</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create-an-index"><a class="anchor" href="#create-an-index"></a>Create an Index</h3>
<div class="paragraph">
<p>Creating an index for a predictive query is highly recommended.
By computing the predictions during writes and building a prediction index, you can significantly improve the speed of prediction queries (which would otherwise have to be computed during reads).</p>
</div>
<div class="paragraph">
<p>There are two types of indexes for predictive queries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#value-index">Value Index</a></p>
</li>
<li>
<p><a href="#predictive-index">Predictive Index</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="value-index"><a class="anchor" href="#value-index"></a>Value Index</h4>
<div class="paragraph">
<p>The code below creates a value index from the "label" value of the prediction result.
When documents are added or updated, the index will call the prediction function to update the city value in the index.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/SampleCodeTest.m#L925-L929">CBLQueryExpression* input = [CBLQueryExpression dictionary: @{@"photo":[CBLQueryExpression property:@"photo"]}];
CBLQueryPredictionFunction* prediction = [CBLQueryFunction predictionUsingModel:@"ImageClassifier" input:input];

CBLValueIndex* index = [CBLIndexBuilder valueIndexWithItems:@[[CBLValueIndexItem expression:[prediction property:@"label"]]]];
[database createIndex:index withName:@"value-index-image-classifier" error:&amp;error];</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="predictive-index"><a class="anchor" href="#predictive-index"></a>Predictive Index</h4>
<div class="paragraph">
<p>Predictive Index is a new index type used for predictive query.
The Predictive Index is different from the value index in that the Predictive Index caches the predictive result and creates the value index from the cached predictive result when the predictive results values are specified.</p>
</div>
<div class="paragraph">
<p>The code below creates a predictive index from the "label" value of the prediction result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/SampleCodeTest.m#L942-L945">CBLQueryExpression* input = [CBLQueryExpression dictionary:@{@"photo":[CBLQueryExpression property:@"photo"]}];

CBLPredictiveIndex* index = [CBLIndexBuilder predictiveIndexWithModel:@"ImageClassifier" input:input properties:nil];
[database createIndex:index withName:@"predictive-index-image-classifier" error:&amp;error];</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-a-prediction-query"><a class="anchor" href="#run-a-prediction-query"></a>Run a Prediction Query</h3>
<div class="paragraph">
<p>The code below creates a query that calls the prediction function to return the "label" value for the first 10 results in the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/SampleCodeTest.m#L954-L965">CBLQueryExpression* input = [CBLQueryExpression dictionary: @{@"photo":[CBLQueryExpression property:@"photo"]}];
CBLQueryPredictionFunction* prediction = [CBLQueryFunction predictionUsingModel:@"ImageClassifier" input:input]; <i class="conum" data-value="1"></i><b>(1)</b>

CBLQueryExpression* condition = [[[prediction property:@"label"] equalTo:[CBLQueryExpression string:@"car"]]
                                 andExpression:[[prediction property:@"probablity"] greaterThanOrEqualTo:[CBLQueryExpression double:0.8]]];
CBLQuery* query = [CBLQueryBuilder select: @[[CBLQuerySelectResult all]]
                                     from: [CBLQueryDataSource database:database]
                                    where: condition];

// Run the query.
CBLQueryResultSet *result = [query execute:&amp;error];
NSLog(@"Number of rows :: %lu", (unsigned long)[[result allResults] count]);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>PredictiveModel.predict()</code> method returns a constructed Prediction Function object which can be used further to specify a property value extracted from the output dictionary of the <code>PredictiveModel.predict()</code> function.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The null value returned by the prediction method will be interpreted as MISSING value in queries.
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="unregister-the-model"><a class="anchor" href="#unregister-the-model"></a>Unregister the Model</h3>
<div class="paragraph">
<p>To unregister the model you must call the <code>Database.prediction.unregisterModel</code> static method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/SampleCodeTest.m#L933">[[CBLDatabase prediction] unregisterModelWithName:@"ImageClassifier"];</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrate-a-model-with-coremlpredictivemodel-ios-only"><a class="anchor" href="#integrate-a-model-with-coremlpredictivemodel-ios-only"></a>Integrate a Model with CoreMLPredictiveModel (iOS only)</h3>
<div class="paragraph">
<p><code>CoreMLPredictiveModel</code> is a Core ML based implementation of the <code>PredictiveModel</code> protocol that facilitates the integration of Core ML models with Couchbase Lite.</p>
</div>
<div class="paragraph">
<p>The following example describes how to load a Core ML model using <code>CoreMLPredictiveModel</code>.
All other steps (register, indexing, query, unregister) are the same as with a model that is integrated using your own <code>PredictiveModel</code> implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/SampleCodeTest.m#L973-L980">// Load MLModel from `ImageClassifier.mlmodel`
NSURL* modelURL = [[NSBundle mainBundle] URLForResource:@"ImageClassifier" withExtension:@"mlmodel"];
NSURL* compiledModelURL = [MLModel compileModelAtURL:modelURL error:&amp;error];
MLModel* model = [MLModel modelWithContentsOfURL:compiledModelURL error:&amp;error];
CBLCoreMLPredictiveModel* predictiveModel = [[CBLCoreMLPredictiveModel alloc] initWithMLModel:model];

// Register model
[[CBLDatabase prediction] registerModel:predictiveModel withName:@"ImageClassifier"];</code></pre>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase_logo_black.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>Â© 2020 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
