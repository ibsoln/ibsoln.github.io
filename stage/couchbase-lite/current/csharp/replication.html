<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Data Sync using Sync Gateway | Couchbase Docs</title>
<link rel="canonical" href="http://127.0.0.1:5000/couchbase-lite/current/csharp/replication.html">
<link rel="stylesheet" href="../../../_/css/site.css">
<script src="../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Couchbase Lite for C# -- Synchronizing data changes between local and remote databases using Sync Gateway">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">
<meta name="dcterms.subject" content="couchbase-lite">
<meta name="dcterms.identifier" content="3.0">
<meta name="page-url" content="/couchbase-lite/current/csharp/replication.html">
<meta name="generator" content="Antora 3.0.0-alpha.6">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com">
                    <img src="../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="http://127.0.0.1:5000/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/cloud.html">
                      Cloud
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../tutorials/index.html">
                      Tutorials
                      <span class="arrow">
                        <i class="fas fa-arrow-right"></i>
                      </span>
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a href="https://cloud.couchbase.com/sign-up" class="free-trial-link" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  <i class="fas fa-cloud"></i>
                  Free Trial
                </a>
                <a class="btn btn-primary try-btn"  onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
<div class="components">
  <div class="components_group-title">
    <a href="../../../home/mobile.html">Mobile</a>
  </div>
  <ul class="components_list">
    <li class="components_list-items">
      <div class="component_list-version">
        <span class="component_list_title">Couchbase Lite</span>
        <select class="version_list">
          <option value="3.0" selected>3.0</option>
        </select>
      </div>
      <div class="version_items hide" data-version="3.0">
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../index.html">Introduction</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../cbl-whatsnew.html">What&#8217;s New</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../android/quickstart.html">Android</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../android/gs-prereqs.html">Start Here!</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/querybuilder.html">QueryBuilder</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/querybuilder-n1ql.html">N1QL Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../android/landing-replications.html">Data Sync</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/dbreplica.html">Intra-device Data Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/replication.html">Remote Sync Gateway</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../android/p2psync-websocket.html">Peer-to-Peer</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/p2psync-websocket-using-passive.html">Passive Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/p2psync-websocket-using-active.html">Active Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/p2psync-custom.html">Integrate Custom Listener</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-android/">API&#160;References</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/dep-upgrade.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/troubleshooting-logs.html">Using Logs</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/troubleshooting-queries.html">Troubleshooting Queries</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/compatibility.html">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/supported-os.html">Supported OS</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../android/refer-glossary.html">Glossary</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../clang/quickstart.html">C</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../clang/gs-prereqs.html">Start Here!</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/querybuilder-n1ql.html">N1QL Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../clang/landing-replications.html">Data Sync</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/dbreplica.html">Intra-device Data Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/replication.html">Remote Sync Gateway</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../clang/p2psync-websocket.html">Peer-to-Peer</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/p2psync-websocket-using-passive.html">Passive Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/p2psync-websocket-using-active.html">Active Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/p2psync-custom.html">Integrate Custom Listener</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-c">API&#160;References</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/dep-upgrade.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/troubleshooting-logs.html">Using Logs</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/troubleshooting-queries.html">Troubleshooting Queries</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/compatibility.html">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/supported-os.html">Supported OS</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../clang/refer-glossary.html">Glossary</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="quickstart.html">C#.Net</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Start Here!</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="querybuilder.html">QueryBuilder</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="querybuilder-n1ql.html">N1QL Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="landing-replications.html">Data Sync</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="dbreplica.html">Intra-device Data Sync</a>
  </span>
</li>
<li class="menu_list is-current-page" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link is-current-page" href="replication.html">Remote Sync Gateway</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="p2psync-websocket.html">Peer-to-Peer</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="p2psync-websocket-using-passive.html">Passive Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="p2psync-websocket-using-active.html">Active Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="p2psync-custom.html">Integrate Custom Listener</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net">API&#160;References</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="dep-upgrade.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="troubleshooting-logs.html">Using Logs</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="troubleshooting-queries.html">Troubleshooting Queries</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="compatibility.html">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="supported-os.html">Supported OS</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="refer-glossary.html">Glossary</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../java/quickstart.html">Java</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../java/gs-prereqs.html">Start Here!</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/querybuilder.html">QueryBuilder</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/querybuilder-n1ql.html">N1QL Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../java/landing-replications.html">Data Sync</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/dbreplica.html">Intra-device Data Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/replication.html">Remote Sync Gateway</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../java/p2psync-websocket.html">Peer-to-Peer</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/p2psync-websocket-using-passive.html">Passive Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/p2psync-websocket-using-active.html">Active Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/p2psync-custom.html">Integrate Custom Listener</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-java/index.html?">API&#160;References</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/dep-upgrade.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/troubleshooting-logs.html">Using Logs</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/troubleshooting-queries.html">Troubleshooting Queries</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/compatibility.html">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/supported-os.html">Supported OS</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../java/refer-glossary.html">Glossary</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../objc/quickstart.html">Objective-C</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../objc/gs-prereqs.html">Start Here!</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/querybuilder.html">QueryBuilder</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/querybuilder-n1ql.html">N1QL Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../objc/landing-replications.html">Data Sync</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/dbreplica.html">Intra-device Data Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/replication.html">Remote Sync Gateway</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../objc/p2psync-websocket.html">Peer-to-Peer</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/p2psync-websocket-using-passive.html">Passive Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/p2psync-websocket-using-active.html">Active Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/p2psync-custom.html">Integrate Custom Listener</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-objc">API&#160;References</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/dep-upgrade.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/troubleshooting-logs.html">Using Logs</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/troubleshooting-queries.html">Troubleshooting Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/troubleshooting-crashes.html">Decoding Crash Logs</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/compatibility.html">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/supported-os.html">Supported OS</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../objc/refer-glossary.html">Glossary</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../swift/quickstart.html">Swift</a>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../swift/gs-prereqs.html">Start Here!</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/gs-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/gs-build.html">Build and Run</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/database.html">Databases</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/prebuilt-database.html">Pre-built Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/document.html">Documents</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/blob.html">Blobs</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Queries</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/querybuilder.html">QueryBuilder</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/querybuilder-n1ql.html">N1QL Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/query-resultsets.html">Query Resultsets</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/query-live.html">Live Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/query-troubleshooting.html">Query Troubleshooting</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/fts.html">Full Text Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../swift/landing-replications.html">Data Sync</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/dbreplica.html">Intra-device Data Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/replication.html">Remote Sync Gateway</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../swift/p2psync-websocket.html">Peer-to-Peer</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/p2psync-websocket-using-passive.html">Passive Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/p2psync-websocket-using-active.html">Active Peer</a>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/p2psync-custom.html">Integrate Custom Listener</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/conflict.html">Handling Data Conflicts</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-swift">API&#160;References</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/dep-upgrade.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/troubleshooting-logs.html">Using Logs</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/troubleshooting-queries.html">Troubleshooting Queries</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/troubleshooting-crashes.html">Decoding Crash Logs</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/releasenotes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#couchbase-lite:swift:compatibility.adoc">Compatibility</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#couchbase-lite:swift:supported-os.adoc">Supported OS</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../swift/refer-glossary.html">Glossary</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../javascript.html">JavaScript</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../javascript.html">JavaScript</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../../../sync-gateway/current/introduction.html">Sync&#160;Gateway</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#sync-gateway::refer/config-properties.adoc">Configure</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/rest-api-admin.html">REST API</a>
  </span>
</li>
</ul>
</li>
</ul>
      </div>
    </li>
    <li class="components_list-items">
      <div class="component_list-version">
        <span class="component_list_title">Sync Gateway</span>
        <select class="version_list">
          <option value="3.0" selected>3.0</option>
        </select>
      </div>
      <div class="version_items hide" data-version="3.0">
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../../../sync-gateway/current/introduction.html">Introduction</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/whatsnew.html">What&#8217;s New</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Start Here!</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/get-started-prepare.html">Prepare</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/get-started-install.html">Install</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/get-started-verify-install.html">Verify</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/data-modeling.html">Data Modeling</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Configuration</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/configuration-overview.html">Overview</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/configuration-schema-bootstrap.html">Bootstrap</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/rest-api-admin-database.html">Database</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/rest-api-admin-db-security.html">Database Security</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/rest-api-admin-access-control.html">Access Control</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/rest-api-admin-isgr.html">Inter-Sync&#160;Gateway Replication</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#sync-gateway::configuration-properties.adoc">Configuration <em><sup>(pre-3.0)</sup></em></a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">REST API</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/rest-api-access.html">REST API Access</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/rest-api.html">Public REST API</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/rest-api-admin.html">Admin REST API</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/rest-api-metrics.html">Metrics REST API</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/rest-api-client-app.html">Use the REST API?</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Security</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/authentication-users.html">User Authentication</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/authentication-certs.html">TLS Certificate Authentication</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Access Control</span>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="#sync-gateway::{access-control-concepts&amp;.adoc#8212;&amp;#8203;page}">Concepts</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <span class="menu_title menu_text">{access-control-model&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/channels.html">Channels</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/roles.html">Roles</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/users.html">Users</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../../../sync-gateway/current/sync-function.html">Sync Function</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#sync-gateway::{sync-function-overview&amp;.adoc#8212;&amp;#8203;page}">Overview</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="2">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="#sync-gateway::{sync-function-api&amp;.adoc#8212;&amp;#8203;page}">API Reference</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <span class="menu_title menu_text">{sync-function-api-access-cmd&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <span class="menu_title menu_text">{sync-function-api-channel-cmd&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <span class="menu_title menu_text">{sync-function-api-expiry-cmd&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <span class="menu_title menu_text">{sync-function-api-require-access-cmd&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <span class="menu_title menu_text">{sync-function-api-require-admin-cmd&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <span class="menu_title menu_text">{sync-function-api-require-role-cmd&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <span class="menu_title menu_text">{sync-function-api-require-user-cmd&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <span class="menu_title menu_text">{sync-function-api-role-cmd&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="3">
  <span class="menu_line">
    <span class="menu_title menu_text">{sync-function-api-throw-cmd&#8212;&#8203;xref}</span>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="#sync-gateway::{access-control-how&amp;.adoc#8212;&amp;#8203;page}">How-To</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <span class="menu_title menu_text">{access-control-how-create-users&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <span class="menu_title menu_text">{access-control-how-create-roles&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <span class="menu_title menu_text">{access-control-how-assign-users-to-roles&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <span class="menu_title menu_text">{access-control-how-control-document-access&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <span class="menu_title menu_text">{access-control-how-verify-access&#8212;&#8203;xref}</span>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <span class="menu_title menu_text">{access-control-how-use-xattrs-for-access-grants&#8212;&#8203;xref}</span>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/auto-purge-channel-access-revocation.html">Auto-purge on Channel Access Revocation</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Sync</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/sync-with-couchbase-server.html">Sync with Couchbase Server</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/sync-using-app.html">Sync Using App</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Inter-Sync Gateway Replication</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/sync-inter-syncgateway-overview.html">Overview</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/sync-inter-syncgateway-run.html">Initialize</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/sync-inter-syncgateway-manage.html">Manage</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/sync-inter-syncgateway-monitor.html">Monitor</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <span class="menu_title menu_text">{sgw-xref}sync-inter-syncgateway-conflict-resolution.adoc[Conflict Resolution]</span>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/revisions.html">Revisions</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/what-are-tombstones.html">Tombstones</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/managing-tombstones.html">Managing Tombstones</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/delta-sync.html">Delta Sync</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/resync.html">Resync</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/import-filter.html">Import filter</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Manage</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/stats-monitoring.html">Stats Monitoring</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Logging and Troubleshooting</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/logging.html">Logging</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/sgcollect-info.html">SGCollect Info</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/database-offline.html">Database Offline</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Deploy</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/deployment.html">Overview</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/command-line-options.html">Command Line Options</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/load-balancer.html">Load Balancer</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/os-level-tuning.html">OS-level Tuning</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/webhooks.html">Webhooks</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/changes-feed.html">Changes Feed</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/integrating-external-stores.html">External Stores</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/stats-prometheus.html">Prometheus Feed</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/indexing.html">Indexing</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/setting-up-dr-cluster.html">Disaster Recovery</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/upgrading.html">Upgrade</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Use Kubernetes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/deploy-cluster-to-kubernetes.html">Deploy</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#operator::tutorial-sync-gateway-manage.adoc">Manage a Sync Gateway Cluster</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#operator::tutorial-sync-gateway-clients.adoc">Expose Sync Gateway to Couchbase Lite clients</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/server-compatibility-collections.html">Collections</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/server-compatibility-eventing.html">Eventing</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/server-compatibility-transactions.html">Transactions</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/server-compatibility-xdcr.html">XDCR</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Product Notes</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/release-notes.html">Release Notes</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/supported-environments.html">Supported Environments</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/compatibility.html">Compatibility Matrix</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Legacy Features</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/legacy-sgreplicate-resolving-conflicts.html">SG-Replicate - Resolving Conflicts (depr)</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/legacy-sg-replicate.html">SG-Replicate</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/legacy-logging-pre2-1.html">Legacy Logging Pre2 1</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../../../sync-gateway/current/glossary.html">Glossary</a>
  </span>
</li>
</ul>
      </div>
    </li>
  </ul>
</div>
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/ianbridge/CouchbaseDocs/bau/cbl/modules/csharp/pages/replication.adoc" title="Edit Page" target="_blank" rel="noopener">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../index.html">Couchbase Lite</a></li>
<li class="crumb"><a href="quickstart.html">C#.Net</a></li>
<li class="crumb"><a href="landing-replications.html">Data Sync</a></li>
<li class="crumb"><a href="replication.html">Remote Sync Gateway</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Data Sync using Sync Gateway</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Description&#8201;&#8212;&#8201;<em>Couchbase Lite for C#&#8201;&#8212;&#8201;Synchronizing data changes between local and remote databases using Sync Gateway</em><br>
Related Content&#8201;&#8212;&#8201;<a href="conflict.html" class="page">Handling Data Conflicts</a> | <a href="dbreplica.html" class="page">Intra-device Data Sync</a> | <a href="p2psync-websocket.html" class="page">Peer-to-Peer</a></p>
</div>
</blockquote>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Code Snippets</div>
All code examples are indicative only.
They demonstrate the basic concepts and approaches to using a feature.
Use them as inspiration and adapt these examples to best practice when developing applications for your platform.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase Lite for C#.Net provides API support for secure, bi-directional, synchronization of data changes between mobile applications and a central server database.
It does so by using a replicator to interact with Sync Gateway.
Simply put, the replicator is designed to send documents from a source to a target database.
In this case, between a local Couchbase Lite database and remote Sync Gateway database (server or cloud).</p>
</div>
<div class="paragraph">
<p>This content provides sample code and configuration examples covering the implementation of a replication using Sync Gateway.</p>
</div>
<div class="paragraph">
<p>Your application runs a replicator (also referred to here as a client), which  will initiate connection with a Sync Gateway (also referred to here as a server) and participate in the replication of database changes to bring both local and remote databases into sync.</p>
</div>
<div class="paragraph">
<p>Subsequent sections provide additional details and examples for the main configuration options.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="replication-protocol"><a class="anchor" href="#replication-protocol"></a>Replication Protocol</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="scheme"><a class="anchor" href="#scheme"></a>Scheme</h3>
<div class="paragraph">
<p>Couchbase Mobile uses a replication protocol based on WebSockets fof replication.
To use this protocol the replication URL should specify WebSockets as the URL scheme (see the <a href="#lbl-cfg-tgt">[lbl-cfg-tgt]</a> section below).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Incompatibilities</dt>
<dd>
<p>Couchbase Lite&#8217;s replication protocol is <strong>incompatible</strong> with CouchDB-based databases.
And since Couchbase Lite 2.x+ only supports the new protocol, you will need to run a version of Sync Gateway that supports it&#8201;&#8212;&#8201;see: <a href="compatibility.html" class="page">Compatibility</a>.</p>
</dd>
<dt class="hdlist1">Legacy Compatibility</dt>
<dd>
<p>Clients using Couchbase Lite 1.x can continue to use <code>http</code> as the URL scheme.
Sync Gateway 2.x+ will automatically use:</p>
<div class="ulist">
<ul>
<li>
<p>The 1.x replication protocol when a Couchbase Lite 1.x client connects through <code>http://localhost:4984/db</code></p>
</li>
<li>
<p>The 2.0 replication protocol when a Couchbase Lite 2.0 client connects through <code>ws://localhost:4984/db</code>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can find further information in our blog: <a href="https://blog.couchbase.com/data-replication-couchbase-mobile/" target="_blank" rel="noopener">Introducing the Data Replication Protocol</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="lbl-repl-ord"><a class="anchor" href="#lbl-repl-ord"></a>Ordering</h3>
<div class="paragraph">
<p>To optimize for speed, the replication protocol doesn&#8217;t guarantee that documents will be received in a particular order.
So we don&#8217;t recommend to rely on that when using the replication or database change listeners for example.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-summary"><a class="anchor" href="#configuration-summary"></a>Configuration Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You should configure and initialize a replicator for each Couchbase Lite database instance you want to sync.
<a href="#ex-simple-repl">Example 1</a> shows the configuration and initialization process.</p>
</div>
<div id="ex-simple-repl" class="exampleblock">
<div class="title">Example 1. Replication configuration and initialization</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">// . . . preceding code. for example . . .
private static ListenerToken _thisListenerToken;
var Database thisDB;
// . . . other code . . .
// initialize the replicator configuration

var thisUrl = new URLEndpoint("wss://listener.com:4984/otherDB"); <i class="conum" data-value="1"></i><b>(1)</b>
var config = new ReplicatorConfiguration(thisDB, thisUrl);


// Set replicator type
thisConfig.ReplicatorType = ReplicatorType.PushAndPull;

// Configure Sync Mode
thisConfig.Continuous = true; // default value

// Configure Server Security -- only accept self-signed certs
thisConfig.AcceptOnlySelfSignedServerCertificate = true; <i class="conum" data-value="2"></i><b>(2)</b>

// Configure Client Security <i class="conum" data-value="3"></i><b>(3)</b>
// Configure basic auth using user credentials
thisConfig.Authenticator = new BasicAuthenticator("Our Username", "Our Password");

/* Optionally set a conflict resolver call back */ <i class="conum" data-value="4"></i><b>(4)</b>
// Use built-in resolver
thisConfig.ConflictResolver = new LocalWinConflictResolver();  //

// optionally use custom resolver
thisConfig.ConflictResolver = new ConflictResolver(
  (conflict) =&gt; {
    /* define resolver function */
  }
); //

// Initialize and start a replicator
// Initialize replicator with configuration data
var thisReplicator = new Replicator(thisConfig); <i class="conum" data-value="5"></i><b>(5)</b>

//Optionally add a change listener <i class="conum" data-value="6"></i><b>(6)</b>
_thisListenerToken =
  thisReplicator.AddChangeListener((sender, args) =&gt;
    {
      if (args.Status.Activity == ReplicatorActivityLevel.Stopped) {
          Console.WriteLine("Replication stopped");
      }
    });

// Start replicator
thisReplicator.Start(); <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>Notes on Example</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html">ReplicatorConfiguration</a> class&#8217;s constructor&#8201;&#8212;&#8201;<a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration__ctor_Couchbase_Lite_Database_Couchbase_Lite_Sync_IEndpoint">ReplicatorConfiguration(Database database, IEndpoint target)</a>&#8201;&#8212;&#8201;to initialize the replicator configuration with the local database&#8201;&#8212;&#8201;see also: <a href="#lbl-cfg-tgt">[lbl-cfg-tgt]</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure how the client will authenticate the server.
Here we say connect only to servers presenting a self-signed certificate.
By default, clients accept only servers presenting certificates that can be verified using the OS bundled Root CA Certificates&#8201;&#8212;&#8201;see: <a href="#lbl-svr-auth">[lbl-svr-auth]</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the credentials the client will present to the server.
Here we say to provide <em>Basic Authentication</em> credentials. Other options are available&#8201;&#8212;&#8201;see: <a href="#lbl-client-auth">[lbl-client-auth]</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configure how the replication should handle conflict resolution&#8201;&#8212;&#8201;see: <a href="conflict.html" class="page">Handling Data Conflicts</a> topic for mor on conflict resolution.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Initialize the replicator using your configuration object&#8201;&#8212;&#8201;see: <a href="#lbl-init-repl">[lbl-init-repl]</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Optionally, register an observer, which will notify you of changes to the replication status&#8201;&#8212;&#8201;see: <a href="#lbl-repl-mon">[lbl-repl-mon]</a></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Start the replicator &#8201;&#8212;&#8201;see: <a href="#lbl-repl-start">[lbl-repl-start]</a>.</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div id="lbl-cfg-repl" class="paragraph">
<p>== Configure</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">In this section</dt>
<dd>
<p><a href="#lbl-cfg-tgt">[lbl-cfg-tgt]</a>  |  <a href="#lbl-cfg-sync">[lbl-cfg-sync]</a>  |  <a href="#lbl-cfg-keep-alive">[lbl-cfg-keep-alive]</a>  |  <a href="#lbl-svr-auth">[lbl-svr-auth]</a>  | <a href="#lbl-client-auth">[lbl-client-auth]</a> | <a href="#lbl-repl-evnts">[lbl-repl-evnts]</a> |  <a href="#lbl-repl-hdrs">[lbl-repl-hdrs]</a> |  <a href="#lbl-repl-ckpt">[lbl-repl-ckpt]</a> |  <a href="#lbl-repl-fltrs">[lbl-repl-fltrs]</a> | <a href="#lbl-repl-chan">[lbl-repl-chan]</a> | <a href="#lbl-repl-delta">[lbl-repl-delta]</a></p>
</dd>
</dl>
</div>
<div id="lbl-cfg-tgt" class="paragraph">
<p>=== Configure Target</p>
</div>
<div class="paragraph">
<p>Use the
<a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html">ReplicatorConfiguration</a> class and <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration__ctor_Couchbase_Lite_Database_Couchbase_Lite_Sync_IEndpoint">ReplicatorConfiguration(Database database, IEndpoint target)</a> constructor to initialize the replication configuration with local and remote database locations.</p>
</div>
<div class="paragraph">
<p>The constructor provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the name of the local database to be sync&#8217;d</p>
</li>
<li>
<p>the server&#8217;s URL (including the port number and the name of the remote database to sync with)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>It is expected that the app will identify the IP address and URL and append the remote database name to the URL endpoint, producing for example: <code>wss://10.0.2.2:4984/travel-sample</code></p>
</div>
<div class="paragraph">
<p>The URL scheme for web socket URLs uses <code>ws:</code> (non-TLS) or <code>wss:</code> (SSL/TLS) prefixes.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">//
// Program.cs
//
// Copyright (c) 2017 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Cryptography.X509Certificates;
using System.Threading;
using System.Threading.Tasks;

using Couchbase.Lite;
using Couchbase.Lite.Enterprise.Query;
using Couchbase.Lite.Logging;
using Couchbase.Lite.P2P;
using Couchbase.Lite.Query;
using Couchbase.Lite.Sync;
using Newtonsoft.Json;

using SkiaSharp;

namespace api_walkthrough
{
    class Program
    {
        private static Database _Database;
        private static Replicator _Replicator;
        private static URLEndpointListener _listener;
        private static ListenerToken _ListenerToken;
        private static bool _NeedsExtraDocs;

        #region Private Methods

        private static void GettingStarted()
        {
            // tag::getting-started[]
            // Get the database (and create it if it doesn't exist)
            var database = new Database("mydb");
            // Create a new document (i.e. a record) in the database
            string id = null;
            using (var mutableDoc = new MutableDocument()) {
                mutableDoc.SetFloat("version", 2.0f)
                    .SetString("type", "SDK");

                // Save it to the database
                database.Save(mutableDoc);
                id = mutableDoc.Id;
            }

            // Update a document
            using (var doc = database.GetDocument(id))
            using (var mutableDoc = doc.ToMutable()) {
                mutableDoc.SetString("language", "C#");
                database.Save(mutableDoc);

                using (var docAgain = database.GetDocument(id)) {
                    Console.WriteLine($"Document ID :: {docAgain.Id}");
                    Console.WriteLine($"Learning {docAgain.GetString("language")}");
                }
            }

            // Create a query to fetch documents of type SDK
            // i.e. SELECT * FROM database WHERE type = "SDK"
            using (var query = QueryBuilder.Select(SelectResult.All())
                .From(DataSource.Database(database))
                .Where(Expression.Property("type").EqualTo(Expression.String("SDK")))) {
                // Run the query
                var result = query.Execute();
                Console.WriteLine($"Number of rows :: {result.Count()}");
            }

            // Create replicator to push and pull changes to and from the cloud
            var targetEndpoint = new URLEndpoint(new Uri("ws://localhost:4984/getting-started-db"));
            var replConfig = new ReplicatorConfiguration(database, targetEndpoint);

            // Add authentication
            replConfig.Authenticator = new BasicAuthenticator("john", "pass");

            // Create replicator (make sure to add an instance or static variable
            // named _Replicator)
            _Replicator = new Replicator(replConfig);
            _Replicator.AddChangeListener((sender, args) =&gt;
            {
                if (args.Status.Error != null) {
                    Console.WriteLine($"Error :: {args.Status.Error}");
                }
            });

            _Replicator.Start();

            // Later, stop and dispose the replicator *before* closing/disposing the database
            // end::getting-started[]
        }

        private static void TestReplicatorConflictResolver()
        {
            // tag::replication-conflict-resolver[]
            var target = new URLEndpoint(new Uri("ws://localhost:4984/mydatabase"));
            var replConfig = new ReplicatorConfiguration(database, target);
            replConfig.ConflictResolver = new LocalWinConflictResolver();

            var replicator = new Replicator(replConfig);
            replicator.Start();
            // end::replication-conflict-resolver[]
        }

        private static void TestSaveWithConflictHandler()
        {
            // tag::update-document-with-conflict-handler[]
            using (var document = database.GetDocument("xyz"))
            using (var mutableDocument = document.ToMutable()) {
                mutableDocument.SetString("name", "apples");
                database.Save(mutableDocument, (updated, current) =&gt;
                {
                    var currentDict = current.ToDictionary();
                    var newDict = updated.ToDictionary();
                    var result = newDict.Concat(currentDict)
                        .GroupBy(kv =&gt; kv.Key)
                        .ToDictionary(g =&gt; g.Key, g =&gt; g.First().Value);
                    updated.SetData(result);
                    return true;
                });
            }
            // end::update-document-with-conflict-handler[]
        }

        private static bool IsValidCredential(string name, SecureString password) { return true;  } // helper
        private static void TestInitListener()
        {
            var db = new Database("other-database");
            _Database = db;

            // tag::init-urllistener[]
            var config = new URLEndpointListenerConfiguration(_Database);
            config.TlsIdentity = null; // Use with anonymous self-signed cert
            config.Authenticator = new ListenerPasswordAuthenticator((sender, username, password) =&gt;
            {
                if(IsValidCredential(username, password)) {
                    return true;
                }

                return false;
            });

            _listener = new URLEndpointListener(config);
            // end::init-urllistener[]
        }

        private static void TestListenerStart()
        {
            // tag::start-urllistener[]
            // CouchbaseLiteException will be thrown when the listener cannot be started. The most common error
            // would be that the configured port has already been used.
            _listener.Start();
            // end::start-urllistener[]
        }

        private static void TestListenerStop()
        {
            // tag::stop-urllistener[]
            _listener.Stop();
            // end::stop-urllistener[]
        }

        private static void TestCreateSelfSignedCert()
        {
            TLSIdentity identity;
            X509Store _store =
             new X509Store(StoreName.My);
              // The identity will be stored in the secure
              // storage using the given label.
            DateTimeOffset fiveMinToExpireCert = DateTimeOffset.UtcNow.AddMinutes(5);

            // tag::create-self-signed-cert[]
            // tag::listener-config-tls-id-SelfSigned[]
            identity = TLSIdentity.CreateIdentity(true, /* isServer */
                new Dictionary&lt;string, string&gt;() { { Certificate.CommonNameAttribute, "Couchbase Inc" } },
                    // The common name attribute is required
                    // when creating a CSR. If it is not presented
                    // in the cert, an exception is thrown.
                fiveMinToExpireCert,
                    // If the expiration date is not specified,
                    // the certs expiration will be 365 days
                _store,
                "CBL-Server-Cert",
                null);  // The key label to get cert in certificate map.
                        // If null, the same default directory
                        // for a Couchbase Lite db is used for map.

            // end::listener-config-tls-id-SelfSigned[]
            // end::create-self-signed-cert[]
        }

        private static void TestImportTLSIdentity()
        {
            TLSIdentity identity;
            X509Store _store = new X509Store(StoreName.My); // The identity will be stored in the secure storage using the given label
            byte[] data = File.ReadAllBytes("C:\\client.p12"); // PKCS12 data containing private key, public key, and certificates

            // tag::import-tls-identity[]
            // tag::listener-config-tls-id-caCert[]
            identity = TLSIdentity.ImportIdentity(_store,
                data,
                "123", // The password that is needed to access the certificate data
                "CBL-Client-Cert",
                null);  // The key label to get cert in certificate map.
                        // If null, the same default directory
                        // for a Couchbase Lite db is used for map.
            // end::listener-config-tls-id-caCert[]
            // end::import-tls-identity[]
        }

          private static void TestClientCertAuthenticatorRootCerts()
        {
            var db = new Database("other-database");
            _Database = db;

            X509Store _store = new X509Store(StoreName.My);
            TLSIdentity identity;

            // tag::client-cert-authenticator-root-certs[]
            byte[] caData, clientData;
            clientData = File.ReadAllBytes("C:\\client.p12"); // PKCS12 data containing private key, public key, and certificates
            caData = File.ReadAllBytes("C:\\client-ca.der");

            // Root certs
            var rootCert = new X509Certificate2(caData);
            var auth = new ListenerCertificateAuthenticator(new X509Certificate2Collection(rootCert));

            // Create URL Endpoint Listener
            var listenerConfig = new URLEndpointListenerConfiguration(_Database);
            listenerConfig.DisableTLS = false; //The default value is false which means that the TLS will be enabled by default.
            listenerConfig.Authenticator = auth;
            _listener = new URLEndpointListener(listenerConfig);
            _listener.Start();

            // Client identity
            identity = TLSIdentity.ImportIdentity(_store,
                clientData,
                "123",
                "CBL-Client-Cert",
                null);

            // Replicator -- Client
            var database = new Database("client-database");
            var builder = new UriBuilder(
                "wss",
                "localhost",
                _listener.Port,
                $"/{_listener.Config.Database.Name}"
            );

            var url = builder.Uri;
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.ReplicatorType = ReplicatorType.PushAndPull;
            config.Continuous = false;
            config.Authenticator = new ClientCertificateAuthenticator(identity);
            config.AcceptOnlySelfSignedServerCertificate = true;
            config.PinnedServerCertificate = _listener.TlsIdentity.Certs[0];
            using (var replicator = new Replicator(config)) {
                replicator.Start();
            }

            // Stop listener after replicator is stopped
            _listener.Stop();
            // end::client-cert-authenticator-root-cert
        }

        private static void TestClientCertAuthenticator()
        {
            var db = new Database("other-database");
            _Database = db;

            X509Store _store = new X509Store(StoreName.My);
            TLSIdentity identity;

            // tag::client-cert-authenticator[]

            // Create Listener Certificate Authenticator
            var auth = new ListenerCertificateAuthenticator((sender, cert) =&gt;
            {
                if (cert.Count != 1) {
                    return false;
                }

                return cert[0].SubjectName.Name?.Replace("CN=", "") == "couchbase";
            });

            // Create URL Endpoint Listener
            var listenerConfig = new URLEndpointListenerConfiguration(_Database);
            listenerConfig.DisableTLS = false; //The default value is false which means that the TLS will be enabled by default.
            listenerConfig.Authenticator = auth;
            _listener = new URLEndpointListener(listenerConfig);
            _listener.Start();

            // User Identity
            identity = TLSIdentity.CreateIdentity(false,
                new Dictionary&lt;string, string&gt;() { { Certificate.CommonNameAttribute, "couchbase" } },
                null,
                _store,
                ClientCertLabel,
                null);

            // Replicator -- Client
            var database = new Database("client-database");
            var builder = new UriBuilder(
                "wss",
                "localhost",
                _listener.Port,
                $"/{_listener.Config.Database.Name}"
            );

            var url = builder.Uri;
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.ReplicatorType = ReplicatorType.PushAndPull;
            config.Continuous = false;
            config.Authenticator = new ClientCertificateAuthenticator(identity);
            config.AcceptOnlySelfSignedServerCertificate = false;
            config.PinnedServerCertificate = _listener.TlsIdentity.Certs[0];
            using (var replicator = new Replicator(config)) {
                replicator.Start();
            }

            // Stop listener after replicator is stopped
            _listener.Stop();
            // end::client-cert-authenticator[]
        }

        private static void UseEncryption()
        {
            // Enterprise edition only

            // tag::database-encryption[]
            // Create a new, or open an existing database with encryption enabled
            var config = new DatabaseConfiguration
            {
                // Or, derive a key yourself and pass a byte array of the proper size
                EncryptionKey = new EncryptionKey("password")
            };

            using (var db = new Database("seekrit", config)) {
                // Change the encryption key (or add encryption if the DB is unencrypted)
                db.ChangeEncryptionKey(new EncryptionKey("betterpassw0rd"));

                // Remove encryption
                db.ChangeEncryptionKey(null);
            }
            // end::database-encryption[]
        }

        private static void ResetReplicatorCheckpoint()
        {
            var database = _Database;
            var url = new Uri("ws://localhost:4984/db");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            using (var replicator = new Replicator(config)) {
                // tag::replication-reset-checkpoint[]
                // replicator is a Replicator instance
                replicator.ResetCheckpoint();
                replicator.Start();
                // end::replication-reset-checkpoint[]
            }
        }

        private static void Read1xAttachment()
        {
            var db = _Database;
            using (var document = new MutableDocument()) {
                // tag::1x-attachment[]
                var attachments = document.GetDictionary("_attachments");
                var avatar = attachments.GetBlob("avatar");
                var content = avatar?.Content;
                // end::1x-attachment[]
            }
        }

        private static void CreateNewDatabase()
        {
            // tag::new-database[]
            var db = new Database("my-database");
            // end::new-database[]

            _Database = db;
        }

        private static void CloseDatabase()
        {
          // tag::close-database[]
          database.close()

          // end::close-database[]
        }

        private static void ChangeLogging()
        {
            // tag::logging[]
            Database.SetLogLevel(LogDomain.Replicator, LogLevel.Verbose);
            Database.SetLogLevel(LogDomain.Query, LogLevel.Verbose);
            // end::logging[]
        }

        private static void LoadPrebuilt()
        {
            // tag::prebuilt-database[]
            // Note: Getting the path to a database is platform-specific.  For .NET Core / .NET Framework this
            // can be a simple filesystem path.  For UWP, you will need to get the path from your assets.  For
            // iOS you need to get the path from the main bundle.  For Android you need to extract it from your
            // assets to a temporary directory and then pass that path.
            var path = Path.Combine(Environment.CurrentDirectory, "travel-sample.cblite2" + Path.DirectorySeparatorChar);
            if (!Database.Exists("travel-sample", null)) {
                _NeedsExtraDocs = true;
                Database.Copy(path, "travel-sample", null);
            }
            // end::prebuilt-database[]

            _Database.Close();
            _Database = new Database("travel-sample");
        }

        private static void QueryDeletedDocuments()
        {
            // tag::query-deleted-documents[]
            // Query documents that have been deleted
            var query = QueryBuilder
                .Select(SelectResult.Expression(Meta.ID))
                .From(DataSource.Database(db))
                .Where(Meta.IsDeleted);
            // end::query-deleted-documents[]
        }

        private static void CreateDocument()
        {
            var db = _Database;
            // tag::initializer[]
            using (var newTask = new MutableDocument("xyz")) {
                newTask.SetString("type", "task")
                    .SetString("owner", "todo")
                    .SetDate("createdAt", DateTimeOffset.UtcNow);

                db.Save(newTask);
            }
            // end::initializer[]
        }

        private static void UpdateDocument()
        {
            var db = _Database;
            // tag::update-document[]
            using(var document = db.GetDocument("xyz"))
            using (var mutableDocument = document.ToMutable()) {
                mutableDocument.SetString("name", "apples");
                db.Save(mutableDocument);
            }
            // end::update-document[]
        }

        private static void UseTypedAccessors()
        {
            using (var newTask = new MutableDocument()) {
                // tag::date-getter[]
                newTask.SetValue("createdAt", DateTimeOffset.UtcNow);
                var date = newTask.GetDate("createdAt");
                // end::date-getter[]

                Console.WriteLine(date);
            }
        }

        private static void DoBatchOperation()
        {
            var db = _Database;
            // tag::batch[]
            db.InBatch(() =&gt;
            {
                for (var i = 0; i &lt; 10; i++) {
                    using (var doc = new MutableDocument()) {
                        doc.SetString("type", "user");
                        doc.SetString("name", $"user {i}");
                        doc.SetBoolean("admin", false);
                        db.Save(doc);
                        Console.WriteLine($"Saved user document {doc.GetString("name")}");
                    }
                }
            });
            // end::batch[]
        }

        private static void DatabaseChangeListener()
        {
            var db = _Database;

            // tag::document-listener[]
            db.AddDocumentChangeListener("user.john", (sender, args) =&gt;
            {
                using (var doc = Db.GetDocument(args.DocumentID)) {
                    Console.WriteLine($"Status :: {doc.GetString("verified_account")}");
                }
            });
            // end::document-listener[]
        }

        private static void DocumentExpiration()
        {
            var db = _Database;

            // tag::document-expiration[]
            // Purge the document one day from now
            var ttl = DateTimeOffset.UtcNow.AddDays(1);
            db.SetDocumentExpiration("doc123", ttl);

            // Reset expiration
            db.SetDocumentExpiration("doc1", null);

            // Query documents that will be expired in less than five minutes
            var fiveMinutesFromNow = DateTimeOffset.UtcNow.AddMinutes(5).ToUnixTimeMilliseconds();
            var query = QueryBuilder
                .Select(SelectResult.Expression(Meta.ID))
                .From(DataSource.Database(db))
                .Where(Meta.Expiration.LessThan(Expression.Double(fiveMinutesFromNow)));
            // end::document-expiration[]
        }

        private static void UseBlob()
        {
            var db = _Database;
            using (var newTask = new MutableDocument()) {
                // tag::blob[]
                // Note: Reading the data is implementation dependent, as with prebuilt databases
                var image = File.ReadAllBytes("avatar.jpg");
                var blob = new Blob("image/jpeg", image);
                newTask.SetBlob("avatar", blob);
                db.Save(newTask);
                // end::blob[]

                var taskBlob = newTask.GetBlob("avatar");
                using (var bitmap = SKBitmap.Decode(taskBlob.ContentStream)) {
                    Console.WriteLine($"Bitmap dimensions: {bitmap.Width} x {bitmap.Height} ({bitmap.BytesPerPixel} bytes per pixel)");
                }
            }
        }

        private static void CreateIndex()
        {
            var db = _Database;

            // tag::query-index[]
            // For value types, this is optional but provides performance enhancements
            var index = IndexBuilder.ValueIndex(
                ValueIndexItem.Expression(Expression.Property("type")),
                ValueIndexItem.Expression(Expression.Property("name"))); <i class="conum" data-value="1"></i><b>(1)</b>
            db.CreateIndex("TypeNameIndex", index);
            // end::query-index[]
        }

        private static void SelectMeta()
        {
            Console.WriteLine("Select Meta");
            var db = _Database;

            // tag::query-select-meta[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("type"),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Document ID :: {result.GetString("id")}");
                    Console.WriteLine($"Document Name :: {result.GetString("name")}");
                }
            }
            // end::query-select-meta[]
        }

        private static void SelectAll()
        {
            var db = _Database;

            // tag::query-select-all[]
            using (var query = QueryBuilder.Select(SelectResult.All())
                .From(DataSource.Database(db))) {
                // All user properties will be available here
            }
            // end::query-select-all[]

            // tag::live-query[]
            var query = QueryBuilder
                .Select(SelectResult.All())
                .From(DataSource.Database(db));

            // Adds a query change listener.
            // Changes will be posted on the main queue.
            var token = query.AddChangeListener((sender, args) =&gt; <i class="conum" data-value="2"></i><b>(2)</b>
            {
                var allResult = args.Results.AllResults();
                foreach (var result in allResult) {
                    Console.WriteLine(result.Keys);
                    /* Update UI */
                }
            });

            // Start live query.
            query.Execute(); <i class="conum" data-value="1"></i><b>(1)</b>
            // end::live-query[]

            // tag::stop-live-query[]
            query.RemoveChangeListener(token);
            query.Dispose();
            // end::stop-live-query[]
        }

        private static void SelectWhere()
        {
            Console.WriteLine("Where");
            var db = _Database;

            // tag::query-where[]
            using (var query = QueryBuilder.Select(SelectResult.All())
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("hotel")))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    var dict = result.GetDictionary(db.Name);
                    Console.WriteLine($"Document Name :: {dict?.GetString("name")}");
                }
            }
            // end::query-where[]
        }

        private static void UseCollectionContains()
        {
            Console.WriteLine("Collection Operator CONTAINS");
            var db = _Database;

            // tag::query-collection-operator-contains[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"),
                    SelectResult.Property("public_likes"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("hotel"))
                    .And(ArrayFunction.Contains(Expression.Property("public_likes"),
                        Expression.String("Armani Langworth"))))) {
                foreach (var result in query.Execute()) {
                    var publicLikes = result.GetArray("public_likes");
                    var jsonString = JsonConvert.SerializeObject(publicLikes);
                    Console.WriteLine($"Public Likes :: {jsonString}");
                }
            }
            // end::query-collection-operator-contains[]
        }

        private static void UseCollectionIn()
        {
            Console.WriteLine("Collection Operator IN");
            var db = _Database;

            // tag::query-collection-operator-in[]
            var values = new IExpression[]
                { Expression.Property("first"), Expression.Property("last"), Expression.Property("username") };

            using (var query = QueryBuilder.Select(
                    SelectResult.All())
                .From(DataSource.Database(db))
                .Where(Expression.String("Armani").In(values))) {
                foreach (var result in query.Execute()) {
                    var body = result.GetDictionary(0);
                    var jsonString = JsonConvert.SerializeObject(body);
                    Console.WriteLine($"In results :: {jsonString}");
                }
            }
            // end::query-collection-operator-in[]
        }

        private static void SelectLike()
        {
            Console.WriteLine("Like");
            var db = _Database;

            // tag::query-like-operator[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Function.Lower(Expression.Property("name")).Like(Expression.String("Royal Engineers Museum"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-like-operator[]
        }

        private static void SelectWildcardLike()
        {
            Console.WriteLine("Wildcard Like");
            var db = _Database;

            // tag::query-like-operator-wildcard-match[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Function.Lower(Expression.Property("name")).Like(Expression.String("Eng%e%"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-like-operator-wildcard-match[]
        }

        private static void SelectWildcardCharacterLike()
        {
            Console.WriteLine("Wildchard Characters");
            var db = _Database;

            // tag::query-like-operator-wildcard-character-match[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Expression.Property("name").Like(Expression.String("Royal Eng____rs Museum"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-like-operator-wildcard-character-match[]
        }

        private static void SelectRegex()
        {
            Console.WriteLine("Regex");
            var db = _Database;

            // tag::query-regex-operator[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Expression.Property("name").Regex(Expression.String("\\bEng.*e\\b"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-regex-operator[]
        }

        private static void SelectJoin()
        {
            Console.WriteLine("Join");
            var db = _Database;

            // tag::query-join[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Expression.Property("name").From("airline")),
                    SelectResult.Expression(Expression.Property("callsign").From("airline")),
                    SelectResult.Expression(Expression.Property("destinationairport").From("route")),
                    SelectResult.Expression(Expression.Property("stops").From("route")),
                    SelectResult.Expression(Expression.Property("airline").From("route")))
                .From(DataSource.Database(db).As("airline"))
                .Join(Join.InnerJoin(DataSource.Database(db).As("route"))
                    .On(Meta.ID.From("airline").EqualTo(Expression.Property("airlineid").From("route"))))
                .Where(Expression.Property("type").From("route").EqualTo(Expression.String("route"))
                    .And(Expression.Property("type").From("airline").EqualTo(Expression.String("airline")))
                    .And(Expression.Property("sourceairport").From("route").EqualTo(Expression.String("RIX"))))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-join[]
        }

        private static void GroupBy()
        {
            Console.WriteLine("GroupBy");
            var db = _Database;

            // tag::query-groupby[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Function.Count(Expression.All())),
                    SelectResult.Property("country"),
                    SelectResult.Property("tz"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("airport"))
                    .And(Expression.Property("geo.alt").GreaterThanOrEqualTo(Expression.Int(300))))
                .GroupBy(Expression.Property("country"), Expression.Property("tz"))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine(
                        $"There are {result.GetInt("$1")} airports in the {result.GetString("tz")} timezone located in {result.GetString("country")} and above 300 ft");
                }
            }
            // end::query-groupby[]
        }

        private static void OrderBy()
        {
            Console.WriteLine("OrderBy");
            var db = _Database;

            // tag::query-orderby[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("title"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("hotel")))
                .OrderBy(Ordering.Property("title").Ascending())
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Title :: {result.GetString("title")}");
                }
            }
            // end::query-orderby[]
        }

      // ### EXPLAIN statement
      private static void TestExplainStatement()
      // For Documentation
      {
        var db = _Database;
          // tag::query-explain-all[]
        var query =
          QueryBuilder
            .Select(SelectResult.All())
            .From(DataSource.Database(db))
            .Where(Expression.Property("type").EqualTo(Expression.String("hotel")))
            .GroupBy(Expression.Property("country"))
            .OrderBy(Ordering.Property("title").Ascending()) <i class="conum" data-value="3"></i><b>(3)</b>

          Console.WriteLine(query.Explain()); <i class="conum" data-value="4"></i><b>(4)</b>

          // end::query-explain-all[]
          // tag::query-explain-like[]
var query =
  QueryBuilder
    .Select(SelectResult.All())
    .From(DataSource.Database(db))
    .Where(Expression.Property("type").Like(Expression.String("%hotel%"))
      .And(Function.Lower(Expression.Property("name")).Like(Expression.String("%royal%")))); <i class="conum" data-value="5"></i><b>(5)</b>
  Console.WriteLine(query.Explain());

          // end::query-explain-like[]
          // tag::query-explain-nopfx[]
var query =
  QueryBuilder
    .Select(SelectResult.All())
    .From(DataSource.Database(db))
    .Where(Expression.Property("type").Like(Expression.String("hotel%"))
      .And(Function.Lower(Expression.Property("name")).Like(Expression.String("%royal%")))); <i class="conum" data-value="6"></i><b>(6)</b>

  Console.WriteLine(query.Explain());

          // end::query-explain-nopfx[]
          // tag::query-explain-function[]
var query =
  QueryBuilder
    .Select(SelectResult.All())
    .From(DataSource.Database(db))
    .Where(Function.Lower(Expression.Property("type")).EqualTo(Expression.String("hotel"))); <i class="conum" data-value="7"></i><b>(7)</b>

  Console.WriteLine(query.Explain());

          // end::query-explain-function[]
          // tag::query-explain-nofunction[]
        var query =
          QueryBuilder
            .Select(SelectResult.All())
            .From(DataSource.Database(db))
            .Where(Expression.Property("type")).EqualTo(Expression.String("hotel")); <i class="conum" data-value="8"></i><b>(8)</b>

          Console.WriteLine(query.Explain());

          // end::query-explain-nofunction[]
      }

      // end query-explain





        private static void CreateFullTextIndex()
        {
            var db = _Database;
            if (_NeedsExtraDocs) {
                var tasks = new[] { "buy groceries", "play chess", "book travels", "buy museum tickets" };
                foreach (var task in tasks) {
                    using (var doc = new MutableDocument()) {
                        doc.SetString("type", "task");
                        doc.SetString("name", task);
                        db.Save(doc);
                    }
                }
            }

            // tag::fts-index[]
            var index = IndexBuilder.FullTextIndex(FullTextIndexItem.Property("name")).IgnoreAccents(false);
            db.CreateIndex("nameFTSIndex", index);
            // end::fts-index[]
        }

        private static void FullTextSearch()
        {
            Console.WriteLine("Full text search");
            var db = _Database;

            // tag::fts-query[]
            var whereClause = FullTextExpression.Index("nameFTSIndex").Match("'buy'");
            using (var query = QueryBuilder.Select(SelectResult.Expression(Meta.ID))
                .From(DataSource.Database(db))
                .Where(whereClause)) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Document id {result.GetString(0)}");
                }
            }
            // end::fts-query[]
        }
        private static void StartReplication()
        {
            var db = _Database;

            /*
             * This requires Sync Gateway running with the following config, or equivalent:
             *
             * {
             *     "log":["*"],
             *     "databases": {
             *         "db": {
             *             "server":"walrus:",
             *             "users": {
             *                 "GUEST": {"disabled": false, "admin_channels": ["*"] }
             *             }
             *         }
             *     }
             * }
             */

            // tag::replication[]
            // Note: Android emulator needs to use 10.0.2.2 for localhost (10.0.3.2 for GenyMotion)
            var url = new Uri("ws://localhost:4984/db");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(db, target)
            {
                ReplicatorType = ReplicatorType.Pull
            };

            var replicator = new Replicator(config);
            replicator.Start();
            // end::replication[]

            _Replicator = replicator;
        }

        private static void VerboseReplicatorLogging()
        {
            // tag::replication-logging[]
            // deprecated
            Database.SetLogLevel(LogDomain.Replicator, LogLevel.Verbose);
            Database.SetLogLevel(LogDomain.Network, LogLevel.Verbose);
            // end::replication-logging[]
        }

        private static void ConsoleLogging()
        {
            // tag::console-logging[]
            Database.Log.Console.Domains = LogDomain.All; <i class="conum" data-value="9"></i><b>(9)</b>
            Database.Log.Console.LogLevel = LogLevel.Verbose; <i class="conum" data-value="10"></i><b>(10)</b>

            // end::console-logging[]

            // tag::console-logging-db[]
            Database.Log.Console.Domains = LogDomain.Database;

            // end::console-logging-db[]
        }

        private static void FileLogging()
        {
            // tag::file-logging[]
            var tempFolder = Path.Combine(Service.GetInstance&lt;IDefaultDirectoryResolver&gt;().DefaultDirectory(), "cbllog");
            var config = new LogFileConfiguration(tempFolder) <i class="conum" data-value="11"></i><b>(11)</b>
            {
                MaxRotateCount = 5, <i class="conum" data-value="12"></i><b>(12)</b>
                MaxSize = 10240, <i class="conum" data-value="13"></i><b>(13)</b>
                UsePlainText = false  <i class="conum" data-value="14"></i><b>(14)</b>
            };
            Database.Log.File.Config = config; // Apply configuration
            Database.Log.File.Level = LogLevel.Info; <i class="conum" data-value="15"></i><b>(15)</b>

            // end::file-logging[]
        }

        private static void EnableCustomLogging()
        {
            // tag::set-custom-logging[]
            Database.Log.Custom = new LogTestLogger(); <i class="conum" data-value="16"></i><b>(16)</b>
            or
            Database.Log.Custom = new LogTestLogger { Level = LogLevel.Warning };

            // end::set-custom-logging[]
        }

        private static void WriteConsoleLog()
        {
            // tag::write-console-logmsg[]
            Database.Log.Console.Log(LogLevel.Warning, LogDomain.Replicator, "Any old log message");
            // end::write-console-logmsg[]
        }
        private static void WriteCustomLog()
        {
            // tag::write-custom-logmsg[]
            Database.Log.Custom?.Log(LogLevel.Warning, LogDomain.Replicator, "Any old log message");
            // end::write-custom-logmsg[]
        }


        private static void WriteFileLog()
        {
            // tag::write-file-logmsg[]
            Database.Log.File.Log(LogLevel.Warning, LogDomain.Replicator, "Any old log message");
            // end::write-file-logmsg[]
        }

        private static void EnableBasicAuth()
        {
            var database = _Database;

            // tag::basic-authentication[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.Authenticator = new BasicAuthenticator("john", "pass");

            var replicator = new Replicator(config);
            replicator.Start();
            // end::basic-authentication[]
        }

        private static void EnableSessionAuth()
        {
            var database = _Database;

            // tag::session-authentication[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.Authenticator = new SessionAuthenticator("904ac010862f37c8dd99015a33ab5a3565fd8447");

            var replicator = new Replicator(config);
            replicator.Start();
            // end::session-authentication[]
        }

        private static void SetupReplicatorListener()
        {
            var replicator = _Replicator;

            // tag::replication-status[]
            replicator.AddChangeListener((sender, args) =&gt;
            {
                if (args.Status.Activity == ReplicatorActivityLevel.Stopped) {
                    Console.WriteLine("Replication stopped");
                }
            });
            // end::replication-status[]
        }




    //  BEGIN PendingDocuments IB -- 11/Feb/21 --
    private static void ReplicatorPendingDocuments()
    {
        // tag::replication-pendingdocuments[]
        var url = new Uri("ws://localhost:4984/mydatabase");
        var target = new URLEndpoint(url);
        var database = new Database("myDB");
        var config = new ReplicatorConfiguration(database, target);
        config.ReplicatorType  = ReplicatorType.Push;

        // tag::replication-push-pendingdocumentids[]
        var replicator = new Replicator(config);

        var mydocids =
          new HashSet &lt;string&gt; (replicator.GetPendingDocumentIDs()); <i class="conum" data-value="17"></i><b>(17)</b>

        // end::replication-push-pendingdocumentids[]

        if (mydocids.Count &gt; 0)
        {
            Console.WriteLine($"There are {mydocids.Count} documents pending");
            replicator.AddChangeListener((sender, change) =&gt;
            {
                Console.WriteLine($"Replicator activity level is " +
                                  change.Status.Activity.ToString());
                // iterate and report-on previously
                // retrieved pending docids 'list'
                foreach (var thisId in mydocids)
                    // tag::replication-push-isdocumentpending[]
                    if (!replicator.IsDocumentPending(thisId)) <i class="conum" data-value="18"></i><b>(18)</b>
                    {
                        Console.WriteLine($"Doc ID {thisId} now pushed");
                    };
                // end::replication-push-isdocumentpending[]
            });

            replicator.Start();
        }
    // end::replication-pendingdocuments[]
    }


//  END PendingDocuments IB -- 11/Feb/21 --



		private static void ReplicatorDocumentEvent()
        {
            var replicator = _Replicator;

            // tag::add-document-replication-listener[]
            var token = replicator.AddDocumentReplicationListener((sender, args) =&gt;
            {
                var direction = args.IsPush ? "Push" : "Pull";
                Console.WriteLine($"Replication type :: {direction}");
                foreach (var document in args.Documents) {
                    if (document.Error == null) {
                        Console.WriteLine($"Doc ID :: {document.Id}");
                        if (document.Flags.HasFlag(DocumentFlags.Deleted)) {
                            Console.WriteLine("Successfully replicated a deleted document");
                        }
                    } else {
                        // There was an error
                    }
                }
            });

            replicator.Start();
            // end::add-document-replication-listener[]

            // tag::remove-document-replication-listener[]
            replicator.RemoveChangeListener(token);
            // end::remove-document-replication-listener[]
        }

        private static void SetupReplicatorErrorListener()
        {
            // This can be done in the SetupReplicatorListener method
            // But it is separate so that we can have two documentation entries

            var replicator = _Replicator;

            // tag::replication-error-handling[]
            replicator.AddChangeListener((sender, args) =&gt;
            {
                if (args.Status.Error != null) {
                    Console.WriteLine($"Error :: {args.Status.Error}");
                }
            });
            // end::replication-error-handling[]
        }

        private static void DatabaseReplica()
        {
            var db = _Database;
            using (var database2 = new Database("backup")) {
                // EE feature: This code will not compile on the community edition
                // tag::database-replica[]
                var targetDatabase = new DatabaseEndpoint(database2);
                var config = new ReplicatorConfiguration(db, targetDatabase)
                {
                    ReplicatorType = ReplicatorType.Push
                };

                var replicator = new Replicator(config);
                replicator.Start();
                // end::database-replica[]

                _Replicator?.Stop();
                _Replicator = replicator;
            }
        }

        private static void PinCertificate()
        {
            // Note: No certificate is included here, so this code is for show only
            var url = new Uri("wss://localhost:4984/db");
            var target = new URLEndpoint(url);
            var db = _Database;

            // tag::certificate-pinning[]
            // Note: `GetCertificate` is a fake method. This would be the platform-specific method
            // to find and load the certificate as an instance of `X509Certificate2`.
            // For .NET Core / .NET Framework this can be loaded from the filesystem path.
            // For UWP, from the assets directory.
            // For iOS, from the main bundle.
            // For Android, from the assets directory.
            var certificate = GetCertificate("cert.cer");
            var config = new ReplicatorConfiguration(db, target)
            {
                PinnedServerCertificate = certificate
            };
            // end::certificate-pinning[]
        }

        private static void ReplicationCustomHeaders()
        {
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            // tag::replication-custom-header[]
            var config = new ReplicatorConfiguration(database, target)
            {
                Headers = new Dictionary&lt;string, string&gt;
                {
                    ["CustomHeaderName"] = "Value"
                }
            };
            // end::replication-custom-header[]
        }

        private static void PushWithFilter(Database database)
        {
            // tag::replication-push-filter[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            var config = new ReplicatorConfiguration(database, target);
            config.PushFilter = (document, flags) =&gt; <i class="conum" data-value="1"></i><b>(1)</b>
            {
                if (flags.HasFlag(DocumentFlags.Deleted)) {
                    return false;
                }

                return true;
            };

            // Dispose() later
            var replicator = new Replicator(config);
            replicator.Start();
            // end::replication-push-filter[]
        }

        private static void PullWithFilter(Database database)
        {
            // tag::replication-pull-filter[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            var config = new ReplicatorConfiguration(database, target);
            config.PullFilter = (document, flags) =&gt; <i class="conum" data-value="1"></i><b>(1)</b>
            {
                if (document.GetString("type") == "draft") {
                    return false;
                }

                return true;
            };

            // Dispose() later
            var replicator = new Replicator(config);
            replicator.Start();
            // end::replication-pull-filter[]
        }

        public void TestCustomRetryConfig()
        {
        // tag::replication-retry-config[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            var config = new ReplicatorConfiguration(database, target);

        //  other config as required . . .

        // tag::replication-set-heartbeat[]
            config.Heartbeat = TimeSpan.FromSeconds(120); //  <i class="conum" data-value="19"></i><b>(19)</b>
        // end::replication-set-heartbeat[]
        // tag::replication-set-maxretries[]
            config.MaxRetries = 20; //  <i class="conum" data-value="20"></i><b>(20)</b>
        // end::replication-set-maxretries[]
        // tag::replication-set-maxretrywaittime[]
            config.MaxRetryWaitTime = TimeSpan.FromSeconds(600); //  <i class="conum" data-value="21"></i><b>(21)</b>
        // end::replication-set-maxretrywaittime[]

        //  other config as required . . .

            var repl = new Replicator(config);

        // end::replication-retry-config[]
        }


        private static void UsePredictiveModel()
        {
            using (var db = new Database("mydb")) {
                // tag::register-model[]
                var model = new ImageClassifierModel();
                Database.Prediction.RegisterModel("ImageClassifier", model);
                // end::register-model[]

                // tag::predictive-query-value-index[]
                var index = IndexBuilder.ValueIndex(ValueIndexItem.Property("label"));
                db.CreateIndex("value-index-image-classifier", index);
                // end::predictive-query-value-index[]

                // tag::unregister-model[]
                Database.Prediction.UnregisterModel("ImageClassifier");
                // end::unregister-model[]
            }
        }

        private static void UsePredictiveIndex()
        {
            using (var db = new Database("mydb")) {
                // tag::predictive-query-predictive-index[]
                var input = Expression.Dictionary(new Dictionary&lt;string, object&gt;
                {
                    ["photo"] = Expression.Property("photo")
                });

                var index = IndexBuilder.PredictiveIndex("ImageClassifier", input);
                db.CreateIndex("predictive-index-image-classifier", index);
                // end::predictive-query-predictive-index[]
            }
        }

        private static void DoPredictiveQuery()
        {
            using (var db = new Database("mydb")) {
                // tag::predictive-query[]
                var input = Expression.Dictionary(new Dictionary&lt;string, object&gt;
                {
                    ["photo"] = Expression.Property("photo")
                });
                var prediction = PredictiveModel.predict("ImageClassifier", input); <i class="conum" data-value="1"></i><b>(1)</b>

                using (var q = QueryBuilder.Select(SelectResult.All())
                    .From(DataSource.Database(db))
                    .Where(prediction.Property("label").EqualTo(Expression.String("car"))
                        .And(prediction.Property("probability").GreaterThanOrEqualTo(Expression.Double(0.8))))) {
                    var result = q.Execute();
                    Console.WriteLine($"Number of rows: {result.Count()}");
                }
                // end::predictive-query[]
            }
        }

        static void Main(string[] args)
        {
            // This only needs to be done once for whatever platform the executable is running
            // (UWP, iOS, Android, or desktop)
            Couchbase.Lite.Support.NetDesktop.Activate();

            CreateNewDatabase();
            CreateDocument();
            UpdateDocument();
            UseTypedAccessors();
            DoBatchOperation();
            UseBlob();
            SelectMeta();

            LoadPrebuilt();
            CreateIndex();
            SelectWhere();
            UseCollectionContains();
            SelectLike();
            SelectWildcardLike();
            SelectWildcardCharacterLike();
            SelectRegex();
            SelectJoin();
            GroupBy();
            OrderBy();

            CreateFullTextIndex();
            FullTextSearch();
            StartReplication();
            SetupReplicatorListener();

            _Replicator.Stop();
            while (_Replicator.Status.Activity != ReplicatorActivityLevel.Stopped) {
                // Database cannot close until replicators are stopped
                Console.WriteLine($"Waiting for replicator to stop (currently {_Replicator.Status.Activity})...");
                Thread.Sleep(200);
            }

            _Database.Close();
        }

        #endregion
    }

    /* ----------------------------------------------------------- */
    /* ---------------------  ACTIVE SIDE  ----------------------- */
    /* ---------------  stubs for documentation  ----------------- */
    /* ----------------------------------------------------------- */

    class ActivePeer : IMessageEndpointDelegate
    {
        ActivePeer()
        {
            var id = "";

            // tag::message-endpoint[]
            var database = new Database("dbname");

            // The delegate must implement the `IMessageEndpointDelegate` protocol.
            var messageEndpointTarget = new MessageEndpoint(uid: "UID:123", target: "",
                protocolType: ProtocolType.MessageStream, delegateObject: this);
            // end::message-endpoint[]

            // tag::message-endpoint-replicator[]
            var config = new ReplicatorConfiguration(database, messageEndpointTarget);

            // Create the replicator object
            var replicator = new Replicator(config);
            // Start the replicator
            replicator.Start();
            // end::message-endpoint-replicator[]
        }

        // tag::create-connection[]
        /* implementation of MessageEndpointDelegate */
        public IMessageEndpointConnection CreateConnection(MessageEndpoint endpoint)
        {
            var connection = new ActivePeerConnection(); /* implements MessageEndpointConnection */
            return connection;
        }
        // end::create-connection[]
    }

    class ActivePeerConnection : IMessageEndpointConnection
    {
        private IReplicatorConnection _replicatorConnection;

        public void Disconnect()
        {
            // tag::active-replicator-close[]
            _replicatorConnection?.Close(null);
            // end::active-replicator-close[]
        }

        public void Receive(byte[] data)
        {
            // tag::active-peer-receive[]
            var message = Message.FromBytes(data);
            _replicatorConnection?.Receive(message);
            // end::active-peer-receive[]
        }

        // tag::active-peer-close[]
        /* implementation of MessageEndpointConnection */
        public async Task Close(Exception error)
        {
            // await socket.Close, etc (or do nothing if already closed)
            // throw MessagingException if something goes wrong (though
            // since it is "close" nothing special will happen)
        }
        // end::active-peer-close[]

        // tag::active-peer-open[]
        /* implementation of MessageEndpointConnection */
        public async Task Open(IReplicatorConnection connection)
        {
            _replicatorConnection = connection;
            // await socket.Open(), etc
            // throw MessagingException if something goes wrong
        }
        // end::active-peer-open[]

        // tag::active-peer-send[]
        /* implementation of MessageEndpointConnection */
        public async Task Send(Message message)
        {
            var data = message.ToByteArray();
            // await Socket.Send(), etc
            // throw MessagingException if something goes wrong
        }
        // end::active-peer-send[]
    }

    /* ----------------------------------------------------------- */
    /* ---------------------  PASSIVE SIDE  ---------------------- */
    /* ---------------  stubs for documentation  ----------------- */
    /* ----------------------------------------------------------- */
    class PassivePeerConnection : IMessageEndpointConnection
    {
        private MessageEndpointListener _messageEndpointListener;
        private IReplicatorConnection _replicatorConnection;

        public void StartListener()
        {
            // tag::listener[]
            var database = new Database("mydb");
            var config = new MessageEndpointListenerConfiguration(database, ProtocolType.MessageStream);
            _messageEndpointListener = new MessageEndpointListener(config);
            // end::listener[]
        }

        public void StopListener()
        {
            // tag::passive-stop-listener[]
            _messageEndpointListener?.CloseAll();
            // end::passive-stop-listener[]
        }

        public void AcceptConnection()
        {
            // tag::advertizer-accept[]
            var connection = new PassivePeerConnection(); /* implements MessageEndpointConnection */
            _messageEndpointListener?.Accept(connection);
            // end::advertizer-accept[]
        }

        public void Disconnect()
        {
            // tag::passive-replicator-close[]
            _replicatorConnection?.Close(null);
            // end::passive-replicator-close[]
        }

        public void Receive(byte[] data)
        {
            // tag::passive-peer-receive[]
            var message = Message.FromBytes(data);
            _replicatorConnection?.Receive(message);
            // end::passive-peer-receive[]
        }

        // tag::passive-peer-close[]
        /* implementation of MessageEndpointConnection */
        public async Task Close(Exception error)
        {
            // await socket.Close, etc (or do nothing if already closed)
            // throw MessagingException if something goes wrong (though
            // since it is "close" nothing special will happen)
        }
        // end::passive-peer-close[]

        // tag::passive-peer-open[]
        /* implementation of MessageEndpointConnection */
        public Task Open(IReplicatorConnection connection)
        {
            _replicatorConnection = connection;
            // socket should already be open on the passive side
            return Task.FromResult(true);
        }
        // end::passive-peer-open[]

        // tag::passive-peer-send[]
        /* implementation of MessageEndpointConnection */
        public async Task Send(Message message)
        {
            var data = message.ToByteArray();
            // await Socket.Send(), etc
            // throw MessagingException if something goes wrong
        }
        // end::passive-peer-send[]
    }

    // tag::predictive-model[]
    // `TensorFlowModel` is a fake implementation
    // this would be the implementation of the ml model you have chosen
    class TensorFlowModel
    {
        public static IDictionary&lt;string, object&gt; PredictImage(byte[] data)
        {
            // Do calculations, etc
            return null;
        }
    }

    class ImageClassifierModel : IPredictiveModel
    {
        public DictionaryObject Predict(DictionaryObject input)
        {
            var blob = input.GetBlob("photo");
            if (blob == null) {
                return null;
            }

            var imageData = blob.Content;
            // `TensorFlowModel` is a fake implementation
            // this would be the implementation of the ml model you have chosen
            var modelOutput = TensorFlowModel.PredictImage(imageData);
            return new MutableDictionaryObject(modelOutput); <i class="conum" data-value="1"></i><b>(1)</b>
        }
    }
    // end::predictive-model[]

    // tag::custom-logging[]
    private class LogTestLogger : ILogger
    {
        public LogLevel Level { get; set; }

        public void Reset()
        {
            _lines.Clear();
        }

        public void Log(LogLevel level, LogDomain domain, string message)
        {
            // handle the message, for example piping it to
            // a third party framework
        }
    }
    // end::custom-logging[]

    // tag::local-win-conflict-resolver[]
    class LocalWinConflictResolver : IConflictResolver
    {
        Document Resolve(Conflict conflict)
        {
            return conflict.LocalDocument;
        }
    }
    // end::local-win-conflict-resolver[]

    // tag::remote-win-conflict-resolver[]
    class RemoteWinConflictResolver : IConflictResolver
    {
        public Document Resolve(Conflict conflict)
        {
            return conflict.RemoteDocument;
        }
    }
    // end::remote-win-conflict-resolver[]

    // tag::merge-conflict-resolver[]
    class MergeConflictResolver : IConflictResolver
    {
        public Document Resolve(Conflict conflict)
        {
            var localDict = conflict.LocalDocument.ToDictionary();
            var remoteDict = conflict.RemoteDocument.ToDictionary();
            var result = localDict.Concat(remoteDict)
               .GroupBy(kv =&gt; kv.Key)
               .ToDictionary(g =&gt; g.Key, g =&gt; g.First().Value);
            return new MutableDocument(conflict.DocumentID, result);
        }
    }
    // end::merge-conflict-resolver[]


// N1QL QUERY


  public  List&lt;Result&gt; testN1QLQueryString (Database argDB)
  {
      // For Documentation
      DatabaseConfiguration dbCfg = new DatabaseConfiguration();
      dbCfg.Directory =
          Path.Combine(Service.GetInstance&lt;IDefaultDirectoryResolver&gt;().DefaultDirectory(), username);
      // tag::query-syntax-n1ql[]
      Database thisDb = new Database(dbName, dbCfg);

      var thisQuery =
          thisDb.CreateQuery(
              "SELECT META().id AS thisId FROM $thisDb.name " +
              "WHERE type = $type"); <i class="conum" data-value="22"></i><b>(22)</b>

      thisQuery.Parameters.SetString("type", "hotel"); <i class="conum" data-value="23"></i><b>(23)</b>

      var results = thisQuery.Execute().AllResults();

      return results;
      // end::query-syntax-n1ql[]
  }

    // tag::query-syntax-n1ql-params[]
    tbd
    // end::query-syntax-n1ql-params[]

    // tag::query-access-n1ql[]
    tbd
    // end::query-access-n1ql[]


// QUERY RESULT SET HANDLING EXAMPLES

    public static void testQuerySyntaxAll()
    {
        // For Documentation
        var dbName = "travel-sample";

        string thisDocsId;
        string thisDocsName;
        string thisDocsType;
        string thisDocsCity;
        Dictionary&lt;string,object&gt; hotel = new Dictionary&lt;string,object&gt;();

        // tag::query-syntax-all[]
        var this_Db = new Database("hotels") ;

        var query = QueryBuilder
              .Select(SelectResult.All())
              .From(DataSource.Database(this_Db));

        // end::query-syntax-all[]

        // tag::query-access-all[]
        var results = query.Execute().AllResults();

        if (results?.Count &gt; 0)
        {
            List&lt;Dictionary&lt;string,object&gt;&gt; hotels = new List&lt;Dictionary&lt;string,object&gt;&gt;();
            foreach (var result in results)
            {
                // get the result into our dictionary object
                var thisDocsProps = result.GetDictionary(dbName); <i class="conum" data-value="24"></i><b>(24)</b>

                if (thisDocsProps != null)
                {
                    thisDocsId = thisDocsProps.GetString("id"); <i class="conum" data-value="25"></i><b>(25)</b>
                    thisDocsName = thisDocsProps.GetString("name");
                    thisDocsCity = thisDocsProps.GetString("city");
                    thisDocsType = thisDocsProps.GetString("type");
                    hotel = thisDocsProps.ToDictionary();
                    hotels.Add(hotel);
                }

            }
        }
        // end::query-access-all[]

    // tag::query-access-json[]

    foreach (var result in query.Execute().AsEnumerable()) {

        // get the result into a JSON String
                var thisDocsJSONString = result.ToJSON();<i class="conum" data-value="26"></i><b>(26)</b>

        // Get a native dictionary object using the JSON string
        var dictFromJSONstring =
              JsonConvert.
                DeserializeObject&lt;Dictionary&lt;string, object&gt;&gt;
                  (thisDocsJSONString); <i class="conum" data-value="27"></i><b>(27)</b>

        // use the created dictionary
        if (dictFromJSONstring != null)
        {
            thisDocsId = dictFromJSONstring["id"].ToString();
            thisDocsName = dictFromJSONstring["name"].ToString();
            thisDocsCity = dictFromJSONstring["city"].ToString();
            thisDocsType = dictFromJSONstring["type"].ToString();
        }

        //Get a custom object using the JSON string
        Hotel this_hotel =
            JsonConvert.DeserializeObject&lt;Hotel&gt;(thisDocsJSONString); <i class="conum" data-value="28"></i><b>(28)</b>

        // Store this hotel object in a list of hotels
        hotels.Add(
            this_hotel.Id.ToString(),
                this_hotel);

    } // end foreach result
    // end::query-access-json[]
  }


    private static void testQuerySyntaxProps()
    {
        // For Documentation
        var dbName = "travel-sample";
        // var this_Db = new Database(dbName);

        string thisDocsName;
        string thisDocsType;
        string thisDocsCity;
        // tag::query-syntax-props[]
        var this_Db = new Database("hotels") ;

        Dictionary&lt;string, object&gt; hotel = new Dictionary&lt;string, object&gt;();

        List&lt;Dictionary&lt;string, object&gt;&gt; hotels = new List&lt;Dictionary&lt;string, object&gt;&gt;();

        var query = QueryBuilder.Select(
                SelectResult.Property("type"),
                SelectResult.Property("name"),
                SelectResult.Property("city")).From(DataSource.Database(this_Db));
        // end::query-syntax-props[]

        // tag::query-access-props[]
        var results = query.Execute().AllResults();
        foreach (var result in results)
        {

            // get the returned array of k-v pairs into a dictionary
            hotel = result.ToDictionary();

            // add hotel dictionary to list of hotel dictionaries
            hotels.Add(hotel);

            // use the properties of the returned array of k-v pairs directly
            thisDocsType = result.GetString("type");
            thisDocsName = result.GetString("name");
            thisDocsCity = result.GetString("city");

        }

    // end::query-access-props[]
    } // test-query-access-props



    private static void testQuerySyntaxCount()
    {
        // For Documentation
        var dbName = "travel-sample";
        // var this_Db = new Database(dbName);

        Dictionary&lt;string, object&gt; hotel = new Dictionary&lt;string, object&gt;();
        List&lt;Dictionary&lt;string, object&gt;&gt; hotels = new List&lt;Dictionary&lt;string, object&gt;&gt;();

        // tag::query-syntax-count-only[]
        var this_Db = new Database("hotels") ;

        var query =
          QueryBuilder
            .Select(SelectResult.Expression(Function.Count(Expression.All())).As("mycount")) <i class="conum" data-value="29"></i><b>(29)</b>
            .From(DataSource.Database(this_Db));

        // end::query-syntax-count-only[]


        // tag::query-access-count-only[]

        var results = query.Execute().AllResults();

        foreach (var result in results)
        {

            var numberOfDocs = result.GetInt("mycount"); <i class="conum" data-value="30"></i><b>(30)</b>

        }

        // end::query-access-count-only[]
    }




    private static void ibQueryForID()
    {

        // For Documentation
        var dbName = "travel-sample";
        // var this_Db = new Database(dbName);

        Dictionary&lt;string, object&gt; hotel = new Dictionary&lt;string, object&gt;();
        List&lt;Dictionary&lt;string, object&gt;&gt; hotels = new List&lt;Dictionary&lt;string, object&gt;&gt;();


        // tag::query-syntax-id[]
        var this_Db = new Database("hotels") ;

        var query = QueryBuilder
                .Select(SelectResult.Expression(Meta.ID).As("this_ID"))
                .From(DataSource.Database(this_Db));

        // end::query-syntax-id[]


        // tag::query-access-id[]
        var results = query.Execute().AllResults();
        foreach (var result in results)
        {

            var thisDocsID = result.GetString("this_ID"); <i class="conum" data-value="31"></i><b>(31)</b>
            var doc = this_Db.GetDocument(thisDocsID);
        }

        // end::query-access-id[]
    }


// tag::query-syntax-pagination-all[]
    private static void testQueryPagination()
    {
      // For Documentation
      var dbName = "travel-sample";
      // var this_Db = new Database(dbName);

    // tag::query-syntax-pagination[]
      var this_Db = new Database("hotels") ;

      var thisLimit = 20;
      var thisOffset = 0;

      // get a count of the number of docs matching the query
      var countQuery =
          QueryBuilder
              .Select(SelectResult.Expression(Function.Count(Expression.All())).As("mycount"))
              .From(DataSource.Database(this_Db));
      var numberOfDocs =
          countQuery.Execute().AllResults().ElementAt(0).GetInt("mycount");

      if (numberOfDocs &lt; thisLimit) {
          thisLimit = numberOfDocs;
      }

      while (thisOffset &lt; numberOfDocs)
      {
          var listQuery =
              QueryBuilder
                  .Select(SelectResult.All())
                  .From(DataSource.Database(this_Db))
                  .Limit(Expression.Int(thisLimit), Expression.Int(thisOffset)); <i class="conum" data-value="32"></i><b>(32)</b>

          foreach (var result in listQuery.Execute().AllResults())
          {
              // Display and or process query results batch

          }

          thisOffset = thisOffset + thisLimit;

      } // end while

// end::query-syntax-pagination[]
// end::query-syntax-pagination-all[]
    }

    // JSONAPIMETHODS



        public void JsonApiDocument()
        {

            // tag::tojson-document[]
            Database this_DB = new Database("travel-sample");
            Database newDb = new Database("ournewdb");

            // Get a document
            var thisDoc = this_Db.GetDocument("hotel_10025");

            // Get document data as JSON String
            var thisDocAsJsonString = thisDoc?.ToJSON(); <i class="conum" data-value="33"></i><b>(33)</b>

            // Get Json Object from the Json String
            JObject myJsonObj = JObject.Parse(thisDocAsJsonString);

            // Get Native Object (anhotel) from JSON String
            List&lt;Hotel&gt; thehotels = new List&lt;Hotel&gt;();

            Hotel anhotel = new Hotel();
            anhotel = JsonConvert.DeserializeObject&lt;Hotel&gt;(thisDocAsJsonString);
            thehotels.Add(anhotel);

            // Update the retrieved native object
            anhotel.Name = "A Copy of " + anhotel.Name;
            anhotel.Id = "2001";

            // Convert the updated object back to a JSON string
            var newJsonString = JsonConvert.SerializeObject(anhotel);

            // Update new document with JSOn String
            MutableDocument newhotel =
                new MutableDocument(anhotel.Id, newJsonString); <i class="conum" data-value="34"></i><b>(34)</b>

            foreach (string key in newhotel.ToDictionary().Keys)
            {
                System.Console.WriteLine("Data -- {0} = {1}",
                    key, newhotel.GetValue(key));
            }

            newDb.Save(newhotel);

            var thatDoc = newDb.GetDocument("2001").ToJSON(); <i class="conum" data-value="35"></i><b>(35)</b>
            System.Console.Write(thatDoc);

            // end::tojson-document[]


        //    // tag::tojson-document-output[]
        //    JSON String = { "description":"Very good and central","id":"1000","country":"France","name":"Hotel Ted","type":"hotel","city":"Paris"}
        //             type = hotel
        //             id = 1000
        //             country = France
        //             city = Paris
        //             description = Very good and central
        //             name = Hotel Ted
        //        // end::tojson-document-output[]
        //         */

        } // End JSONAPIDocument


    public void JsonApiArray()
        {
            // Init for docs
            //var this_Db = DataStore.getDbHandle();
            var ourdbname = "ournewdb";

            if (Database.Exists(ourdbname, "/"))
            {
                Database.Delete(ourdbname, "/");
            }

        // tag::tojson-array[]

            Database dbNew = new Database(ourdbname);

            // JSON String -- an Array (3 elements. including embedded arrays)
            var thisJSONstring = "[{'id':'1000','type':'hotel','name':'Hotel Ted','city':'Paris','country':'France','description':'Undefined description for Hotel Ted'},{'id':'1001','type':'hotel','name':'Hotel Fred','city':'London','country':'England','description':'Undefined description for Hotel Fred'},                        {'id':'1002','type':'hotel','name':'Hotel Ned','city':'Balmain','country':'Australia','description':'Undefined description for Hotel Ned','features':['Cable TV','Toaster','Microwave']}]".Replace("'", "\"");

            // Get JSON Array from JSON String
            JArray myJsonObj = JArray.Parse(thisJSONstring);

            // Create mutable array using JSON String Array
            var myArray = new MutableArrayObject();
            myArray.SetJSON(thisJSONstring);  <i class="conum" data-value="36"></i><b>(36)</b>


            // Create a new documenty for each array element
            for (int i = 0; i &lt; myArray.Count; i++)
            {
                var dict = myArray.GetDictionary(i);
                var docid = myArray[i].Dictionary.GetString("id");
                var newdoc = new MutableDocument(docid, dict.ToDictionary()); <i class="conum" data-value="37"></i><b>(37)</b>
                dbNew.Save(newdoc);
            }

            // Get one of the created docs and iterate through one of the embedded arrays
            var extendedDoc = dbNew.GetDocument("1002");
            var features = extendedDoc.GetArray("features");
            <i class="conum" data-value="38"></i><b>(38)</b>
            foreach (string feature in features) {
                System.Console.Write(feature);
                //process array item as required
            }
            var featuresJSON = extendedDoc.GetArray("features").ToJSON(); <i class="conum" data-value="39"></i><b>(39)</b>

            // end::tojson-array[]
        }


        public void JsonApiDictionary()
        {

            var ourdbname = "ournewdb";

            if (Database.Exists(ourdbname, "/"))
            {
                Database.Delete(ourdbname, "/");
            }
            Database dbNew = new Database(ourdbname);

            // tag::tojson-dictionary[]

            // Get dictionary from JSONstring
            var aJSONstring = "{'id':'1002','type':'hotel','name':'Hotel Ned','city':'Balmain','country':'Australia','description':'Undefined description for Hotel Ned','features':['Cable TV','Toaster','Microwave']}".Replace("'", "\"");
            var myDict = new MutableDictionaryObject(json: aJSONstring); <i class="conum" data-value="40"></i><b>(40)</b>

            // use dictionary to get name value
            var name = myDict.GetString("name");


            // Iterate through keys
            foreach (string key in myDict.Keys)
            {
                System.Console.WriteLine("Data -- {0} = {1}", key, myDict.GetValue(key).ToString());

            }
            // end::tojson-dictionary[]

            /*
            // tag::tojson-dictionary-output[]

                mono-stdout: Data -- id = 1002
                mono-stdout: Data -- type = hotel
                mono-stdout: Data -- name = Hotel Ned
                mono-stdout: Data -- city = Balmain
                mono-stdout: Data -- country = Australia
                mono-stdout: Data -- description = Undefined description for Hotel Ned
                mono-stdout: Data -- features = Couchbase.Lite.MutableArrayObject

            // end::tojson-dictionary-output[]
            */
        } /* end of func */


         public void JsonApiBlob()
        {
            // Init
            var ourpath = DataStore.getUserFolder();
            var ourdbname = "ournewdb";
            var userName = "ian";
            //ourpath = Path.Combine(ourpath,userName);

            if (Database.Exists(ourdbname, ourpath))
            {
                Database.Delete(ourdbname, ourpath);
            }
            var dbCfg = new DatabaseConfiguration();
            dbCfg.Directory=ourpath;
            Database dbNew = new Database(ourdbname,dbCfg);

            // tag::tojson-blob[]

            // Initialize base document for blob from a JSON string
            var docId = "1002";
            var aJSONstring = "{'ref':'hotel_1002','type':'hotel','name':'Hotel Ned'," +
                "'city':'Balmain','country':'Australia'," +
                "'description':'Undefined description for Hotel Ned'," +
                "'features':['Cable TV','Toaster','Microwave']}".Replace("'", "\"");
            var myDoc = new MutableDocument(docId, aJSONstring); <i class="conum" data-value="41"></i><b>(41)</b>


            // Get the content (an image), create blob and add to doc)
            var defaultDirectory =
                Path.Combine(Service.GetInstance&lt;IDefaultDirectoryResolver&gt;()
                            .DefaultDirectory(),
                                userName);
            var myImagePath = Path.Combine(defaultDirectory, "avatarimage.jpg");
            var myImageUri = new Uri(myImagePath.ToString());
            var myBlob = new Blob("image/jpg", myImageUri); <i class="conum" data-value="42"></i><b>(42)</b>
            myDoc.SetBlob("avatar", myBlob); <i class="conum" data-value="43"></i><b>(43)</b>


            // This example generates a 'blob not saved' exception
            try { Console.WriteLine("myBlob (unsaved) as JSON = {0}", myBlob.ToJSON());}
                catch (Exception e)
                    {Console.WriteLine("Exception = {0}", e.Message);}

            dbNew.Save(myDoc);

            // Alternatively -- depending on use case
            dbNew.SaveBlob(new Blob("image/jpg", myImageUri)); <i class="conum" data-value="44"></i><b>(44)</b>


            // Retrieve saved doc, get blob as JSON andheck its still a 'blob'
            var sameDoc = dbNew.GetDocument(docId);
            var reconstitutedBlob = new MutableDictionaryObject().
                SetDictionary("blobCOPY", new MutableDictionaryObject(sameDoc.GetBlob("avatar").ToJSON())); <i class="conum" data-value="45"></i><b>(45)</b>

            if (Blob.IsBlob(
                    reconstitutedBlob.GetDictionary("blobCOPY").ToDictionary()))  <i class="conum" data-value="46"></i><b>(46)</b>
            {
               //... process accordingly
               Console.WriteLine("Its a Blob!!");
            }

            // end::tojson-blob[]
            var datavalue = "";
            foreach (string key in myDoc.Keys)
            {
                if (key == "features")
                {
                    datavalue = "features are: ";
                    foreach (string item in myDoc.GetArray(key))
                    {
                        datavalue = datavalue + ", " + item;
                    }
                }
                else if (key == "avatar")
                {
                    datavalue = sameDoc.GetBlob(key).ToJSON();
                }
                else
                {
                    datavalue = sameDoc.GetValue(key).ToString();
                }

                System.Console.WriteLine(" Data -- {0} = {1}", key, datavalue);
            }

            // System.Console.WriteLine(" reconstitutedBlob = {0}", reconstitutedBlob.GetDictionary("blobCOPY").ToJSON());



            //}

            /*
            // tag::tojson-blob-output[]


                Exception = Missing Digest Due To Blob Is Not Saved To Database yet.

                Data -- id = 1002
                Data -- type = hotel
                Data -- name = Hotel Ned
                Data -- city = Balmain
                Data -- country = Australia
                Data -- description = Undefined description for Hotel Ned
                Data -- features = features are: , Cable TV, Toaster, Microwave
                Data -- avatar = {"digest":"sha1-sdCxeOeP3IZV4FEvVVlvtulpWA8=","length":2975,"content_type":"image/jpg","@type":"blob"}

                blobAsJSONstring = {"digest":"sha1-sdCxeOeP3IZV4FEvVVlvtulpWA8=","length":2975,"content_type":"image/jpg","@type":"blob"}

            // end::tojson-blob-output[]
            */
        } /* end of func */




  } // end of class



// p2p sync items


// tag::listener-simple[]
var thisConfig = new URLEndpointListenerConfiguration(thisDB); <i class="conum" data-value="47"></i><b>(47)</b>

thisConfig.Authenticator =
  new ListenerPasswordAuthenticator(
    (sender, username, password) =&gt;
      {
      return username.equals("valid.user")  &amp;&amp; (password == validPassword);
      }
  ); <i class="conum" data-value="48"></i><b>(48)</b>

_thisListener = new URLEndpointListener(thisConfig); <i class="conum" data-value="49"></i><b>(49)</b>

_thisListener.Start(); <i class="conum" data-value="50"></i><b>(50)</b>

// end::listener-simple[]



// tag::replicator-simple[]
var theListenerEndpoint = new URLEndpoint("wss://listener.com:4984/otherDB"); <i class="conum" data-value="51"></i><b>(51)</b>

var thisConfig = new ReplicatorConfiguration(thisDB, theListenerEndpoint); <i class="conum" data-value="52"></i><b>(52)</b>

thisConfig.AcceptOnlySelfSignedServerCertificate = true; <i class="conum" data-value="53"></i><b>(53)</b>

thisConfig.Authenticator =
  new BasicAuthenticator("valid.user", "valid.password.string"); <i class="conum" data-value="54"></i><b>(54)</b>

var thisReplicator = new Replicator(thisConfig); <i class="conum" data-value="55"></i><b>(55)</b>

thisReplicator.Start(); <i class="conum" data-value="56"></i><b>(56)</b>

// end::replicator-simple[]







// PASSIVE PEER STUFF
// Stuff I adapted
//
//
// p2pSync-websockets.cs
//
// Copyright (c) 2017 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Cryptography.X509Certificates;
using System.Threading;
using System.Threading.Tasks;

using Couchbase.Lite;
using Couchbase.Lite.Enterprise.Query;
using Couchbase.Lite.Logging;
using Couchbase.Lite.P2P;
using Couchbase.Lite.Query;
using Couchbase.Lite.Sync;
using Newtonsoft.Json;

using SkiaSharp;
namespace api_walkthrough
{
  class Program
  {
  private static Database _Database;
  private static Replicator _Replicator;
  private static ListenerToken _thisListenerToken;
  private static bool _NeedsExtraDocs;

  #region Private Methods
  private static void GettingStarted()
  {
    // tag::listener-initialize[]

    // tag::listener-config-db[]
    // Initialize the listener config
    var thisConfig = new URLEndpointListenerConfiguration(thisDB); <i class="conum" data-value="57"></i><b>(57)</b>

    // end::listener-config-db[]
    // tag::listener-config-port[]
    thisConfig.Port = 55990; <i class="conum" data-value="58"></i><b>(58)</b>

    // end::listener-config-port[]
    // tag::listener-config-netw-iface[]
    thisConfig.NetworkInterface = "10.1.1.10"; <i class="conum" data-value="59"></i><b>(59)</b>

    // end::listener-config-netw-iface[]
    // tag::listener-config-delta-sync[]
    thisConfig.EnableDeltaSync = true; <i class="conum" data-value="60"></i><b>(60)</b>

    // end::listener-config-delta-sync[]
    // tag::listener-config-tls-full[]
    // tag::listener-config-tls-enable[]
    thisConfig.DisableTLS = false; <i class="conum" data-value="61"></i><b>(61)</b>

    // end::listener-config-tls-enable[]
    // tag::listener-config-tls-id-anon[]
    // Use an Anonymous Self-Signed Cert
    thisConfig.TlsIdentity = null; <i class="conum" data-value="62"></i><b>(62)</b>

    // end::listener-config-tls-id-anon[]
    // tag::listener-config-client-auth-pwd[]
    // Configure the client authenticator
    // Here we are using Basic Authentication) <i class="conum" data-value="63"></i><b>(63)</b>
    SecureString validPassword =  new SecureString(); /* example only */
    // Get SecureString input for validPassword
    var validUser = "valid.username";
    thisConfig.Authenticator = new ListenerPasswordAuthenticator(
      (sender, validUser, validPassword) =&gt;
        {
          return username.equals(validUser)  &amp;&amp; password == validPassword);
        }
      );

    // end::listener-config-client-auth-pwd[]
    // tag::listener-start[]
    // Initialize the listener
    _thisListener = new URLEndpointListener(thisConfig); <i class="conum" data-value="64"></i><b>(64)</b>

    // Start the listener
    thisListener.Start(); <i class="conum" data-value="65"></i><b>(65)</b>

    // end::listener-start[]
    // end::listener-initialize[]
  }

  // tag::old-listener-config-tls-disable[]
  thisConfig.disableTLS = true;
  // end::old-listener-config-tls-disable[]

  // tag::listener-config-tls-id-nil-2[]

  // Use anonymous cert. These are self signed certs created by the system
  thisConfig.TlsIdentity = null;
  // end::listener-config-tls-id-nil-2[]


  // tag::old-listener-config-delta-sync[]
  thisConfig.EnableDeltaSync = true;
  // end::old-listener-config-delta-sync[]


  // tag::listener-status-check[]
  int connectionCount = thisListener.Status.ConnectionCount; <i class="conum" data-value="66"></i><b>(66)</b>
  int activeConnectionCount = thisListener.Status.ActiveConnectionCount;  <i class="conum" data-value="67"></i><b>(67)</b>

  // end::listener-status-check[]


  // tag::listener-stop[]
  thisListener.Stop();

  // end::listener-stop[]

// Additional snippets


// tag::listener-get-network-interfaces[]
foreach(NetworkInterface ni in NetworkInterface.GetAllNetworkInterfaces())
{
  if(ni.NetworkInterfaceType == NetworkInterfaceType.Wireless80211 ||
      ni.NetworkInterfaceType == NetworkInterfaceType.Ethernet)
  {
    // do something with the interface(s)
  }
}

// end::listener-get-network-interfaces[]


// tag::listener-get-url-list[]
var thisConfig = new URLEndpointListenerConfiguration(thisDB);
_thisListener = new URLEndpointListener(thisConfig);

_thisListener.Start();

 Console.WriteLine("URLS are {0} ", thisListener.Urls;

// end::listener-get-url-list[]

    // tag::listener-config-tls-disable[]
    thisConfig.DisableTLS = true; <i class="conum" data-value="68"></i><b>(68)</b>

    // end::listener-config-tls-disable[]

    // tag::listener-local-db[]
    // . . . preceding application logic . . .
    // Get the database (and create it if it doesn't exist)
    var thisDB = new Database("mydb");

    // end::listener-local-db[]

    // tag::listener-config-tls-id-full[]
    // tag::listener-config-tls-id-caCert[]
    // Use CA Cert
    // Create a TLSIdentity from an imported key-pair
    // . . . previously declared variables include ...
    TLSIdentity thisIdentity;
    X509Store _store =
      new X509Store(StoreName.My); // create and label x509 store

    // Get keys and certificates from PKCS12 data
    byte[] thisIdData =
      File.ReadAllBytes("c:client.p12"); <i class="conum" data-value="69"></i><b>(69)</b>
    // . . . other user code . . .

    // tag::import-tls-identity[]
    thisIdentity = TLSIdentity.ImportIdentity(
      _store,
      thisIdData, <i class="conum" data-value="70"></i><b>(70)</b>
      "123", // Password to access certificate data
      "couchbase-demo-cert",
      null); // Label to get cert in certificate map
        // NOTE: If a null label is supplied then the same
        // default directory for a Couchbase Lite database
        // is used for map.

    // end::import-tls-identity[]
    // end::listener-config-tls-id-caCert[]

    // tag::listener-config-tls-id-anon[]
    // Use an Anonymous Self-Signed Cert
    thisConfig.TlsIdentity = null; <i class="conum" data-value="71"></i><b>(71)</b>

    // end::listener-config-tls-id-anon[]
    // tag::listener-config-tls-id-set[]
    // Set the TLS Identity
    thisConfig.TlsIdentity = thisIdentity; <i class="conum" data-value="72"></i><b>(72)</b>

    // end::listener-config-tls-id-set[]
    // end::listener-config-tls-id-full[]

    // tag::listener-config-client-auth-root[]
    // Configure the client authenticator
    // to validate using ROOT CA

    // Get the valid cert chain, in this instance from
    // PKCS12 data containing private key, public key
    // and certificates <i class="conum" data-value="73"></i><b>(73)</b>
    var clientData = File.ReadAllBytes("c:client.p12");
    var ourCaData = File.ReadAllBytes("c:client-ca.der");

    // Get the root certs from the data
    var thisRootCert = new X509Certificate2(ourCaData); <i class="conum" data-value="74"></i><b>(74)</b>

    // Configure the authenticator to use the root certs
    var thisAuth = new ListenerCertificateAuthenticator(new X509Certificate2Collection(thisRootCert));

    thisConfig.Authenticator = thisAuth; <i class="conum" data-value="75"></i><b>(75)</b>

    // Initialize the listener using the config
    _listener = new URLEndpointListener(thisConfig);

    // end::listener-config-client-auth-root[]
    // tag::listener-config-client-auth-lambda[]
    // Configure the client authenticator
    // to validate using application logic

    // Get the valid cert chain, in this instance from
    // PKCS12 data containing private key, public key
    // and certificates <i class="conum" data-value="76"></i><b>(76)</b>
    clientData = File.ReadAllBytes("c:client.p12");
    ourCaData = File.ReadAllBytes("c:client-ca.der");

    // Get the root certs from the data
    var thisRootCert = new X509Certificate2(ourCaData);

    // Configure the authenticator to pass the root certs
    // To a user supplied code block for authentication
    var thisAuth =
      new ListenerCertificateAuthenticator(
        new X509Certificate2Collection(thisRootCert) =&gt; {
          // . . . user supplied code block
          // . . . returns boolean value (true=authenticated)
        }); <i class="conum" data-value="77"></i><b>(77)</b>

    thisConfig.Authenticator = thisAuth; <i class="conum" data-value="78"></i><b>(78)</b>

    // end::listener-config-client-auth-lambda[]



// END Additional






// Listener Callouts

// tag::listener-callouts-full[]

  // tag::listener-start-callouts[]
  &lt;.&gt; Initialize the listener instance using the configuration settings.
  &lt;.&gt; Start the listener, ready to accept connections and incoming data from active peers.
  // end::listener-start-callouts[]


  // tag::listener-status-check-callouts[]

  &lt;.&gt; `connectionCount` -- the total number of connections served by the listener
  &lt;.&gt; `activeConnectionCount` -- the number of active (BUSY) connections currently being served by the listener
  //
  // end::listener-status-check-callouts[]

// tag::listener-config-tls-id-caCert-callouts[]
  &lt;.&gt; Ensure TLS is enabled.
  &lt;.&gt; The identity will be stored in the secure storage using the given label
  &lt;.&gt; PKCS12 data containing private key, public key, and certificates
  &lt;.&gt; The key pair as stored in the byte array
  &lt;.&gt; The password required to access the certificate data
  &lt;.&gt; The key label assigned to the cert in certificate map and used for retrieval
  &lt;.&gt; If null, the same default directory for a Couchbase Lite database is used for map
  &lt;.&gt; Use the TLSIdentity `thisIdentity.`

// end::listener-config-tls-id-caCert-callouts[]

  // tag::listener-config-tls-id-SelfSigned-callouts[]
  &lt;.&gt; Ensure TLS is enabled.
  &lt;.&gt; The identity will be stored in the secure storage using the given label
  &lt;.&gt; When creating a certificate, the common name attribute is required to create a CSR. If the common name is not present in the certificate an exception is thrown.
  &lt;.&gt; If the expiration date is not specified, the expiration date of the certificate is 365 days after creation
  &lt;.&gt; The key label to get cert in certificate map
  &lt;.&gt; If null, the same default directory for a Couchbase Lite database is used for map
  &lt;.&gt; Use the TLSIdentity `thisIdentity.`

  // end::listener-config-tls-id-SelfSigned-callouts[]

// end::listener-callouts-full[]








// tag::old-listener-config-client-auth-root[]
  // cert is a pre-populated object of type:SecCertificate representing a certificate
  // Work in progress. Code snippet to be provided.

  // end::old-listener-config-client-auth-root[]


  // prev content of listener-config-client-auth-self-signed (for ios)
  thisConfig.authenticator = ListenerCertificateAuthenticator.init {
    (cert) -&gt; Bool in
    var cert:SecCertificate
    var certCommonName:CFString?
    let status=SecCertificateCopyCommonName(cert, &amp;certCommonName)
    if (self._allowlistedUsers.contains(["name": certCommonName! as String])) {
      return true
    }
    return false
  }
  // tag::spare-listener-config-client-auth-self-signed[]
  // Work in progress. Code snippet to be provided.

  // end::spare-listener-config-client-auth-self-signed[]

// tag::p2p-ws-api-urlendpointlistener[]
public class URLEndpointListener {
    // Properties <i class="conum" data-value="1"></i><b>(1)</b>
    public let config: URLEndpointListenerConfiguration
    public let port UInt16?
    public let tlsIdentity: TLSIdentity?
    public let urls: Array&lt;URL&gt;?
    public let status: ConnectionStatus?
    // Constructors <i class="conum" data-value="2"></i><b>(2)</b>
    public init(config: URLEndpointListenerConfiguration)
    // Methods <i class="conum" data-value="3"></i><b>(3)</b>
    public func start() throws
    public func stop()
}
// end::p2p-ws-api-urlendpointlistener[]


// tag::p2p-ws-api-urlendpointlistener-constructor[]
let config = URLEndpointListenerConfiguration.init(database: self.oDB)
thisConfig.port = tls ? wssPort : wsPort
thisConfig.disableTLS = !tls
thisConfig.authenticator = auth
self.listener = URLEndpointListener.init(config: config) <i class="conum" data-value="1"></i><b>(1)</b>
// end::p2p-ws-api-urlendpointlistener-constructor[]


// ACTIVE PEER STUFF
// Replication code
//
// Copyright (c) 2019 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

public class Examples {
  private static final String TAG = "EXAMPLE ACTIVE PEER";
  private static final String thisDBNAME = "local-database";
  private final Context context;
  // private Database database;
  // private Replicator replicator;

  public Examples(Context context) { this.context = context; }

  String user = "syncuser";
  String password = "sync9455";
  SecCertificate cert=null;
  String passivePeerEndpoint = "10.1.1.12:8920";
  String passivePeerPort = "8920";
  String passiveDbName = "userdb";
  Database thisDB;
  Replicator thisReplicator;
  ListenerToken replicatorListener;

  //@Test
  public void testActPeerSync() throws CouchbaseLiteException, URISyntaxException {
// tag::p2p-act-rep-func[]
    // . . . preceding code. for example . . .
    private static ListenerToken _thisListenerToken;
    var Database thisDB;
    // . . . other code . . .
    // tag::p2p-act-rep-initialize[]
    // initialize the replicator configuration

    var thisUrl = new URLEndpoint("wss://listener.com:4984/otherDB"); <i class="conum" data-value="79"></i><b>(79)</b>
    var config = new ReplicatorConfiguration(thisDB, thisUrl);

    // end::p2p-act-rep-initialize[]
    // tag::p2p-act-rep-config-type[]

    // Set replicator type
    thisConfig.ReplicatorType = ReplicatorType.PushAndPull;

    // end::p2p-act-rep-config-type[]
    // tag::p2p-act-rep-config-cont[]
    // Configure Sync Mode
    thisConfig.Continuous = true; // default value

    // end::p2p-act-rep-config-cont[]
    // tag::p2p-act-rep-config-self-cert[]
    // Configure Server Security -- only accept self-signed certs
    thisConfig.AcceptOnlySelfSignedServerCertificate = true; <i class="conum" data-value="80"></i><b>(80)</b>

    // end::p2p-act-rep-config-self-cert[]
    // Configure Client Security <i class="conum" data-value="81"></i><b>(81)</b>
    // tag::p2p-act-rep-auth[]
    // Configure basic auth using user credentials
    thisConfig.Authenticator = new BasicAuthenticator("Our Username", "Our Password");

    // end::p2p-act-rep-auth[]
    // tag::p2p-act-rep-config-conflict-full[]
    // tag::p2p-act-rep-config-conflict-builtin[]
    /* Optionally set a conflict resolver call back */ <i class="conum" data-value="82"></i><b>(82)</b>
    // Use built-in resolver
    thisConfig.ConflictResolver = new LocalWinConflictResolver();  //

    // end::p2p-act-rep-config-conflict-builtin[]
    // tag::p2p-act-rep-config-conflict-custom[]
    // optionally use custom resolver
    thisConfig.ConflictResolver = new ConflictResolver(
      (conflict) =&gt; {
        /* define resolver function */
      }
    ); //

    // end::p2p-act-rep-config-conflict-custom[]
    // end::p2p-act-rep-config-conflict-full[]
    // tag::p2p-act-rep-start-full[]
    // Initialize and start a replicator
    // Initialize replicator with configuration data
    var thisReplicator = new Replicator(thisConfig); <i class="conum" data-value="83"></i><b>(83)</b>

    // tag::p2p-act-rep-add-change-listener[]
    // tag::p2p-act-rep-add-change-listener-label[]
    //Optionally add a change listener <i class="conum" data-value="84"></i><b>(84)</b>
    // end::p2p-act-rep-add-change-listener-label[]
    _thisListenerToken =
      thisReplicator.AddChangeListener((sender, args) =&gt;
        {
          if (args.Status.Activity == ReplicatorActivityLevel.Stopped) {
              Console.WriteLine("Replication stopped");
          }
        });

    // end::p2p-act-rep-add-change-listener[]
    // tag::p2p-act-rep-start[]
    // Start replicator
    thisReplicator.Start(); <i class="conum" data-value="85"></i><b>(85)</b>

    // end::p2p-act-rep-start[]
// end::p2p-act-rep-start-full[]
// end::p2p-act-rep-func[]         ***** End p2p-act-rep-func
}

// Additional snippets

    // tag::p2p-act-rep-config-tls-full[]
    // tag::p2p-act-rep-config-cacert[]
    // Configure Server Security -- only accept CA certs
    thisConfig.AcceptOnlySelfSignedServerCertificate = false; <i class="conum" data-value="86"></i><b>(86)</b>

    // end::p2p-act-rep-config-cacert[]
    // tag::p2p-act-rep-config-pinnedcert[]

    // Return the remote pinned cert (the listener's cert)
    byte returnedCert = new byte(thisConfig.getPinnedCertificate()); // Get listener cert if pinned
    // end::p2p-act-rep-config-pinnedcert[]
    // Configure Client Security <i class="conum" data-value="87"></i><b>(87)</b>
    // tag::p2p-act-rep-auth[]
    // Configure basic auth using user credentials
    thisConfig.Authenticator = new BasicAuthenticator("Our Username", "Our Password");

    // end::p2p-act-rep-auth[]
    // end::p2p-act-rep-config-tls-full[]

    // tag::p2p-act-rep-config-cacert-pinned[]
    // Only CA Certs accepted
    thisConfig.AcceptOnlySelfSignedServerCertificate =
      false; <i class="conum" data-value="88"></i><b>(88)</b>

    var thisCert =
      new X509Certificate2(caData); <i class="conum" data-value="89"></i><b>(89)</b>

    thisConfig.PinnedServerCertificate =
      thisCert; <i class="conum" data-value="90"></i><b>(90)</b>

    // end::p2p-act-rep-config-cacert-pinned[]












    // Code to refactor
    Log.i(TAG, "The Replicator is currently " + thisReplicator.Status().getActivityLevel());

    Log.i(TAG, "The Replicator has processed " + t);

    if (thisReplicator.Status().getActivityLevel() == Replicator.ActivityLevel.BUSY) {
          Log.i(TAG, "Replication Processing");
          Log.i(TAG, "It has completed " + thisReplicator.Status().getProgess().getTotal() + " changes");
      }
    // tag::p2p-act-rep-status[]
    _thisReplicator.Stop();
    while (_thisReplicator.Status.Activity != ReplicatorActivityLevel.Stopped) {
        // Database cannot close until replicators are stopped
        Console.WriteLine($"Waiting for replicator to stop (currently {_thisReplicator.Status.Activity})...");
        Thread.Sleep(200);
    }
    _thisDatabase.Close();
    // end::p2p-act-rep-status[]

      // tag::p2p-act-rep-stop[]
      // Stop replication.
      thisReplicator.Stop(); <i class="conum" data-value="91"></i><b>(91)</b>
      // end::p2p-act-rep-stop[]


  }

{
  CouchbaseLite.init(context);
  Database thisDB = new Database("passivepeerdb");  <i class="conum" data-value="92"></i><b>(92)</b>
  // Initialize the listener config
  final URLEndpointListenerConfiguration thisConfig = new URLEndpointListenerConfiguration(database);
  thisConfig.Port(55990)             // &lt;.&gt; Default- port is selected
  thisConfig.DisableTls(false)       // &lt;.&gt; Optional. Defaults to false. You get TLS encryption out-of-box
  thisConfig.EnableDeltaSync(true)   // &lt;.&gt; Optional. Defaults to false.

  // Configure the client authenticator (if using basic auth)
  ListenerPasswordAuthenticator auth = new ListenerPasswordAuthenticator { "Our Username", "Our Password"}; <i class="conum" data-value="93"></i><b>(93)</b>
  thisConfig.Authenticator(auth); <i class="conum" data-value="94"></i><b>(94)</b>

  // Initialize the listener
  final URLEndpointListener listener = new URLEndpointListener( thisConfig ); <i class="conum" data-value="95"></i><b>(95)</b>

  // Start the listener
  listener.Start(); <i class="conum" data-value="96"></i><b>(96)</b>
    }


// tag::createTlsIdentity[]

Map&lt;String, String&gt; X509_ATTRIBUTES = mapOf(
           TLSIdentity.CERT_ATTRIBUTE_COMMON_NAME to "Couchbase Demo",
           TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION to "Couchbase",
           TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION_UNIT to "Mobile",
           TLSIdentity.CERT_ATTRIBUTE_EMAIL_ADDRESS to "noreply@couchbase.com"
       )

TLSIdentity thisIdentity = new TLSIdentity.createIdentity(true, X509_ATTRIBUTES, null, "test-alias");

// end::createTlsIdentity[]


// tag::p2p-tlsid-store-in-keychain[]
. . . work in progress - GetHashCode snippet to be provided
// end::p2p-tlsid-store-in-keychain[]

// tag::deleteTlsIdentity[]
// tag::p2p-tlsid-delete-id-from-keychain[]
TLSIdentity.DeleteIdentity(_store, "alias-to-delete", null);

// end::p2p-tlsid-delete-id-from-keychain[]
// end::deleteTlsIdentity[]

// tag::retrieveTlsIdentity[]
// OPTIONALLY:: Retrieve a stored TLS identity using its alias/label

TLSIdentity thisIdentity = new TLSIdentity.getIdentity("CBL-Demo-Server-Cert")
// end::retrieveTlsIdentity[]


    // Configure the client authenticator (if using Basic Authentication)
    // String validUser = new String("validUsername"); // an example username
    // String validPassword = new String("validPasswordValue"); // an example password

    // ListenerPasswordAuthenticator thisAuth = new ListenerPasswordAuthenticator( <i class="conum" data-value="97"></i><b>(97)</b>
    //   validUser, validPassword -&gt; validUser == "validUsername" &amp;&amp; validPassword == "validPasswordValue" );

    // if (thisAuth) {
    //   thisConfig.Authenticator(auth);
    // }
    // else {
    //   // . . . authentication failed take appropriate exception action
    //   return
    // };




    // tag::old-p2p-act-rep-add-change-listener[]
    ListenerToken thisListener = new thisReplicator.addChangeListener(change -&gt; { <i class="conum" data-value="98"></i><b>(98)</b>
      if (change.Status().getError() != null) {
        Log.i(TAG, "Error code ::  " + change.Status().getError().getCode());
      }
    });

    // end::old-p2p-act-rep-add-change-listener[]



// g u b b i n s
// tag::duff-p2p-tlsid-tlsidentity-with-label[]


    // Configure TLS Cert CA auth using key-stored cert id alias 'doc-sync-server'

    // TLSIdentity thisIdentity = new TLSIdentity.getIdentity("doc-sync-server"); // Get existing TLS ID from sec storage

    // ClientCertificateAuthenticator thisAuth = new ClientCertificateAuthenticator(thisIdentity);

    // thisConfig.Authenticator(thisAuth);



    // USE KEYCHAIN IDENTITY IF EXISTS
    // Check if Id exists in keychain. If so use that Id

    // STILL NEED TO REFACTOR

    do {
      if let thisIdentity = try TLSIdentity.identity(withLabel: "doco-sync-server") {
          print("An identity with label : doco-sync-server already exists in keychain")
          return thisIdentity
          }
    } catch
    {return nil}
    thisAuthenticator.ClientCertificateAuthenticator(identity: thisIdentity )
    thisConfig.thisAuthenticator

    // end::duff-p2p-tlsid-tlsidentity-with-label[]


// tag::old-deleteTlsIdentity[]

String thisAlias = "alias-to-delete";
KeyStore thisKeystore = KeyStore.getInstance("PKCS12"); <i class="conum" data-value="99"></i><b>(99)</b>
thisKeyStore.load= null;
if (thisAlias != null) {
   thisKeystore.deleteEntry(thisAlias);  <i class="conum" data-value="100"></i><b>(100)</b>
}

// end::old-deleteTlsIdentity[]


// cert auth
let rootCertData = SecCertificateCopyData(cert) as Data
let rootCert = SecCertificateCreateWithData(kCFAllocatorDefault, rootCertData as CFData)!
// Listener:
thisConfig.authenticator = ListenerCertificateAuthenticator.init (rootCerts: [rootCert])

SecCertificate thisCert = new SecCertificate(); // populated as nec.

Data rootCertData = new Data(SecCertificateCopyData(thisCert));

let rootCert = SecCertificateCreateWithData(kCFAllocatorDefault, rootCertData as CFData)!
// Listener:
thisConfig.authenticator = ListenerCertificateAuthenticator.init (rootCerts: [rootCert])
// cert auth


// C A L L O U T S

// tag::p2p-act-rep-config-cacert-pinned-callouts[]
&lt;.&gt; Configure to accept only CA certs
&lt;.&gt; Configure the pinned certificate using data from the byte array `cert`
&lt;.&gt; Set the certificate to be compared with that provided by the server
// end::p2p-act-rep-config-cacert-pinned-callouts[]

// tag::??p2p-tlsid-tlsidentity-with-label-callouts[]
&lt;.&gt; PKCS12 data containing private key, public key, and certificates
&lt;.&gt; This is the default value and means that TLS is enabled
// end::??p2p-tlsid-tlsidentity-with-label-callouts[]

// tag::p2p-tlsid-tlsidentity-with-label-callouts[]
&lt;.&gt; Refuse self-signed certificates
&lt;.&gt; Get the identity
&lt;.&gt; Set the Client Certificate Authenticator to require signed certificates with this identity

// end::p2p-tlsid-tlsidentity-with-label-callouts[]


    // tag::old-listener-config-client-root-ca[]
    // Configure the client authenticator
    // to validate using ROOT CA <i class="conum" data-value="101"></i><b>(101)</b>
    byte[] thisCaData; // byte array for CA data
    using (var thisReader = new BinaryReader(stream)) {
      thisCaData = thisReader.ReadBytes(int stream.Length);
    }; // Get cert data

    var thisRootCert = new X509Certificate(thisCaData); //

    thisConfig.Authenticator = new  ListenerCertificateAuthenticator(
      new X509Certificate2Collection(thisRootCert)
    );

    // end::old-listener-config-client-root-ca[]



        // tag::p2p-tlsid-tlsidentity-with-label-per-sam[]
    var db = new Database("other-database");
    _Database = db;
    X509Store _store = new X509Store(StoreName.My);
    TLSIdentity thisIdentity;

    // tag::client-cert-authenticator-root-certs[]

    // Configure the expected server-supplied
    // credentials -- only accept CA Certs
    thisConfig.AcceptOnlySelfSignedServerCertificate = false; <i class="conum" data-value="102"></i><b>(102)</b>

    // Client identity
    thisIdentity =
      TLSIdentity.ImportIdentity(_store,
        clientData,
        "123",
        "CBL-Client-Cert",
        null); <i class="conum" data-value="103"></i><b>(103)</b>

    thisConfig.Authenticator =
      new ClientCertificateAuthenticator(thisIdentity); <i class="conum" data-value="104"></i><b>(104)</b>

    // end::client-cert-authenticator-root-certs[]





    byte[] thisCaData, thisClientData;
    thisClientData = File.ReadAllBytes("C:\\client.p12"); <i class="conum" data-value="105"></i><b>(105)</b>
    thisCaData = File.ReadAllBytes("C:\\client-ca.der");

    // Root certs
    var thisRootCert = new X509Certificate2(thisCaData);
    var thisAuth =
      new ListenerCertificateAuthenticator(
        new X509Certificate2Collection(thisRootCert));

    // Create URL Endpoint Listener
    var thisConfig = new URLEndpointListenerConfiguration(_Database);
    thisConfig.DisableTLS = false; <i class="conum" data-value="106"></i><b>(106)</b>
    thisConfig.Authenticator = thisAuth;
    _listener = new URLEndpointListener(thisConfig);
    _listener.Start();

    // Client identity
    thisIdentity = TLSIdentity.ImportIdentity(_store,
        thisClientData,
        "123",
        "CBL-Client-Cert",
        null);

    // Replicator -- Client
    var database = new Database("client-database");
    var builder = new UriBuilder(
        "wss",
        "localhost",
        _listener.Port,
        $"/{_listener.thisConfig.Database.Name}"
    );

    var url = builder.Uri;
    var target = new URLEndpoint(url);
    var thisConfig = new ReplicatorConfiguration(database, target);
    thisConfig.ReplicatorType = ReplicatorType.PushAndPull;
    thisConfig.Continuous = false;
    thisConfig.Authenticator = new ClientCertificateAuthenticator(thisIdentity);
    thisConfig.AcceptOnlySelfSignedServerCertificate = true;
    thisConfig.PinnedServerCertificate = _listener.TlsIdentity.Certs[0];
    using (var replicator = new Replicator(thisConfig)) {
        replicator.Start();
    }





    // Stop listener after replicator is stopped
    _listener.Stop();

    // end::p2p-tlsid-tlsidentity-with-label-per-sam[]


        // tag::p2p-tlsid-tlsidentity-with-label[]
    // Client identity
    thisIdentity =
      TLSIdentity.ImportIdentity(_store,
        clientData,
        "123",
        "CBL-Client-Cert",
        null); <i class="conum" data-value="107"></i><b>(107)</b>

    thisConfig.Authenticator =
      new ClientCertificateAuthenticator(thisIdentity); <i class="conum" data-value="108"></i><b>(108)</b>

    // end::p2p-tlsid-tlsidentity-with-label[]


// For replications

// BEGIN -- snippets --
//    Purpose -- code samples for use in replication topic

// tag::sgw-repl-pull[]
public class MyClass
{
    public Database Database { get; set; }
    public Replicator Replicator { get; set; } <i class="conum" data-value="1"></i><b>(1)</b>

    public void StartReplication()
    {
        var url = new Uri("ws://localhost:4984/db"); <i class="conum" data-value="2"></i><b>(2)</b>
        var target = new URLEndpoint(url);
        var config = new ReplicatorConfiguration(Database, target)
        {
            ReplicatorType = ReplicatorType.Pull
        };

        Replicator = new Replicator(config);
        Replicator.Start();
    }
}

// end::sgw-repl-pull[]

// tag::sgw-repl-pull-callouts[]
&lt;1&gt; A replication is an asynchronous operation.
To keep a reference to the `replicator` object, you can set it as an instance property.
&lt;2&gt; The URL scheme for remote database URLs has changed in Couchbase Lite 2.0.
You should now use `ws:`, or `wss:` for SSL/TLS connections.
// end::sgw-repl-pull-callouts[]


    // tag::sgw-act-rep-initialize[]
    // initialize the replicator configuration

    var thisUrl = new URLEndpoint("wss://l10.0.2.2:4984/anotherDB"); <i class="conum" data-value="109"></i><b>(109)</b>
    var config = new ReplicatorConfiguration(thisDB, thisUrl);

    // end::sgw-act-rep-initialize[]</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note use of the <code>wss://</code> prefix to ensure TLS encryption (strongly recommended in production)</td>
</tr>
</table>
</div>
<div id="lbl-cfg-sync" class="paragraph">
<p>=== Sync Mode</p>
</div>
<div class="paragraph">
<p>Here we define the direction and type of replication we want to initiate.</p>
</div>
<div class="paragraph">
<p>We use <code><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html">ReplicatorConfiguration</a></code> class&#8217;s <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_ReplicatorType">ReplicatorType</a> and
<code><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_Continuous">Continuous</a></code> parameters, to tell the replicator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The direction of the replication:
<code><strong>pushAndPull</strong></code>; <code>pull</code>; <code>push</code></p>
</li>
<li>
<p>The type of replication, that is:</p>
<div class="ulist">
<ul>
<li>
<p>Continuous&#8201;&#8212;&#8201;remaining active indefinitely to replicate changed documents (<code>continuous=true</code>).</p>
</li>
<li>
<p>Ad-hoc&#8201;&#8212;&#8201;a one-shot replication of changed documents (<code>continuous=false</code>).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">
// Set replicator type
thisConfig.ReplicatorType = ReplicatorType.PushAndPull;

// Configure Sync Mode
thisConfig.Continuous = true; // default value</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="lbl-cfg-keep-alive" class="paragraph">
<p>=== Retry Configuration</p>
</div>
<div class="paragraph">
<p>Couchbase Lite for C#.Net&#8217;s replication retry logic assures a resilient connection.</p>
</div>
<div class="paragraph">
<p>The replicator minimizes the chance and impact of dropped connections by maintaining a heartbeat; essentially pinging the Sync Gateway at a configurable interval to ensure the connection remains alive.</p>
</div>
<div class="paragraph">
<p>In the event it detects a transient error, the replicator will attempt to reconnect, stopping only when the connection is re-established, or the number of retries exceeds the retry limit (9 times for a single-shot replication and unlimited for a continuous replication).</p>
</div>
<div class="paragraph">
<p>On each retry the interval between attempts is increased exponentially (exponential backoff) up to the maximum wait time limit (5 minutes).</p>
</div>
<div class="paragraph">
<p>The REST API provides configurable control over this replication retry logic using a set of configiurable properties&#8201;&#8212;&#8201;see: <a href="#tbl-repl-retry">Table 1</a>.</p>
</div>
<table id="tbl-repl-retry" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Replication Retry Configuration Properties</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 30%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Property</p></th>
<th class="tableblock halign-left valign-top"><p class="tableblock">Use cases</p></th>
<th class="tableblock halign-left valign-top"><p class="tableblock">Description</p></th>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_Heartbeat">Heartbeat()</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Reduce to detect connection errors sooner</p>
</li>
<li>
<p>Align to load-balancer or proxy <code>keep-alive</code> interval&#8201;&#8212;&#8201;see Sync Gateway&#8217;s topic <a href="../../../sync-gateway/current/load-balancer.html#websocket-connection" class="page">Load Balancer - Keep Alive</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The interval (in seconds) between the heartbeat pulses.</p>
</div>
<div class="paragraph">
<p>Default: The replicator pings the Sync Gateway every 300 seconds.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_MaxRetries">MaxRetries()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Change this to limit or extend the number of retry attempts.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum number of retry attempts</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set this to zero (0) to prevent any retry attempt</p>
</li>
<li>
<p>The retry attempt count is reset when the replicator is able to connect and replicate</p>
</li>
<li>
<p>Default values are:</p>
<div class="ulist">
<ul>
<li>
<p>Single-shot replication = 9;</p>
</li>
<li>
<p>Continuous replication = maximum integer value</p>
</li>
</ul>
</div>
</li>
<li>
<p>Negative values generate a Couchbase exception <code>InvalidArgumentException</code></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_MaxRetryWaitTime">MaxRetryWaitTime()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Change this to adjust the interval between retries.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The maximum interval between retry attempts</p>
</div>
<div class="paragraph">
<p>Whilst you can configure the <strong>maximum permitted</strong> wait time,  each individual interval is calculated by the replicator&#8217;s exponential backoff algorithm and is not configurable.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Default value: 300 seconds (5 minutes)</p>
</li>
<li>
<p>Zero or negative values generate a Couchbase exception, <code>InvalidArgumentException</code>.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When necessary you can adjust any or all of those configurable values&#8201;&#8212;&#8201;see: <a href="#ex-repl-retry">[ex-repl-retry]</a> for how to do this.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>{param-leader}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">    var url = new Uri("ws://localhost:4984/mydatabase");
    var target = new URLEndpoint(url);

    var config = new ReplicatorConfiguration(database, target);

//  other config as required . . .

    config.Heartbeat = TimeSpan.FromSeconds(120); //  <i class="conum" data-value="1"></i><b>(1)</b>
    config.MaxRetries = 20; //  <i class="conum" data-value="2"></i><b>(2)</b>
    config.MaxRetryWaitTime = TimeSpan.FromSeconds(600); //  <i class="conum" data-value="3"></i><b>(3)</b>

//  other config as required . . .

    var repl = new Replicator(config);</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here we use <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_Heartbeat">Heartbeat()</a> to set the required interval (in seconds) between the heartbeat pulses</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here we use <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_MaxRetries">MaxRetries()</a> to set the required number of retry attempts</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here we use <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_MaxRetryWaitTime">MaxRetryWaitTime()</a> to set the required interval between retry attempts.</td>
</tr>
</table>
</div>
<div id="lbl-svr-auth" class="paragraph">
<p>=== Server Authentication</p>
</div>
<div class="paragraph">
<p>Define the credentials your app (the client) is expecting to receive from the Sync Gateway (the server) in order to ensure it is prepared to continue with the sync.</p>
</div>
<div class="paragraph">
<p>Note that the client cannot authenticate the server if TLS is turned off.
When TLS is enabled (Sync Gateway&#8217;s default) the client <em>must</em> authenticate the server.
If the server cannot provide acceptable credentials then the connection will fail.</p>
</div>
<div class="paragraph">
<p>Use <code><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html">ReplicatorConfiguration</a></code> properties <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_AcceptOnlySelfSignedServerCertificate">AcceptOnlySelfSignedServerCertificate</a> and <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_PinnedServerCertificate">PinnedServerCertificate</a>, to tell the replicator how to verify server-supplied TLS server certificates.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If there is a pinned certificate, nothing else matters, the server cert must <strong>exactly</strong> match the pinned certificate.</p>
</li>
<li>
<p>If there are no pinned certs and <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_AcceptOnlySelfSignedServerCertificate">AcceptOnlySelfSignedServerCertificate</a> is <code>true</code> then any self-signed certificate is accepted.  Certificates that are not self signed are rejected, no matter who signed them.</p>
</li>
<li>
<p>If there are no pinned certificates and <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorConfiguration.html#Couchbase_Lite_Sync_ReplicatorConfiguration_AcceptOnlySelfSignedServerCertificate">AcceptOnlySelfSignedServerCertificate</a> is <code>false</code> (default), the client validates the servers certificates against the system CA certificates.  The server must supply a chain of certificates whose root is signed by one of the certificates in the system CA bundle.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_ca-cert"></a>CA Cert</p>
</li>
<li>
<p><a id="tabset1_self-signed-cert"></a>Self Signed Cert</p>
</li>
<li>
<p><a id="tabset1_pinned-certificate"></a>Pinned Certificate</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_ca-cert">
<div class="paragraph">
<p>Set the client to expect and accept only CA attested certificates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">// Configure Server Security -- only accept CA certs
thisConfig.AcceptOnlySelfSignedServerCertificate = false; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the default.
Only certificate chains with roots signed by a trusted CA are allowed.
Self signed certificates are not allowed.</td>
</tr>
</table>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_self-signed-cert">
<div class="paragraph">
<p>Set the client to expect and accept only self-signed certificates</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">// Configure Server Security -- only accept self-signed certs
thisConfig.AcceptOnlySelfSignedServerCertificate = true; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set this to <code>true</code> to accept any self signed cert.
Any certificates that are not self-signed are rejected.</td>
</tr>
</table>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_pinned-certificate">
<div class="paragraph">
<p>Set the client to expect and accept only a pinned certificate.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs#L2773-L2782">// Only CA Certs accepted
thisConfig.AcceptOnlySelfSignedServerCertificate =
  false; <i class="conum" data-value="1"></i><b>(1)</b>

var thisCert =
  new X509Certificate2(caData); <i class="conum" data-value="2"></i><b>(2)</b>

thisConfig.PinnedServerCertificate =
  thisCert; <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure to accept only CA certs</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the pinned certificate using data from the byte array <code>cert</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the certificate to be compared with that provided by the server</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>This all assumes that you have configured the Sync Gateway to provide the appropriate SSL certificates, and have included the appropriate certificate in your app bundle&#8201;&#8212;&#8201;for more on this see: <a href="#lbl-cert-pinning">[lbl-cert-pinning]</a>.</p>
</div>
<div id="lbl-client-auth" class="paragraph">
<p>=== Client Authentication</p>
</div>
<div class="paragraph">
<p>By default, Sync Gateway does not enable authentication.
This is to make it easier to get up and running with synchronization.
You can enable authentication with the following properties in the configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "databases": {
    "mydatabase": {
      "users": {
        "GUEST": {"disabled": true}
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To authenticate with Sync Gateway, an associated user must first be created.
Sync Gateway users can be created through the <a href="../../../sync-gateway/current/rest-api-admin.html#/user/post__db___user_" class="page"><code>POST /{tkn-db}/_user</code></a> endpoint on the Admin REST API.
Provided that the user exists on Sync Gateway, there are two ways to authenticate from a Couchbase Lite client: Basic Authentication or Session Authentication.</p>
</div>
<div class="paragraph">
<p>==== Basic Authentication</p>
</div>
<div class="paragraph">
<p>You can provide a user name and password to the basic authenticator class method.
Under the hood, the replicator will send the credentials in the first request to retrieve a <code>SyncGatewaySession</code> cookie and use it for all subsequent requests during the replication.
This is the recommended way of using basic authentication.
<a href="#ex-base-auth">[ex-base-auth]</a> shows how to initiate a one-shot replication as the user <strong>username</strong> with the password <strong>password</strong>.</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">//
// Program.cs
//
// Copyright (c) 2017 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Cryptography.X509Certificates;
using System.Threading;
using System.Threading.Tasks;

using Couchbase.Lite;
using Couchbase.Lite.Enterprise.Query;
using Couchbase.Lite.Logging;
using Couchbase.Lite.P2P;
using Couchbase.Lite.Query;
using Couchbase.Lite.Sync;
using Newtonsoft.Json;

using SkiaSharp;

namespace api_walkthrough
{
    class Program
    {
        private static Database _Database;
        private static Replicator _Replicator;
        private static URLEndpointListener _listener;
        private static ListenerToken _ListenerToken;
        private static bool _NeedsExtraDocs;

        #region Private Methods

        private static void GettingStarted()
        {
            // tag::getting-started[]
            // Get the database (and create it if it doesn't exist)
            var database = new Database("mydb");
            // Create a new document (i.e. a record) in the database
            string id = null;
            using (var mutableDoc = new MutableDocument()) {
                mutableDoc.SetFloat("version", 2.0f)
                    .SetString("type", "SDK");

                // Save it to the database
                database.Save(mutableDoc);
                id = mutableDoc.Id;
            }

            // Update a document
            using (var doc = database.GetDocument(id))
            using (var mutableDoc = doc.ToMutable()) {
                mutableDoc.SetString("language", "C#");
                database.Save(mutableDoc);

                using (var docAgain = database.GetDocument(id)) {
                    Console.WriteLine($"Document ID :: {docAgain.Id}");
                    Console.WriteLine($"Learning {docAgain.GetString("language")}");
                }
            }

            // Create a query to fetch documents of type SDK
            // i.e. SELECT * FROM database WHERE type = "SDK"
            using (var query = QueryBuilder.Select(SelectResult.All())
                .From(DataSource.Database(database))
                .Where(Expression.Property("type").EqualTo(Expression.String("SDK")))) {
                // Run the query
                var result = query.Execute();
                Console.WriteLine($"Number of rows :: {result.Count()}");
            }

            // Create replicator to push and pull changes to and from the cloud
            var targetEndpoint = new URLEndpoint(new Uri("ws://localhost:4984/getting-started-db"));
            var replConfig = new ReplicatorConfiguration(database, targetEndpoint);

            // Add authentication
            replConfig.Authenticator = new BasicAuthenticator("john", "pass");

            // Create replicator (make sure to add an instance or static variable
            // named _Replicator)
            _Replicator = new Replicator(replConfig);
            _Replicator.AddChangeListener((sender, args) =&gt;
            {
                if (args.Status.Error != null) {
                    Console.WriteLine($"Error :: {args.Status.Error}");
                }
            });

            _Replicator.Start();

            // Later, stop and dispose the replicator *before* closing/disposing the database
            // end::getting-started[]
        }

        private static void TestReplicatorConflictResolver()
        {
            // tag::replication-conflict-resolver[]
            var target = new URLEndpoint(new Uri("ws://localhost:4984/mydatabase"));
            var replConfig = new ReplicatorConfiguration(database, target);
            replConfig.ConflictResolver = new LocalWinConflictResolver();

            var replicator = new Replicator(replConfig);
            replicator.Start();
            // end::replication-conflict-resolver[]
        }

        private static void TestSaveWithConflictHandler()
        {
            // tag::update-document-with-conflict-handler[]
            using (var document = database.GetDocument("xyz"))
            using (var mutableDocument = document.ToMutable()) {
                mutableDocument.SetString("name", "apples");
                database.Save(mutableDocument, (updated, current) =&gt;
                {
                    var currentDict = current.ToDictionary();
                    var newDict = updated.ToDictionary();
                    var result = newDict.Concat(currentDict)
                        .GroupBy(kv =&gt; kv.Key)
                        .ToDictionary(g =&gt; g.Key, g =&gt; g.First().Value);
                    updated.SetData(result);
                    return true;
                });
            }
            // end::update-document-with-conflict-handler[]
        }

        private static bool IsValidCredential(string name, SecureString password) { return true;  } // helper
        private static void TestInitListener()
        {
            var db = new Database("other-database");
            _Database = db;

            // tag::init-urllistener[]
            var config = new URLEndpointListenerConfiguration(_Database);
            config.TlsIdentity = null; // Use with anonymous self-signed cert
            config.Authenticator = new ListenerPasswordAuthenticator((sender, username, password) =&gt;
            {
                if(IsValidCredential(username, password)) {
                    return true;
                }

                return false;
            });

            _listener = new URLEndpointListener(config);
            // end::init-urllistener[]
        }

        private static void TestListenerStart()
        {
            // tag::start-urllistener[]
            // CouchbaseLiteException will be thrown when the listener cannot be started. The most common error
            // would be that the configured port has already been used.
            _listener.Start();
            // end::start-urllistener[]
        }

        private static void TestListenerStop()
        {
            // tag::stop-urllistener[]
            _listener.Stop();
            // end::stop-urllistener[]
        }

        private static void TestCreateSelfSignedCert()
        {
            TLSIdentity identity;
            X509Store _store =
             new X509Store(StoreName.My);
              // The identity will be stored in the secure
              // storage using the given label.
            DateTimeOffset fiveMinToExpireCert = DateTimeOffset.UtcNow.AddMinutes(5);

            // tag::create-self-signed-cert[]
            // tag::listener-config-tls-id-SelfSigned[]
            identity = TLSIdentity.CreateIdentity(true, /* isServer */
                new Dictionary&lt;string, string&gt;() { { Certificate.CommonNameAttribute, "Couchbase Inc" } },
                    // The common name attribute is required
                    // when creating a CSR. If it is not presented
                    // in the cert, an exception is thrown.
                fiveMinToExpireCert,
                    // If the expiration date is not specified,
                    // the certs expiration will be 365 days
                _store,
                "CBL-Server-Cert",
                null);  // The key label to get cert in certificate map.
                        // If null, the same default directory
                        // for a Couchbase Lite db is used for map.

            // end::listener-config-tls-id-SelfSigned[]
            // end::create-self-signed-cert[]
        }

        private static void TestImportTLSIdentity()
        {
            TLSIdentity identity;
            X509Store _store = new X509Store(StoreName.My); // The identity will be stored in the secure storage using the given label
            byte[] data = File.ReadAllBytes("C:\\client.p12"); // PKCS12 data containing private key, public key, and certificates

            // tag::import-tls-identity[]
            // tag::listener-config-tls-id-caCert[]
            identity = TLSIdentity.ImportIdentity(_store,
                data,
                "123", // The password that is needed to access the certificate data
                "CBL-Client-Cert",
                null);  // The key label to get cert in certificate map.
                        // If null, the same default directory
                        // for a Couchbase Lite db is used for map.
            // end::listener-config-tls-id-caCert[]
            // end::import-tls-identity[]
        }

          private static void TestClientCertAuthenticatorRootCerts()
        {
            var db = new Database("other-database");
            _Database = db;

            X509Store _store = new X509Store(StoreName.My);
            TLSIdentity identity;

            // tag::client-cert-authenticator-root-certs[]
            byte[] caData, clientData;
            clientData = File.ReadAllBytes("C:\\client.p12"); // PKCS12 data containing private key, public key, and certificates
            caData = File.ReadAllBytes("C:\\client-ca.der");

            // Root certs
            var rootCert = new X509Certificate2(caData);
            var auth = new ListenerCertificateAuthenticator(new X509Certificate2Collection(rootCert));

            // Create URL Endpoint Listener
            var listenerConfig = new URLEndpointListenerConfiguration(_Database);
            listenerConfig.DisableTLS = false; //The default value is false which means that the TLS will be enabled by default.
            listenerConfig.Authenticator = auth;
            _listener = new URLEndpointListener(listenerConfig);
            _listener.Start();

            // Client identity
            identity = TLSIdentity.ImportIdentity(_store,
                clientData,
                "123",
                "CBL-Client-Cert",
                null);

            // Replicator -- Client
            var database = new Database("client-database");
            var builder = new UriBuilder(
                "wss",
                "localhost",
                _listener.Port,
                $"/{_listener.Config.Database.Name}"
            );

            var url = builder.Uri;
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.ReplicatorType = ReplicatorType.PushAndPull;
            config.Continuous = false;
            config.Authenticator = new ClientCertificateAuthenticator(identity);
            config.AcceptOnlySelfSignedServerCertificate = true;
            config.PinnedServerCertificate = _listener.TlsIdentity.Certs[0];
            using (var replicator = new Replicator(config)) {
                replicator.Start();
            }

            // Stop listener after replicator is stopped
            _listener.Stop();
            // end::client-cert-authenticator-root-cert
        }

        private static void TestClientCertAuthenticator()
        {
            var db = new Database("other-database");
            _Database = db;

            X509Store _store = new X509Store(StoreName.My);
            TLSIdentity identity;

            // tag::client-cert-authenticator[]

            // Create Listener Certificate Authenticator
            var auth = new ListenerCertificateAuthenticator((sender, cert) =&gt;
            {
                if (cert.Count != 1) {
                    return false;
                }

                return cert[0].SubjectName.Name?.Replace("CN=", "") == "couchbase";
            });

            // Create URL Endpoint Listener
            var listenerConfig = new URLEndpointListenerConfiguration(_Database);
            listenerConfig.DisableTLS = false; //The default value is false which means that the TLS will be enabled by default.
            listenerConfig.Authenticator = auth;
            _listener = new URLEndpointListener(listenerConfig);
            _listener.Start();

            // User Identity
            identity = TLSIdentity.CreateIdentity(false,
                new Dictionary&lt;string, string&gt;() { { Certificate.CommonNameAttribute, "couchbase" } },
                null,
                _store,
                ClientCertLabel,
                null);

            // Replicator -- Client
            var database = new Database("client-database");
            var builder = new UriBuilder(
                "wss",
                "localhost",
                _listener.Port,
                $"/{_listener.Config.Database.Name}"
            );

            var url = builder.Uri;
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.ReplicatorType = ReplicatorType.PushAndPull;
            config.Continuous = false;
            config.Authenticator = new ClientCertificateAuthenticator(identity);
            config.AcceptOnlySelfSignedServerCertificate = false;
            config.PinnedServerCertificate = _listener.TlsIdentity.Certs[0];
            using (var replicator = new Replicator(config)) {
                replicator.Start();
            }

            // Stop listener after replicator is stopped
            _listener.Stop();
            // end::client-cert-authenticator[]
        }

        private static void UseEncryption()
        {
            // Enterprise edition only

            // tag::database-encryption[]
            // Create a new, or open an existing database with encryption enabled
            var config = new DatabaseConfiguration
            {
                // Or, derive a key yourself and pass a byte array of the proper size
                EncryptionKey = new EncryptionKey("password")
            };

            using (var db = new Database("seekrit", config)) {
                // Change the encryption key (or add encryption if the DB is unencrypted)
                db.ChangeEncryptionKey(new EncryptionKey("betterpassw0rd"));

                // Remove encryption
                db.ChangeEncryptionKey(null);
            }
            // end::database-encryption[]
        }

        private static void ResetReplicatorCheckpoint()
        {
            var database = _Database;
            var url = new Uri("ws://localhost:4984/db");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            using (var replicator = new Replicator(config)) {
                // tag::replication-reset-checkpoint[]
                // replicator is a Replicator instance
                replicator.ResetCheckpoint();
                replicator.Start();
                // end::replication-reset-checkpoint[]
            }
        }

        private static void Read1xAttachment()
        {
            var db = _Database;
            using (var document = new MutableDocument()) {
                // tag::1x-attachment[]
                var attachments = document.GetDictionary("_attachments");
                var avatar = attachments.GetBlob("avatar");
                var content = avatar?.Content;
                // end::1x-attachment[]
            }
        }

        private static void CreateNewDatabase()
        {
            // tag::new-database[]
            var db = new Database("my-database");
            // end::new-database[]

            _Database = db;
        }

        private static void CloseDatabase()
        {
          // tag::close-database[]
          database.close()

          // end::close-database[]
        }

        private static void ChangeLogging()
        {
            // tag::logging[]
            Database.SetLogLevel(LogDomain.Replicator, LogLevel.Verbose);
            Database.SetLogLevel(LogDomain.Query, LogLevel.Verbose);
            // end::logging[]
        }

        private static void LoadPrebuilt()
        {
            // tag::prebuilt-database[]
            // Note: Getting the path to a database is platform-specific.  For .NET Core / .NET Framework this
            // can be a simple filesystem path.  For UWP, you will need to get the path from your assets.  For
            // iOS you need to get the path from the main bundle.  For Android you need to extract it from your
            // assets to a temporary directory and then pass that path.
            var path = Path.Combine(Environment.CurrentDirectory, "travel-sample.cblite2" + Path.DirectorySeparatorChar);
            if (!Database.Exists("travel-sample", null)) {
                _NeedsExtraDocs = true;
                Database.Copy(path, "travel-sample", null);
            }
            // end::prebuilt-database[]

            _Database.Close();
            _Database = new Database("travel-sample");
        }

        private static void QueryDeletedDocuments()
        {
            // tag::query-deleted-documents[]
            // Query documents that have been deleted
            var query = QueryBuilder
                .Select(SelectResult.Expression(Meta.ID))
                .From(DataSource.Database(db))
                .Where(Meta.IsDeleted);
            // end::query-deleted-documents[]
        }

        private static void CreateDocument()
        {
            var db = _Database;
            // tag::initializer[]
            using (var newTask = new MutableDocument("xyz")) {
                newTask.SetString("type", "task")
                    .SetString("owner", "todo")
                    .SetDate("createdAt", DateTimeOffset.UtcNow);

                db.Save(newTask);
            }
            // end::initializer[]
        }

        private static void UpdateDocument()
        {
            var db = _Database;
            // tag::update-document[]
            using(var document = db.GetDocument("xyz"))
            using (var mutableDocument = document.ToMutable()) {
                mutableDocument.SetString("name", "apples");
                db.Save(mutableDocument);
            }
            // end::update-document[]
        }

        private static void UseTypedAccessors()
        {
            using (var newTask = new MutableDocument()) {
                // tag::date-getter[]
                newTask.SetValue("createdAt", DateTimeOffset.UtcNow);
                var date = newTask.GetDate("createdAt");
                // end::date-getter[]

                Console.WriteLine(date);
            }
        }

        private static void DoBatchOperation()
        {
            var db = _Database;
            // tag::batch[]
            db.InBatch(() =&gt;
            {
                for (var i = 0; i &lt; 10; i++) {
                    using (var doc = new MutableDocument()) {
                        doc.SetString("type", "user");
                        doc.SetString("name", $"user {i}");
                        doc.SetBoolean("admin", false);
                        db.Save(doc);
                        Console.WriteLine($"Saved user document {doc.GetString("name")}");
                    }
                }
            });
            // end::batch[]
        }

        private static void DatabaseChangeListener()
        {
            var db = _Database;

            // tag::document-listener[]
            db.AddDocumentChangeListener("user.john", (sender, args) =&gt;
            {
                using (var doc = Db.GetDocument(args.DocumentID)) {
                    Console.WriteLine($"Status :: {doc.GetString("verified_account")}");
                }
            });
            // end::document-listener[]
        }

        private static void DocumentExpiration()
        {
            var db = _Database;

            // tag::document-expiration[]
            // Purge the document one day from now
            var ttl = DateTimeOffset.UtcNow.AddDays(1);
            db.SetDocumentExpiration("doc123", ttl);

            // Reset expiration
            db.SetDocumentExpiration("doc1", null);

            // Query documents that will be expired in less than five minutes
            var fiveMinutesFromNow = DateTimeOffset.UtcNow.AddMinutes(5).ToUnixTimeMilliseconds();
            var query = QueryBuilder
                .Select(SelectResult.Expression(Meta.ID))
                .From(DataSource.Database(db))
                .Where(Meta.Expiration.LessThan(Expression.Double(fiveMinutesFromNow)));
            // end::document-expiration[]
        }

        private static void UseBlob()
        {
            var db = _Database;
            using (var newTask = new MutableDocument()) {
                // tag::blob[]
                // Note: Reading the data is implementation dependent, as with prebuilt databases
                var image = File.ReadAllBytes("avatar.jpg");
                var blob = new Blob("image/jpeg", image);
                newTask.SetBlob("avatar", blob);
                db.Save(newTask);
                // end::blob[]

                var taskBlob = newTask.GetBlob("avatar");
                using (var bitmap = SKBitmap.Decode(taskBlob.ContentStream)) {
                    Console.WriteLine($"Bitmap dimensions: {bitmap.Width} x {bitmap.Height} ({bitmap.BytesPerPixel} bytes per pixel)");
                }
            }
        }

        private static void CreateIndex()
        {
            var db = _Database;

            // tag::query-index[]
            // For value types, this is optional but provides performance enhancements
            var index = IndexBuilder.ValueIndex(
                ValueIndexItem.Expression(Expression.Property("type")),
                ValueIndexItem.Expression(Expression.Property("name"))); <i class="conum" data-value="1"></i><b>(1)</b>
            db.CreateIndex("TypeNameIndex", index);
            // end::query-index[]
        }

        private static void SelectMeta()
        {
            Console.WriteLine("Select Meta");
            var db = _Database;

            // tag::query-select-meta[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("type"),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Document ID :: {result.GetString("id")}");
                    Console.WriteLine($"Document Name :: {result.GetString("name")}");
                }
            }
            // end::query-select-meta[]
        }

        private static void SelectAll()
        {
            var db = _Database;

            // tag::query-select-all[]
            using (var query = QueryBuilder.Select(SelectResult.All())
                .From(DataSource.Database(db))) {
                // All user properties will be available here
            }
            // end::query-select-all[]

            // tag::live-query[]
            var query = QueryBuilder
                .Select(SelectResult.All())
                .From(DataSource.Database(db));

            // Adds a query change listener.
            // Changes will be posted on the main queue.
            var token = query.AddChangeListener((sender, args) =&gt; <i class="conum" data-value="2"></i><b>(2)</b>
            {
                var allResult = args.Results.AllResults();
                foreach (var result in allResult) {
                    Console.WriteLine(result.Keys);
                    /* Update UI */
                }
            });

            // Start live query.
            query.Execute(); <i class="conum" data-value="1"></i><b>(1)</b>
            // end::live-query[]

            // tag::stop-live-query[]
            query.RemoveChangeListener(token);
            query.Dispose();
            // end::stop-live-query[]
        }

        private static void SelectWhere()
        {
            Console.WriteLine("Where");
            var db = _Database;

            // tag::query-where[]
            using (var query = QueryBuilder.Select(SelectResult.All())
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("hotel")))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    var dict = result.GetDictionary(db.Name);
                    Console.WriteLine($"Document Name :: {dict?.GetString("name")}");
                }
            }
            // end::query-where[]
        }

        private static void UseCollectionContains()
        {
            Console.WriteLine("Collection Operator CONTAINS");
            var db = _Database;

            // tag::query-collection-operator-contains[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"),
                    SelectResult.Property("public_likes"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("hotel"))
                    .And(ArrayFunction.Contains(Expression.Property("public_likes"),
                        Expression.String("Armani Langworth"))))) {
                foreach (var result in query.Execute()) {
                    var publicLikes = result.GetArray("public_likes");
                    var jsonString = JsonConvert.SerializeObject(publicLikes);
                    Console.WriteLine($"Public Likes :: {jsonString}");
                }
            }
            // end::query-collection-operator-contains[]
        }

        private static void UseCollectionIn()
        {
            Console.WriteLine("Collection Operator IN");
            var db = _Database;

            // tag::query-collection-operator-in[]
            var values = new IExpression[]
                { Expression.Property("first"), Expression.Property("last"), Expression.Property("username") };

            using (var query = QueryBuilder.Select(
                    SelectResult.All())
                .From(DataSource.Database(db))
                .Where(Expression.String("Armani").In(values))) {
                foreach (var result in query.Execute()) {
                    var body = result.GetDictionary(0);
                    var jsonString = JsonConvert.SerializeObject(body);
                    Console.WriteLine($"In results :: {jsonString}");
                }
            }
            // end::query-collection-operator-in[]
        }

        private static void SelectLike()
        {
            Console.WriteLine("Like");
            var db = _Database;

            // tag::query-like-operator[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Function.Lower(Expression.Property("name")).Like(Expression.String("Royal Engineers Museum"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-like-operator[]
        }

        private static void SelectWildcardLike()
        {
            Console.WriteLine("Wildcard Like");
            var db = _Database;

            // tag::query-like-operator-wildcard-match[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Function.Lower(Expression.Property("name")).Like(Expression.String("Eng%e%"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-like-operator-wildcard-match[]
        }

        private static void SelectWildcardCharacterLike()
        {
            Console.WriteLine("Wildchard Characters");
            var db = _Database;

            // tag::query-like-operator-wildcard-character-match[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Expression.Property("name").Like(Expression.String("Royal Eng____rs Museum"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-like-operator-wildcard-character-match[]
        }

        private static void SelectRegex()
        {
            Console.WriteLine("Regex");
            var db = _Database;

            // tag::query-regex-operator[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Expression.Property("name").Regex(Expression.String("\\bEng.*e\\b"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-regex-operator[]
        }

        private static void SelectJoin()
        {
            Console.WriteLine("Join");
            var db = _Database;

            // tag::query-join[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Expression.Property("name").From("airline")),
                    SelectResult.Expression(Expression.Property("callsign").From("airline")),
                    SelectResult.Expression(Expression.Property("destinationairport").From("route")),
                    SelectResult.Expression(Expression.Property("stops").From("route")),
                    SelectResult.Expression(Expression.Property("airline").From("route")))
                .From(DataSource.Database(db).As("airline"))
                .Join(Join.InnerJoin(DataSource.Database(db).As("route"))
                    .On(Meta.ID.From("airline").EqualTo(Expression.Property("airlineid").From("route"))))
                .Where(Expression.Property("type").From("route").EqualTo(Expression.String("route"))
                    .And(Expression.Property("type").From("airline").EqualTo(Expression.String("airline")))
                    .And(Expression.Property("sourceairport").From("route").EqualTo(Expression.String("RIX"))))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-join[]
        }

        private static void GroupBy()
        {
            Console.WriteLine("GroupBy");
            var db = _Database;

            // tag::query-groupby[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Function.Count(Expression.All())),
                    SelectResult.Property("country"),
                    SelectResult.Property("tz"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("airport"))
                    .And(Expression.Property("geo.alt").GreaterThanOrEqualTo(Expression.Int(300))))
                .GroupBy(Expression.Property("country"), Expression.Property("tz"))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine(
                        $"There are {result.GetInt("$1")} airports in the {result.GetString("tz")} timezone located in {result.GetString("country")} and above 300 ft");
                }
            }
            // end::query-groupby[]
        }

        private static void OrderBy()
        {
            Console.WriteLine("OrderBy");
            var db = _Database;

            // tag::query-orderby[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("title"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("hotel")))
                .OrderBy(Ordering.Property("title").Ascending())
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Title :: {result.GetString("title")}");
                }
            }
            // end::query-orderby[]
        }

      // ### EXPLAIN statement
      private static void TestExplainStatement()
      // For Documentation
      {
        var db = _Database;
          // tag::query-explain-all[]
        var query =
          QueryBuilder
            .Select(SelectResult.All())
            .From(DataSource.Database(db))
            .Where(Expression.Property("type").EqualTo(Expression.String("hotel")))
            .GroupBy(Expression.Property("country"))
            .OrderBy(Ordering.Property("title").Ascending()) <i class="conum" data-value="3"></i><b>(3)</b>

          Console.WriteLine(query.Explain()); <i class="conum" data-value="4"></i><b>(4)</b>

          // end::query-explain-all[]
          // tag::query-explain-like[]
var query =
  QueryBuilder
    .Select(SelectResult.All())
    .From(DataSource.Database(db))
    .Where(Expression.Property("type").Like(Expression.String("%hotel%"))
      .And(Function.Lower(Expression.Property("name")).Like(Expression.String("%royal%")))); <i class="conum" data-value="5"></i><b>(5)</b>
  Console.WriteLine(query.Explain());

          // end::query-explain-like[]
          // tag::query-explain-nopfx[]
var query =
  QueryBuilder
    .Select(SelectResult.All())
    .From(DataSource.Database(db))
    .Where(Expression.Property("type").Like(Expression.String("hotel%"))
      .And(Function.Lower(Expression.Property("name")).Like(Expression.String("%royal%")))); <i class="conum" data-value="6"></i><b>(6)</b>

  Console.WriteLine(query.Explain());

          // end::query-explain-nopfx[]
          // tag::query-explain-function[]
var query =
  QueryBuilder
    .Select(SelectResult.All())
    .From(DataSource.Database(db))
    .Where(Function.Lower(Expression.Property("type")).EqualTo(Expression.String("hotel"))); <i class="conum" data-value="7"></i><b>(7)</b>

  Console.WriteLine(query.Explain());

          // end::query-explain-function[]
          // tag::query-explain-nofunction[]
        var query =
          QueryBuilder
            .Select(SelectResult.All())
            .From(DataSource.Database(db))
            .Where(Expression.Property("type")).EqualTo(Expression.String("hotel")); <i class="conum" data-value="8"></i><b>(8)</b>

          Console.WriteLine(query.Explain());

          // end::query-explain-nofunction[]
      }

      // end query-explain





        private static void CreateFullTextIndex()
        {
            var db = _Database;
            if (_NeedsExtraDocs) {
                var tasks = new[] { "buy groceries", "play chess", "book travels", "buy museum tickets" };
                foreach (var task in tasks) {
                    using (var doc = new MutableDocument()) {
                        doc.SetString("type", "task");
                        doc.SetString("name", task);
                        db.Save(doc);
                    }
                }
            }

            // tag::fts-index[]
            var index = IndexBuilder.FullTextIndex(FullTextIndexItem.Property("name")).IgnoreAccents(false);
            db.CreateIndex("nameFTSIndex", index);
            // end::fts-index[]
        }

        private static void FullTextSearch()
        {
            Console.WriteLine("Full text search");
            var db = _Database;

            // tag::fts-query[]
            var whereClause = FullTextExpression.Index("nameFTSIndex").Match("'buy'");
            using (var query = QueryBuilder.Select(SelectResult.Expression(Meta.ID))
                .From(DataSource.Database(db))
                .Where(whereClause)) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Document id {result.GetString(0)}");
                }
            }
            // end::fts-query[]
        }
        private static void StartReplication()
        {
            var db = _Database;

            /*
             * This requires Sync Gateway running with the following config, or equivalent:
             *
             * {
             *     "log":["*"],
             *     "databases": {
             *         "db": {
             *             "server":"walrus:",
             *             "users": {
             *                 "GUEST": {"disabled": false, "admin_channels": ["*"] }
             *             }
             *         }
             *     }
             * }
             */

            // tag::replication[]
            // Note: Android emulator needs to use 10.0.2.2 for localhost (10.0.3.2 for GenyMotion)
            var url = new Uri("ws://localhost:4984/db");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(db, target)
            {
                ReplicatorType = ReplicatorType.Pull
            };

            var replicator = new Replicator(config);
            replicator.Start();
            // end::replication[]

            _Replicator = replicator;
        }

        private static void VerboseReplicatorLogging()
        {
            // tag::replication-logging[]
            // deprecated
            Database.SetLogLevel(LogDomain.Replicator, LogLevel.Verbose);
            Database.SetLogLevel(LogDomain.Network, LogLevel.Verbose);
            // end::replication-logging[]
        }

        private static void ConsoleLogging()
        {
            // tag::console-logging[]
            Database.Log.Console.Domains = LogDomain.All; <i class="conum" data-value="9"></i><b>(9)</b>
            Database.Log.Console.LogLevel = LogLevel.Verbose; <i class="conum" data-value="10"></i><b>(10)</b>

            // end::console-logging[]

            // tag::console-logging-db[]
            Database.Log.Console.Domains = LogDomain.Database;

            // end::console-logging-db[]
        }

        private static void FileLogging()
        {
            // tag::file-logging[]
            var tempFolder = Path.Combine(Service.GetInstance&lt;IDefaultDirectoryResolver&gt;().DefaultDirectory(), "cbllog");
            var config = new LogFileConfiguration(tempFolder) <i class="conum" data-value="11"></i><b>(11)</b>
            {
                MaxRotateCount = 5, <i class="conum" data-value="12"></i><b>(12)</b>
                MaxSize = 10240, <i class="conum" data-value="13"></i><b>(13)</b>
                UsePlainText = false  <i class="conum" data-value="14"></i><b>(14)</b>
            };
            Database.Log.File.Config = config; // Apply configuration
            Database.Log.File.Level = LogLevel.Info; <i class="conum" data-value="15"></i><b>(15)</b>

            // end::file-logging[]
        }

        private static void EnableCustomLogging()
        {
            // tag::set-custom-logging[]
            Database.Log.Custom = new LogTestLogger(); <i class="conum" data-value="16"></i><b>(16)</b>
            or
            Database.Log.Custom = new LogTestLogger { Level = LogLevel.Warning };

            // end::set-custom-logging[]
        }

        private static void WriteConsoleLog()
        {
            // tag::write-console-logmsg[]
            Database.Log.Console.Log(LogLevel.Warning, LogDomain.Replicator, "Any old log message");
            // end::write-console-logmsg[]
        }
        private static void WriteCustomLog()
        {
            // tag::write-custom-logmsg[]
            Database.Log.Custom?.Log(LogLevel.Warning, LogDomain.Replicator, "Any old log message");
            // end::write-custom-logmsg[]
        }


        private static void WriteFileLog()
        {
            // tag::write-file-logmsg[]
            Database.Log.File.Log(LogLevel.Warning, LogDomain.Replicator, "Any old log message");
            // end::write-file-logmsg[]
        }

        private static void EnableBasicAuth()
        {
            var database = _Database;

            // tag::basic-authentication[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.Authenticator = new BasicAuthenticator("john", "pass");

            var replicator = new Replicator(config);
            replicator.Start();
            // end::basic-authentication[]
        }

        private static void EnableSessionAuth()
        {
            var database = _Database;

            // tag::session-authentication[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.Authenticator = new SessionAuthenticator("904ac010862f37c8dd99015a33ab5a3565fd8447");

            var replicator = new Replicator(config);
            replicator.Start();
            // end::session-authentication[]
        }

        private static void SetupReplicatorListener()
        {
            var replicator = _Replicator;

            // tag::replication-status[]
            replicator.AddChangeListener((sender, args) =&gt;
            {
                if (args.Status.Activity == ReplicatorActivityLevel.Stopped) {
                    Console.WriteLine("Replication stopped");
                }
            });
            // end::replication-status[]
        }




    //  BEGIN PendingDocuments IB -- 11/Feb/21 --
    private static void ReplicatorPendingDocuments()
    {
        // tag::replication-pendingdocuments[]
        var url = new Uri("ws://localhost:4984/mydatabase");
        var target = new URLEndpoint(url);
        var database = new Database("myDB");
        var config = new ReplicatorConfiguration(database, target);
        config.ReplicatorType  = ReplicatorType.Push;

        // tag::replication-push-pendingdocumentids[]
        var replicator = new Replicator(config);

        var mydocids =
          new HashSet &lt;string&gt; (replicator.GetPendingDocumentIDs()); <i class="conum" data-value="17"></i><b>(17)</b>

        // end::replication-push-pendingdocumentids[]

        if (mydocids.Count &gt; 0)
        {
            Console.WriteLine($"There are {mydocids.Count} documents pending");
            replicator.AddChangeListener((sender, change) =&gt;
            {
                Console.WriteLine($"Replicator activity level is " +
                                  change.Status.Activity.ToString());
                // iterate and report-on previously
                // retrieved pending docids 'list'
                foreach (var thisId in mydocids)
                    // tag::replication-push-isdocumentpending[]
                    if (!replicator.IsDocumentPending(thisId)) <i class="conum" data-value="18"></i><b>(18)</b>
                    {
                        Console.WriteLine($"Doc ID {thisId} now pushed");
                    };
                // end::replication-push-isdocumentpending[]
            });

            replicator.Start();
        }
    // end::replication-pendingdocuments[]
    }


//  END PendingDocuments IB -- 11/Feb/21 --



		private static void ReplicatorDocumentEvent()
        {
            var replicator = _Replicator;

            // tag::add-document-replication-listener[]
            var token = replicator.AddDocumentReplicationListener((sender, args) =&gt;
            {
                var direction = args.IsPush ? "Push" : "Pull";
                Console.WriteLine($"Replication type :: {direction}");
                foreach (var document in args.Documents) {
                    if (document.Error == null) {
                        Console.WriteLine($"Doc ID :: {document.Id}");
                        if (document.Flags.HasFlag(DocumentFlags.Deleted)) {
                            Console.WriteLine("Successfully replicated a deleted document");
                        }
                    } else {
                        // There was an error
                    }
                }
            });

            replicator.Start();
            // end::add-document-replication-listener[]

            // tag::remove-document-replication-listener[]
            replicator.RemoveChangeListener(token);
            // end::remove-document-replication-listener[]
        }

        private static void SetupReplicatorErrorListener()
        {
            // This can be done in the SetupReplicatorListener method
            // But it is separate so that we can have two documentation entries

            var replicator = _Replicator;

            // tag::replication-error-handling[]
            replicator.AddChangeListener((sender, args) =&gt;
            {
                if (args.Status.Error != null) {
                    Console.WriteLine($"Error :: {args.Status.Error}");
                }
            });
            // end::replication-error-handling[]
        }

        private static void DatabaseReplica()
        {
            var db = _Database;
            using (var database2 = new Database("backup")) {
                // EE feature: This code will not compile on the community edition
                // tag::database-replica[]
                var targetDatabase = new DatabaseEndpoint(database2);
                var config = new ReplicatorConfiguration(db, targetDatabase)
                {
                    ReplicatorType = ReplicatorType.Push
                };

                var replicator = new Replicator(config);
                replicator.Start();
                // end::database-replica[]

                _Replicator?.Stop();
                _Replicator = replicator;
            }
        }

        private static void PinCertificate()
        {
            // Note: No certificate is included here, so this code is for show only
            var url = new Uri("wss://localhost:4984/db");
            var target = new URLEndpoint(url);
            var db = _Database;

            // tag::certificate-pinning[]
            // Note: `GetCertificate` is a fake method. This would be the platform-specific method
            // to find and load the certificate as an instance of `X509Certificate2`.
            // For .NET Core / .NET Framework this can be loaded from the filesystem path.
            // For UWP, from the assets directory.
            // For iOS, from the main bundle.
            // For Android, from the assets directory.
            var certificate = GetCertificate("cert.cer");
            var config = new ReplicatorConfiguration(db, target)
            {
                PinnedServerCertificate = certificate
            };
            // end::certificate-pinning[]
        }

        private static void ReplicationCustomHeaders()
        {
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            // tag::replication-custom-header[]
            var config = new ReplicatorConfiguration(database, target)
            {
                Headers = new Dictionary&lt;string, string&gt;
                {
                    ["CustomHeaderName"] = "Value"
                }
            };
            // end::replication-custom-header[]
        }

        private static void PushWithFilter(Database database)
        {
            // tag::replication-push-filter[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            var config = new ReplicatorConfiguration(database, target);
            config.PushFilter = (document, flags) =&gt; <i class="conum" data-value="1"></i><b>(1)</b>
            {
                if (flags.HasFlag(DocumentFlags.Deleted)) {
                    return false;
                }

                return true;
            };

            // Dispose() later
            var replicator = new Replicator(config);
            replicator.Start();
            // end::replication-push-filter[]
        }

        private static void PullWithFilter(Database database)
        {
            // tag::replication-pull-filter[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            var config = new ReplicatorConfiguration(database, target);
            config.PullFilter = (document, flags) =&gt; <i class="conum" data-value="1"></i><b>(1)</b>
            {
                if (document.GetString("type") == "draft") {
                    return false;
                }

                return true;
            };

            // Dispose() later
            var replicator = new Replicator(config);
            replicator.Start();
            // end::replication-pull-filter[]
        }

        public void TestCustomRetryConfig()
        {
        // tag::replication-retry-config[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            var config = new ReplicatorConfiguration(database, target);

        //  other config as required . . .

        // tag::replication-set-heartbeat[]
            config.Heartbeat = TimeSpan.FromSeconds(120); //  <i class="conum" data-value="19"></i><b>(19)</b>
        // end::replication-set-heartbeat[]
        // tag::replication-set-maxretries[]
            config.MaxRetries = 20; //  <i class="conum" data-value="20"></i><b>(20)</b>
        // end::replication-set-maxretries[]
        // tag::replication-set-maxretrywaittime[]
            config.MaxRetryWaitTime = TimeSpan.FromSeconds(600); //  <i class="conum" data-value="21"></i><b>(21)</b>
        // end::replication-set-maxretrywaittime[]

        //  other config as required . . .

            var repl = new Replicator(config);

        // end::replication-retry-config[]
        }


        private static void UsePredictiveModel()
        {
            using (var db = new Database("mydb")) {
                // tag::register-model[]
                var model = new ImageClassifierModel();
                Database.Prediction.RegisterModel("ImageClassifier", model);
                // end::register-model[]

                // tag::predictive-query-value-index[]
                var index = IndexBuilder.ValueIndex(ValueIndexItem.Property("label"));
                db.CreateIndex("value-index-image-classifier", index);
                // end::predictive-query-value-index[]

                // tag::unregister-model[]
                Database.Prediction.UnregisterModel("ImageClassifier");
                // end::unregister-model[]
            }
        }

        private static void UsePredictiveIndex()
        {
            using (var db = new Database("mydb")) {
                // tag::predictive-query-predictive-index[]
                var input = Expression.Dictionary(new Dictionary&lt;string, object&gt;
                {
                    ["photo"] = Expression.Property("photo")
                });

                var index = IndexBuilder.PredictiveIndex("ImageClassifier", input);
                db.CreateIndex("predictive-index-image-classifier", index);
                // end::predictive-query-predictive-index[]
            }
        }

        private static void DoPredictiveQuery()
        {
            using (var db = new Database("mydb")) {
                // tag::predictive-query[]
                var input = Expression.Dictionary(new Dictionary&lt;string, object&gt;
                {
                    ["photo"] = Expression.Property("photo")
                });
                var prediction = PredictiveModel.predict("ImageClassifier", input); <i class="conum" data-value="1"></i><b>(1)</b>

                using (var q = QueryBuilder.Select(SelectResult.All())
                    .From(DataSource.Database(db))
                    .Where(prediction.Property("label").EqualTo(Expression.String("car"))
                        .And(prediction.Property("probability").GreaterThanOrEqualTo(Expression.Double(0.8))))) {
                    var result = q.Execute();
                    Console.WriteLine($"Number of rows: {result.Count()}");
                }
                // end::predictive-query[]
            }
        }

        static void Main(string[] args)
        {
            // This only needs to be done once for whatever platform the executable is running
            // (UWP, iOS, Android, or desktop)
            Couchbase.Lite.Support.NetDesktop.Activate();

            CreateNewDatabase();
            CreateDocument();
            UpdateDocument();
            UseTypedAccessors();
            DoBatchOperation();
            UseBlob();
            SelectMeta();

            LoadPrebuilt();
            CreateIndex();
            SelectWhere();
            UseCollectionContains();
            SelectLike();
            SelectWildcardLike();
            SelectWildcardCharacterLike();
            SelectRegex();
            SelectJoin();
            GroupBy();
            OrderBy();

            CreateFullTextIndex();
            FullTextSearch();
            StartReplication();
            SetupReplicatorListener();

            _Replicator.Stop();
            while (_Replicator.Status.Activity != ReplicatorActivityLevel.Stopped) {
                // Database cannot close until replicators are stopped
                Console.WriteLine($"Waiting for replicator to stop (currently {_Replicator.Status.Activity})...");
                Thread.Sleep(200);
            }

            _Database.Close();
        }

        #endregion
    }

    /* ----------------------------------------------------------- */
    /* ---------------------  ACTIVE SIDE  ----------------------- */
    /* ---------------  stubs for documentation  ----------------- */
    /* ----------------------------------------------------------- */

    class ActivePeer : IMessageEndpointDelegate
    {
        ActivePeer()
        {
            var id = "";

            // tag::message-endpoint[]
            var database = new Database("dbname");

            // The delegate must implement the `IMessageEndpointDelegate` protocol.
            var messageEndpointTarget = new MessageEndpoint(uid: "UID:123", target: "",
                protocolType: ProtocolType.MessageStream, delegateObject: this);
            // end::message-endpoint[]

            // tag::message-endpoint-replicator[]
            var config = new ReplicatorConfiguration(database, messageEndpointTarget);

            // Create the replicator object
            var replicator = new Replicator(config);
            // Start the replicator
            replicator.Start();
            // end::message-endpoint-replicator[]
        }

        // tag::create-connection[]
        /* implementation of MessageEndpointDelegate */
        public IMessageEndpointConnection CreateConnection(MessageEndpoint endpoint)
        {
            var connection = new ActivePeerConnection(); /* implements MessageEndpointConnection */
            return connection;
        }
        // end::create-connection[]
    }

    class ActivePeerConnection : IMessageEndpointConnection
    {
        private IReplicatorConnection _replicatorConnection;

        public void Disconnect()
        {
            // tag::active-replicator-close[]
            _replicatorConnection?.Close(null);
            // end::active-replicator-close[]
        }

        public void Receive(byte[] data)
        {
            // tag::active-peer-receive[]
            var message = Message.FromBytes(data);
            _replicatorConnection?.Receive(message);
            // end::active-peer-receive[]
        }

        // tag::active-peer-close[]
        /* implementation of MessageEndpointConnection */
        public async Task Close(Exception error)
        {
            // await socket.Close, etc (or do nothing if already closed)
            // throw MessagingException if something goes wrong (though
            // since it is "close" nothing special will happen)
        }
        // end::active-peer-close[]

        // tag::active-peer-open[]
        /* implementation of MessageEndpointConnection */
        public async Task Open(IReplicatorConnection connection)
        {
            _replicatorConnection = connection;
            // await socket.Open(), etc
            // throw MessagingException if something goes wrong
        }
        // end::active-peer-open[]

        // tag::active-peer-send[]
        /* implementation of MessageEndpointConnection */
        public async Task Send(Message message)
        {
            var data = message.ToByteArray();
            // await Socket.Send(), etc
            // throw MessagingException if something goes wrong
        }
        // end::active-peer-send[]
    }

    /* ----------------------------------------------------------- */
    /* ---------------------  PASSIVE SIDE  ---------------------- */
    /* ---------------  stubs for documentation  ----------------- */
    /* ----------------------------------------------------------- */
    class PassivePeerConnection : IMessageEndpointConnection
    {
        private MessageEndpointListener _messageEndpointListener;
        private IReplicatorConnection _replicatorConnection;

        public void StartListener()
        {
            // tag::listener[]
            var database = new Database("mydb");
            var config = new MessageEndpointListenerConfiguration(database, ProtocolType.MessageStream);
            _messageEndpointListener = new MessageEndpointListener(config);
            // end::listener[]
        }

        public void StopListener()
        {
            // tag::passive-stop-listener[]
            _messageEndpointListener?.CloseAll();
            // end::passive-stop-listener[]
        }

        public void AcceptConnection()
        {
            // tag::advertizer-accept[]
            var connection = new PassivePeerConnection(); /* implements MessageEndpointConnection */
            _messageEndpointListener?.Accept(connection);
            // end::advertizer-accept[]
        }

        public void Disconnect()
        {
            // tag::passive-replicator-close[]
            _replicatorConnection?.Close(null);
            // end::passive-replicator-close[]
        }

        public void Receive(byte[] data)
        {
            // tag::passive-peer-receive[]
            var message = Message.FromBytes(data);
            _replicatorConnection?.Receive(message);
            // end::passive-peer-receive[]
        }

        // tag::passive-peer-close[]
        /* implementation of MessageEndpointConnection */
        public async Task Close(Exception error)
        {
            // await socket.Close, etc (or do nothing if already closed)
            // throw MessagingException if something goes wrong (though
            // since it is "close" nothing special will happen)
        }
        // end::passive-peer-close[]

        // tag::passive-peer-open[]
        /* implementation of MessageEndpointConnection */
        public Task Open(IReplicatorConnection connection)
        {
            _replicatorConnection = connection;
            // socket should already be open on the passive side
            return Task.FromResult(true);
        }
        // end::passive-peer-open[]

        // tag::passive-peer-send[]
        /* implementation of MessageEndpointConnection */
        public async Task Send(Message message)
        {
            var data = message.ToByteArray();
            // await Socket.Send(), etc
            // throw MessagingException if something goes wrong
        }
        // end::passive-peer-send[]
    }

    // tag::predictive-model[]
    // `TensorFlowModel` is a fake implementation
    // this would be the implementation of the ml model you have chosen
    class TensorFlowModel
    {
        public static IDictionary&lt;string, object&gt; PredictImage(byte[] data)
        {
            // Do calculations, etc
            return null;
        }
    }

    class ImageClassifierModel : IPredictiveModel
    {
        public DictionaryObject Predict(DictionaryObject input)
        {
            var blob = input.GetBlob("photo");
            if (blob == null) {
                return null;
            }

            var imageData = blob.Content;
            // `TensorFlowModel` is a fake implementation
            // this would be the implementation of the ml model you have chosen
            var modelOutput = TensorFlowModel.PredictImage(imageData);
            return new MutableDictionaryObject(modelOutput); <i class="conum" data-value="1"></i><b>(1)</b>
        }
    }
    // end::predictive-model[]

    // tag::custom-logging[]
    private class LogTestLogger : ILogger
    {
        public LogLevel Level { get; set; }

        public void Reset()
        {
            _lines.Clear();
        }

        public void Log(LogLevel level, LogDomain domain, string message)
        {
            // handle the message, for example piping it to
            // a third party framework
        }
    }
    // end::custom-logging[]

    // tag::local-win-conflict-resolver[]
    class LocalWinConflictResolver : IConflictResolver
    {
        Document Resolve(Conflict conflict)
        {
            return conflict.LocalDocument;
        }
    }
    // end::local-win-conflict-resolver[]

    // tag::remote-win-conflict-resolver[]
    class RemoteWinConflictResolver : IConflictResolver
    {
        public Document Resolve(Conflict conflict)
        {
            return conflict.RemoteDocument;
        }
    }
    // end::remote-win-conflict-resolver[]

    // tag::merge-conflict-resolver[]
    class MergeConflictResolver : IConflictResolver
    {
        public Document Resolve(Conflict conflict)
        {
            var localDict = conflict.LocalDocument.ToDictionary();
            var remoteDict = conflict.RemoteDocument.ToDictionary();
            var result = localDict.Concat(remoteDict)
               .GroupBy(kv =&gt; kv.Key)
               .ToDictionary(g =&gt; g.Key, g =&gt; g.First().Value);
            return new MutableDocument(conflict.DocumentID, result);
        }
    }
    // end::merge-conflict-resolver[]


// N1QL QUERY


  public  List&lt;Result&gt; testN1QLQueryString (Database argDB)
  {
      // For Documentation
      DatabaseConfiguration dbCfg = new DatabaseConfiguration();
      dbCfg.Directory =
          Path.Combine(Service.GetInstance&lt;IDefaultDirectoryResolver&gt;().DefaultDirectory(), username);
      // tag::query-syntax-n1ql[]
      Database thisDb = new Database(dbName, dbCfg);

      var thisQuery =
          thisDb.CreateQuery(
              "SELECT META().id AS thisId FROM $thisDb.name " +
              "WHERE type = $type"); <i class="conum" data-value="22"></i><b>(22)</b>

      thisQuery.Parameters.SetString("type", "hotel"); <i class="conum" data-value="23"></i><b>(23)</b>

      var results = thisQuery.Execute().AllResults();

      return results;
      // end::query-syntax-n1ql[]
  }

    // tag::query-syntax-n1ql-params[]
    tbd
    // end::query-syntax-n1ql-params[]

    // tag::query-access-n1ql[]
    tbd
    // end::query-access-n1ql[]


// QUERY RESULT SET HANDLING EXAMPLES

    public static void testQuerySyntaxAll()
    {
        // For Documentation
        var dbName = "travel-sample";

        string thisDocsId;
        string thisDocsName;
        string thisDocsType;
        string thisDocsCity;
        Dictionary&lt;string,object&gt; hotel = new Dictionary&lt;string,object&gt;();

        // tag::query-syntax-all[]
        var this_Db = new Database("hotels") ;

        var query = QueryBuilder
              .Select(SelectResult.All())
              .From(DataSource.Database(this_Db));

        // end::query-syntax-all[]

        // tag::query-access-all[]
        var results = query.Execute().AllResults();

        if (results?.Count &gt; 0)
        {
            List&lt;Dictionary&lt;string,object&gt;&gt; hotels = new List&lt;Dictionary&lt;string,object&gt;&gt;();
            foreach (var result in results)
            {
                // get the result into our dictionary object
                var thisDocsProps = result.GetDictionary(dbName); <i class="conum" data-value="24"></i><b>(24)</b>

                if (thisDocsProps != null)
                {
                    thisDocsId = thisDocsProps.GetString("id"); <i class="conum" data-value="25"></i><b>(25)</b>
                    thisDocsName = thisDocsProps.GetString("name");
                    thisDocsCity = thisDocsProps.GetString("city");
                    thisDocsType = thisDocsProps.GetString("type");
                    hotel = thisDocsProps.ToDictionary();
                    hotels.Add(hotel);
                }

            }
        }
        // end::query-access-all[]

    // tag::query-access-json[]

    foreach (var result in query.Execute().AsEnumerable()) {

        // get the result into a JSON String
                var thisDocsJSONString = result.ToJSON();<i class="conum" data-value="26"></i><b>(26)</b>

        // Get a native dictionary object using the JSON string
        var dictFromJSONstring =
              JsonConvert.
                DeserializeObject&lt;Dictionary&lt;string, object&gt;&gt;
                  (thisDocsJSONString); <i class="conum" data-value="27"></i><b>(27)</b>

        // use the created dictionary
        if (dictFromJSONstring != null)
        {
            thisDocsId = dictFromJSONstring["id"].ToString();
            thisDocsName = dictFromJSONstring["name"].ToString();
            thisDocsCity = dictFromJSONstring["city"].ToString();
            thisDocsType = dictFromJSONstring["type"].ToString();
        }

        //Get a custom object using the JSON string
        Hotel this_hotel =
            JsonConvert.DeserializeObject&lt;Hotel&gt;(thisDocsJSONString); <i class="conum" data-value="28"></i><b>(28)</b>

        // Store this hotel object in a list of hotels
        hotels.Add(
            this_hotel.Id.ToString(),
                this_hotel);

    } // end foreach result
    // end::query-access-json[]
  }


    private static void testQuerySyntaxProps()
    {
        // For Documentation
        var dbName = "travel-sample";
        // var this_Db = new Database(dbName);

        string thisDocsName;
        string thisDocsType;
        string thisDocsCity;
        // tag::query-syntax-props[]
        var this_Db = new Database("hotels") ;

        Dictionary&lt;string, object&gt; hotel = new Dictionary&lt;string, object&gt;();

        List&lt;Dictionary&lt;string, object&gt;&gt; hotels = new List&lt;Dictionary&lt;string, object&gt;&gt;();

        var query = QueryBuilder.Select(
                SelectResult.Property("type"),
                SelectResult.Property("name"),
                SelectResult.Property("city")).From(DataSource.Database(this_Db));
        // end::query-syntax-props[]

        // tag::query-access-props[]
        var results = query.Execute().AllResults();
        foreach (var result in results)
        {

            // get the returned array of k-v pairs into a dictionary
            hotel = result.ToDictionary();

            // add hotel dictionary to list of hotel dictionaries
            hotels.Add(hotel);

            // use the properties of the returned array of k-v pairs directly
            thisDocsType = result.GetString("type");
            thisDocsName = result.GetString("name");
            thisDocsCity = result.GetString("city");

        }

    // end::query-access-props[]
    } // test-query-access-props



    private static void testQuerySyntaxCount()
    {
        // For Documentation
        var dbName = "travel-sample";
        // var this_Db = new Database(dbName);

        Dictionary&lt;string, object&gt; hotel = new Dictionary&lt;string, object&gt;();
        List&lt;Dictionary&lt;string, object&gt;&gt; hotels = new List&lt;Dictionary&lt;string, object&gt;&gt;();

        // tag::query-syntax-count-only[]
        var this_Db = new Database("hotels") ;

        var query =
          QueryBuilder
            .Select(SelectResult.Expression(Function.Count(Expression.All())).As("mycount")) <i class="conum" data-value="29"></i><b>(29)</b>
            .From(DataSource.Database(this_Db));

        // end::query-syntax-count-only[]


        // tag::query-access-count-only[]

        var results = query.Execute().AllResults();

        foreach (var result in results)
        {

            var numberOfDocs = result.GetInt("mycount"); <i class="conum" data-value="30"></i><b>(30)</b>

        }

        // end::query-access-count-only[]
    }




    private static void ibQueryForID()
    {

        // For Documentation
        var dbName = "travel-sample";
        // var this_Db = new Database(dbName);

        Dictionary&lt;string, object&gt; hotel = new Dictionary&lt;string, object&gt;();
        List&lt;Dictionary&lt;string, object&gt;&gt; hotels = new List&lt;Dictionary&lt;string, object&gt;&gt;();


        // tag::query-syntax-id[]
        var this_Db = new Database("hotels") ;

        var query = QueryBuilder
                .Select(SelectResult.Expression(Meta.ID).As("this_ID"))
                .From(DataSource.Database(this_Db));

        // end::query-syntax-id[]


        // tag::query-access-id[]
        var results = query.Execute().AllResults();
        foreach (var result in results)
        {

            var thisDocsID = result.GetString("this_ID"); <i class="conum" data-value="31"></i><b>(31)</b>
            var doc = this_Db.GetDocument(thisDocsID);
        }

        // end::query-access-id[]
    }


// tag::query-syntax-pagination-all[]
    private static void testQueryPagination()
    {
      // For Documentation
      var dbName = "travel-sample";
      // var this_Db = new Database(dbName);

    // tag::query-syntax-pagination[]
      var this_Db = new Database("hotels") ;

      var thisLimit = 20;
      var thisOffset = 0;

      // get a count of the number of docs matching the query
      var countQuery =
          QueryBuilder
              .Select(SelectResult.Expression(Function.Count(Expression.All())).As("mycount"))
              .From(DataSource.Database(this_Db));
      var numberOfDocs =
          countQuery.Execute().AllResults().ElementAt(0).GetInt("mycount");

      if (numberOfDocs &lt; thisLimit) {
          thisLimit = numberOfDocs;
      }

      while (thisOffset &lt; numberOfDocs)
      {
          var listQuery =
              QueryBuilder
                  .Select(SelectResult.All())
                  .From(DataSource.Database(this_Db))
                  .Limit(Expression.Int(thisLimit), Expression.Int(thisOffset)); <i class="conum" data-value="32"></i><b>(32)</b>

          foreach (var result in listQuery.Execute().AllResults())
          {
              // Display and or process query results batch

          }

          thisOffset = thisOffset + thisLimit;

      } // end while

// end::query-syntax-pagination[]
// end::query-syntax-pagination-all[]
    }

    // JSONAPIMETHODS



        public void JsonApiDocument()
        {

            // tag::tojson-document[]
            Database this_DB = new Database("travel-sample");
            Database newDb = new Database("ournewdb");

            // Get a document
            var thisDoc = this_Db.GetDocument("hotel_10025");

            // Get document data as JSON String
            var thisDocAsJsonString = thisDoc?.ToJSON(); <i class="conum" data-value="33"></i><b>(33)</b>

            // Get Json Object from the Json String
            JObject myJsonObj = JObject.Parse(thisDocAsJsonString);

            // Get Native Object (anhotel) from JSON String
            List&lt;Hotel&gt; thehotels = new List&lt;Hotel&gt;();

            Hotel anhotel = new Hotel();
            anhotel = JsonConvert.DeserializeObject&lt;Hotel&gt;(thisDocAsJsonString);
            thehotels.Add(anhotel);

            // Update the retrieved native object
            anhotel.Name = "A Copy of " + anhotel.Name;
            anhotel.Id = "2001";

            // Convert the updated object back to a JSON string
            var newJsonString = JsonConvert.SerializeObject(anhotel);

            // Update new document with JSOn String
            MutableDocument newhotel =
                new MutableDocument(anhotel.Id, newJsonString); <i class="conum" data-value="34"></i><b>(34)</b>

            foreach (string key in newhotel.ToDictionary().Keys)
            {
                System.Console.WriteLine("Data -- {0} = {1}",
                    key, newhotel.GetValue(key));
            }

            newDb.Save(newhotel);

            var thatDoc = newDb.GetDocument("2001").ToJSON(); <i class="conum" data-value="35"></i><b>(35)</b>
            System.Console.Write(thatDoc);

            // end::tojson-document[]


        //    // tag::tojson-document-output[]
        //    JSON String = { "description":"Very good and central","id":"1000","country":"France","name":"Hotel Ted","type":"hotel","city":"Paris"}
        //             type = hotel
        //             id = 1000
        //             country = France
        //             city = Paris
        //             description = Very good and central
        //             name = Hotel Ted
        //        // end::tojson-document-output[]
        //         */

        } // End JSONAPIDocument


    public void JsonApiArray()
        {
            // Init for docs
            //var this_Db = DataStore.getDbHandle();
            var ourdbname = "ournewdb";

            if (Database.Exists(ourdbname, "/"))
            {
                Database.Delete(ourdbname, "/");
            }

        // tag::tojson-array[]

            Database dbNew = new Database(ourdbname);

            // JSON String -- an Array (3 elements. including embedded arrays)
            var thisJSONstring = "[{'id':'1000','type':'hotel','name':'Hotel Ted','city':'Paris','country':'France','description':'Undefined description for Hotel Ted'},{'id':'1001','type':'hotel','name':'Hotel Fred','city':'London','country':'England','description':'Undefined description for Hotel Fred'},                        {'id':'1002','type':'hotel','name':'Hotel Ned','city':'Balmain','country':'Australia','description':'Undefined description for Hotel Ned','features':['Cable TV','Toaster','Microwave']}]".Replace("'", "\"");

            // Get JSON Array from JSON String
            JArray myJsonObj = JArray.Parse(thisJSONstring);

            // Create mutable array using JSON String Array
            var myArray = new MutableArrayObject();
            myArray.SetJSON(thisJSONstring);  <i class="conum" data-value="36"></i><b>(36)</b>


            // Create a new documenty for each array element
            for (int i = 0; i &lt; myArray.Count; i++)
            {
                var dict = myArray.GetDictionary(i);
                var docid = myArray[i].Dictionary.GetString("id");
                var newdoc = new MutableDocument(docid, dict.ToDictionary()); <i class="conum" data-value="37"></i><b>(37)</b>
                dbNew.Save(newdoc);
            }

            // Get one of the created docs and iterate through one of the embedded arrays
            var extendedDoc = dbNew.GetDocument("1002");
            var features = extendedDoc.GetArray("features");
            <i class="conum" data-value="38"></i><b>(38)</b>
            foreach (string feature in features) {
                System.Console.Write(feature);
                //process array item as required
            }
            var featuresJSON = extendedDoc.GetArray("features").ToJSON(); <i class="conum" data-value="39"></i><b>(39)</b>

            // end::tojson-array[]
        }


        public void JsonApiDictionary()
        {

            var ourdbname = "ournewdb";

            if (Database.Exists(ourdbname, "/"))
            {
                Database.Delete(ourdbname, "/");
            }
            Database dbNew = new Database(ourdbname);

            // tag::tojson-dictionary[]

            // Get dictionary from JSONstring
            var aJSONstring = "{'id':'1002','type':'hotel','name':'Hotel Ned','city':'Balmain','country':'Australia','description':'Undefined description for Hotel Ned','features':['Cable TV','Toaster','Microwave']}".Replace("'", "\"");
            var myDict = new MutableDictionaryObject(json: aJSONstring); <i class="conum" data-value="40"></i><b>(40)</b>

            // use dictionary to get name value
            var name = myDict.GetString("name");


            // Iterate through keys
            foreach (string key in myDict.Keys)
            {
                System.Console.WriteLine("Data -- {0} = {1}", key, myDict.GetValue(key).ToString());

            }
            // end::tojson-dictionary[]

            /*
            // tag::tojson-dictionary-output[]

                mono-stdout: Data -- id = 1002
                mono-stdout: Data -- type = hotel
                mono-stdout: Data -- name = Hotel Ned
                mono-stdout: Data -- city = Balmain
                mono-stdout: Data -- country = Australia
                mono-stdout: Data -- description = Undefined description for Hotel Ned
                mono-stdout: Data -- features = Couchbase.Lite.MutableArrayObject

            // end::tojson-dictionary-output[]
            */
        } /* end of func */


         public void JsonApiBlob()
        {
            // Init
            var ourpath = DataStore.getUserFolder();
            var ourdbname = "ournewdb";
            var userName = "ian";
            //ourpath = Path.Combine(ourpath,userName);

            if (Database.Exists(ourdbname, ourpath))
            {
                Database.Delete(ourdbname, ourpath);
            }
            var dbCfg = new DatabaseConfiguration();
            dbCfg.Directory=ourpath;
            Database dbNew = new Database(ourdbname,dbCfg);

            // tag::tojson-blob[]

            // Initialize base document for blob from a JSON string
            var docId = "1002";
            var aJSONstring = "{'ref':'hotel_1002','type':'hotel','name':'Hotel Ned'," +
                "'city':'Balmain','country':'Australia'," +
                "'description':'Undefined description for Hotel Ned'," +
                "'features':['Cable TV','Toaster','Microwave']}".Replace("'", "\"");
            var myDoc = new MutableDocument(docId, aJSONstring); <i class="conum" data-value="41"></i><b>(41)</b>


            // Get the content (an image), create blob and add to doc)
            var defaultDirectory =
                Path.Combine(Service.GetInstance&lt;IDefaultDirectoryResolver&gt;()
                            .DefaultDirectory(),
                                userName);
            var myImagePath = Path.Combine(defaultDirectory, "avatarimage.jpg");
            var myImageUri = new Uri(myImagePath.ToString());
            var myBlob = new Blob("image/jpg", myImageUri); <i class="conum" data-value="42"></i><b>(42)</b>
            myDoc.SetBlob("avatar", myBlob); <i class="conum" data-value="43"></i><b>(43)</b>


            // This example generates a 'blob not saved' exception
            try { Console.WriteLine("myBlob (unsaved) as JSON = {0}", myBlob.ToJSON());}
                catch (Exception e)
                    {Console.WriteLine("Exception = {0}", e.Message);}

            dbNew.Save(myDoc);

            // Alternatively -- depending on use case
            dbNew.SaveBlob(new Blob("image/jpg", myImageUri)); <i class="conum" data-value="44"></i><b>(44)</b>


            // Retrieve saved doc, get blob as JSON andheck its still a 'blob'
            var sameDoc = dbNew.GetDocument(docId);
            var reconstitutedBlob = new MutableDictionaryObject().
                SetDictionary("blobCOPY", new MutableDictionaryObject(sameDoc.GetBlob("avatar").ToJSON())); <i class="conum" data-value="45"></i><b>(45)</b>

            if (Blob.IsBlob(
                    reconstitutedBlob.GetDictionary("blobCOPY").ToDictionary()))  <i class="conum" data-value="46"></i><b>(46)</b>
            {
               //... process accordingly
               Console.WriteLine("Its a Blob!!");
            }

            // end::tojson-blob[]
            var datavalue = "";
            foreach (string key in myDoc.Keys)
            {
                if (key == "features")
                {
                    datavalue = "features are: ";
                    foreach (string item in myDoc.GetArray(key))
                    {
                        datavalue = datavalue + ", " + item;
                    }
                }
                else if (key == "avatar")
                {
                    datavalue = sameDoc.GetBlob(key).ToJSON();
                }
                else
                {
                    datavalue = sameDoc.GetValue(key).ToString();
                }

                System.Console.WriteLine(" Data -- {0} = {1}", key, datavalue);
            }

            // System.Console.WriteLine(" reconstitutedBlob = {0}", reconstitutedBlob.GetDictionary("blobCOPY").ToJSON());



            //}

            /*
            // tag::tojson-blob-output[]


                Exception = Missing Digest Due To Blob Is Not Saved To Database yet.

                Data -- id = 1002
                Data -- type = hotel
                Data -- name = Hotel Ned
                Data -- city = Balmain
                Data -- country = Australia
                Data -- description = Undefined description for Hotel Ned
                Data -- features = features are: , Cable TV, Toaster, Microwave
                Data -- avatar = {"digest":"sha1-sdCxeOeP3IZV4FEvVVlvtulpWA8=","length":2975,"content_type":"image/jpg","@type":"blob"}

                blobAsJSONstring = {"digest":"sha1-sdCxeOeP3IZV4FEvVVlvtulpWA8=","length":2975,"content_type":"image/jpg","@type":"blob"}

            // end::tojson-blob-output[]
            */
        } /* end of func */




  } // end of class



// p2p sync items


// tag::listener-simple[]
var thisConfig = new URLEndpointListenerConfiguration(thisDB); <i class="conum" data-value="47"></i><b>(47)</b>

thisConfig.Authenticator =
  new ListenerPasswordAuthenticator(
    (sender, username, password) =&gt;
      {
      return username.equals("valid.user")  &amp;&amp; (password == validPassword);
      }
  ); <i class="conum" data-value="48"></i><b>(48)</b>

_thisListener = new URLEndpointListener(thisConfig); <i class="conum" data-value="49"></i><b>(49)</b>

_thisListener.Start(); <i class="conum" data-value="50"></i><b>(50)</b>

// end::listener-simple[]



// tag::replicator-simple[]
var theListenerEndpoint = new URLEndpoint("wss://listener.com:4984/otherDB"); <i class="conum" data-value="51"></i><b>(51)</b>

var thisConfig = new ReplicatorConfiguration(thisDB, theListenerEndpoint); <i class="conum" data-value="52"></i><b>(52)</b>

thisConfig.AcceptOnlySelfSignedServerCertificate = true; <i class="conum" data-value="53"></i><b>(53)</b>

thisConfig.Authenticator =
  new BasicAuthenticator("valid.user", "valid.password.string"); <i class="conum" data-value="54"></i><b>(54)</b>

var thisReplicator = new Replicator(thisConfig); <i class="conum" data-value="55"></i><b>(55)</b>

thisReplicator.Start(); <i class="conum" data-value="56"></i><b>(56)</b>

// end::replicator-simple[]







// PASSIVE PEER STUFF
// Stuff I adapted
//
//
// p2pSync-websockets.cs
//
// Copyright (c) 2017 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Cryptography.X509Certificates;
using System.Threading;
using System.Threading.Tasks;

using Couchbase.Lite;
using Couchbase.Lite.Enterprise.Query;
using Couchbase.Lite.Logging;
using Couchbase.Lite.P2P;
using Couchbase.Lite.Query;
using Couchbase.Lite.Sync;
using Newtonsoft.Json;

using SkiaSharp;
namespace api_walkthrough
{
  class Program
  {
  private static Database _Database;
  private static Replicator _Replicator;
  private static ListenerToken _thisListenerToken;
  private static bool _NeedsExtraDocs;

  #region Private Methods
  private static void GettingStarted()
  {
    // tag::listener-initialize[]

    // tag::listener-config-db[]
    // Initialize the listener config
    var thisConfig = new URLEndpointListenerConfiguration(thisDB); <i class="conum" data-value="57"></i><b>(57)</b>

    // end::listener-config-db[]
    // tag::listener-config-port[]
    thisConfig.Port = 55990; <i class="conum" data-value="58"></i><b>(58)</b>

    // end::listener-config-port[]
    // tag::listener-config-netw-iface[]
    thisConfig.NetworkInterface = "10.1.1.10"; <i class="conum" data-value="59"></i><b>(59)</b>

    // end::listener-config-netw-iface[]
    // tag::listener-config-delta-sync[]
    thisConfig.EnableDeltaSync = true; <i class="conum" data-value="60"></i><b>(60)</b>

    // end::listener-config-delta-sync[]
    // tag::listener-config-tls-full[]
    // tag::listener-config-tls-enable[]
    thisConfig.DisableTLS = false; <i class="conum" data-value="61"></i><b>(61)</b>

    // end::listener-config-tls-enable[]
    // tag::listener-config-tls-id-anon[]
    // Use an Anonymous Self-Signed Cert
    thisConfig.TlsIdentity = null; <i class="conum" data-value="62"></i><b>(62)</b>

    // end::listener-config-tls-id-anon[]
    // tag::listener-config-client-auth-pwd[]
    // Configure the client authenticator
    // Here we are using Basic Authentication) <i class="conum" data-value="63"></i><b>(63)</b>
    SecureString validPassword =  new SecureString(); /* example only */
    // Get SecureString input for validPassword
    var validUser = "valid.username";
    thisConfig.Authenticator = new ListenerPasswordAuthenticator(
      (sender, validUser, validPassword) =&gt;
        {
          return username.equals(validUser)  &amp;&amp; password == validPassword);
        }
      );

    // end::listener-config-client-auth-pwd[]
    // tag::listener-start[]
    // Initialize the listener
    _thisListener = new URLEndpointListener(thisConfig); <i class="conum" data-value="64"></i><b>(64)</b>

    // Start the listener
    thisListener.Start(); <i class="conum" data-value="65"></i><b>(65)</b>

    // end::listener-start[]
    // end::listener-initialize[]
  }

  // tag::old-listener-config-tls-disable[]
  thisConfig.disableTLS = true;
  // end::old-listener-config-tls-disable[]

  // tag::listener-config-tls-id-nil-2[]

  // Use anonymous cert. These are self signed certs created by the system
  thisConfig.TlsIdentity = null;
  // end::listener-config-tls-id-nil-2[]


  // tag::old-listener-config-delta-sync[]
  thisConfig.EnableDeltaSync = true;
  // end::old-listener-config-delta-sync[]


  // tag::listener-status-check[]
  int connectionCount = thisListener.Status.ConnectionCount; <i class="conum" data-value="66"></i><b>(66)</b>
  int activeConnectionCount = thisListener.Status.ActiveConnectionCount;  <i class="conum" data-value="67"></i><b>(67)</b>

  // end::listener-status-check[]


  // tag::listener-stop[]
  thisListener.Stop();

  // end::listener-stop[]

// Additional snippets


// tag::listener-get-network-interfaces[]
foreach(NetworkInterface ni in NetworkInterface.GetAllNetworkInterfaces())
{
  if(ni.NetworkInterfaceType == NetworkInterfaceType.Wireless80211 ||
      ni.NetworkInterfaceType == NetworkInterfaceType.Ethernet)
  {
    // do something with the interface(s)
  }
}

// end::listener-get-network-interfaces[]


// tag::listener-get-url-list[]
var thisConfig = new URLEndpointListenerConfiguration(thisDB);
_thisListener = new URLEndpointListener(thisConfig);

_thisListener.Start();

 Console.WriteLine("URLS are {0} ", thisListener.Urls;

// end::listener-get-url-list[]

    // tag::listener-config-tls-disable[]
    thisConfig.DisableTLS = true; <i class="conum" data-value="68"></i><b>(68)</b>

    // end::listener-config-tls-disable[]

    // tag::listener-local-db[]
    // . . . preceding application logic . . .
    // Get the database (and create it if it doesn't exist)
    var thisDB = new Database("mydb");

    // end::listener-local-db[]

    // tag::listener-config-tls-id-full[]
    // tag::listener-config-tls-id-caCert[]
    // Use CA Cert
    // Create a TLSIdentity from an imported key-pair
    // . . . previously declared variables include ...
    TLSIdentity thisIdentity;
    X509Store _store =
      new X509Store(StoreName.My); // create and label x509 store

    // Get keys and certificates from PKCS12 data
    byte[] thisIdData =
      File.ReadAllBytes("c:client.p12"); <i class="conum" data-value="69"></i><b>(69)</b>
    // . . . other user code . . .

    // tag::import-tls-identity[]
    thisIdentity = TLSIdentity.ImportIdentity(
      _store,
      thisIdData, <i class="conum" data-value="70"></i><b>(70)</b>
      "123", // Password to access certificate data
      "couchbase-demo-cert",
      null); // Label to get cert in certificate map
        // NOTE: If a null label is supplied then the same
        // default directory for a Couchbase Lite database
        // is used for map.

    // end::import-tls-identity[]
    // end::listener-config-tls-id-caCert[]

    // tag::listener-config-tls-id-anon[]
    // Use an Anonymous Self-Signed Cert
    thisConfig.TlsIdentity = null; <i class="conum" data-value="71"></i><b>(71)</b>

    // end::listener-config-tls-id-anon[]
    // tag::listener-config-tls-id-set[]
    // Set the TLS Identity
    thisConfig.TlsIdentity = thisIdentity; <i class="conum" data-value="72"></i><b>(72)</b>

    // end::listener-config-tls-id-set[]
    // end::listener-config-tls-id-full[]

    // tag::listener-config-client-auth-root[]
    // Configure the client authenticator
    // to validate using ROOT CA

    // Get the valid cert chain, in this instance from
    // PKCS12 data containing private key, public key
    // and certificates <i class="conum" data-value="73"></i><b>(73)</b>
    var clientData = File.ReadAllBytes("c:client.p12");
    var ourCaData = File.ReadAllBytes("c:client-ca.der");

    // Get the root certs from the data
    var thisRootCert = new X509Certificate2(ourCaData); <i class="conum" data-value="74"></i><b>(74)</b>

    // Configure the authenticator to use the root certs
    var thisAuth = new ListenerCertificateAuthenticator(new X509Certificate2Collection(thisRootCert));

    thisConfig.Authenticator = thisAuth; <i class="conum" data-value="75"></i><b>(75)</b>

    // Initialize the listener using the config
    _listener = new URLEndpointListener(thisConfig);

    // end::listener-config-client-auth-root[]
    // tag::listener-config-client-auth-lambda[]
    // Configure the client authenticator
    // to validate using application logic

    // Get the valid cert chain, in this instance from
    // PKCS12 data containing private key, public key
    // and certificates <i class="conum" data-value="76"></i><b>(76)</b>
    clientData = File.ReadAllBytes("c:client.p12");
    ourCaData = File.ReadAllBytes("c:client-ca.der");

    // Get the root certs from the data
    var thisRootCert = new X509Certificate2(ourCaData);

    // Configure the authenticator to pass the root certs
    // To a user supplied code block for authentication
    var thisAuth =
      new ListenerCertificateAuthenticator(
        new X509Certificate2Collection(thisRootCert) =&gt; {
          // . . . user supplied code block
          // . . . returns boolean value (true=authenticated)
        }); <i class="conum" data-value="77"></i><b>(77)</b>

    thisConfig.Authenticator = thisAuth; <i class="conum" data-value="78"></i><b>(78)</b>

    // end::listener-config-client-auth-lambda[]



// END Additional






// Listener Callouts

// tag::listener-callouts-full[]

  // tag::listener-start-callouts[]
  &lt;.&gt; Initialize the listener instance using the configuration settings.
  &lt;.&gt; Start the listener, ready to accept connections and incoming data from active peers.
  // end::listener-start-callouts[]


  // tag::listener-status-check-callouts[]

  &lt;.&gt; `connectionCount` -- the total number of connections served by the listener
  &lt;.&gt; `activeConnectionCount` -- the number of active (BUSY) connections currently being served by the listener
  //
  // end::listener-status-check-callouts[]

// tag::listener-config-tls-id-caCert-callouts[]
  &lt;.&gt; Ensure TLS is enabled.
  &lt;.&gt; The identity will be stored in the secure storage using the given label
  &lt;.&gt; PKCS12 data containing private key, public key, and certificates
  &lt;.&gt; The key pair as stored in the byte array
  &lt;.&gt; The password required to access the certificate data
  &lt;.&gt; The key label assigned to the cert in certificate map and used for retrieval
  &lt;.&gt; If null, the same default directory for a Couchbase Lite database is used for map
  &lt;.&gt; Use the TLSIdentity `thisIdentity.`

// end::listener-config-tls-id-caCert-callouts[]

  // tag::listener-config-tls-id-SelfSigned-callouts[]
  &lt;.&gt; Ensure TLS is enabled.
  &lt;.&gt; The identity will be stored in the secure storage using the given label
  &lt;.&gt; When creating a certificate, the common name attribute is required to create a CSR. If the common name is not present in the certificate an exception is thrown.
  &lt;.&gt; If the expiration date is not specified, the expiration date of the certificate is 365 days after creation
  &lt;.&gt; The key label to get cert in certificate map
  &lt;.&gt; If null, the same default directory for a Couchbase Lite database is used for map
  &lt;.&gt; Use the TLSIdentity `thisIdentity.`

  // end::listener-config-tls-id-SelfSigned-callouts[]

// end::listener-callouts-full[]








// tag::old-listener-config-client-auth-root[]
  // cert is a pre-populated object of type:SecCertificate representing a certificate
  // Work in progress. Code snippet to be provided.

  // end::old-listener-config-client-auth-root[]


  // prev content of listener-config-client-auth-self-signed (for ios)
  thisConfig.authenticator = ListenerCertificateAuthenticator.init {
    (cert) -&gt; Bool in
    var cert:SecCertificate
    var certCommonName:CFString?
    let status=SecCertificateCopyCommonName(cert, &amp;certCommonName)
    if (self._allowlistedUsers.contains(["name": certCommonName! as String])) {
      return true
    }
    return false
  }
  // tag::spare-listener-config-client-auth-self-signed[]
  // Work in progress. Code snippet to be provided.

  // end::spare-listener-config-client-auth-self-signed[]

// tag::p2p-ws-api-urlendpointlistener[]
public class URLEndpointListener {
    // Properties <i class="conum" data-value="1"></i><b>(1)</b>
    public let config: URLEndpointListenerConfiguration
    public let port UInt16?
    public let tlsIdentity: TLSIdentity?
    public let urls: Array&lt;URL&gt;?
    public let status: ConnectionStatus?
    // Constructors <i class="conum" data-value="2"></i><b>(2)</b>
    public init(config: URLEndpointListenerConfiguration)
    // Methods <i class="conum" data-value="3"></i><b>(3)</b>
    public func start() throws
    public func stop()
}
// end::p2p-ws-api-urlendpointlistener[]


// tag::p2p-ws-api-urlendpointlistener-constructor[]
let config = URLEndpointListenerConfiguration.init(database: self.oDB)
thisConfig.port = tls ? wssPort : wsPort
thisConfig.disableTLS = !tls
thisConfig.authenticator = auth
self.listener = URLEndpointListener.init(config: config) <i class="conum" data-value="1"></i><b>(1)</b>
// end::p2p-ws-api-urlendpointlistener-constructor[]


// ACTIVE PEER STUFF
// Replication code
//
// Copyright (c) 2019 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

public class Examples {
  private static final String TAG = "EXAMPLE ACTIVE PEER";
  private static final String thisDBNAME = "local-database";
  private final Context context;
  // private Database database;
  // private Replicator replicator;

  public Examples(Context context) { this.context = context; }

  String user = "syncuser";
  String password = "sync9455";
  SecCertificate cert=null;
  String passivePeerEndpoint = "10.1.1.12:8920";
  String passivePeerPort = "8920";
  String passiveDbName = "userdb";
  Database thisDB;
  Replicator thisReplicator;
  ListenerToken replicatorListener;

  //@Test
  public void testActPeerSync() throws CouchbaseLiteException, URISyntaxException {
// tag::p2p-act-rep-func[]
    // . . . preceding code. for example . . .
    private static ListenerToken _thisListenerToken;
    var Database thisDB;
    // . . . other code . . .
    // tag::p2p-act-rep-initialize[]
    // initialize the replicator configuration

    var thisUrl = new URLEndpoint("wss://listener.com:4984/otherDB"); <i class="conum" data-value="79"></i><b>(79)</b>
    var config = new ReplicatorConfiguration(thisDB, thisUrl);

    // end::p2p-act-rep-initialize[]
    // tag::p2p-act-rep-config-type[]

    // Set replicator type
    thisConfig.ReplicatorType = ReplicatorType.PushAndPull;

    // end::p2p-act-rep-config-type[]
    // tag::p2p-act-rep-config-cont[]
    // Configure Sync Mode
    thisConfig.Continuous = true; // default value

    // end::p2p-act-rep-config-cont[]
    // tag::p2p-act-rep-config-self-cert[]
    // Configure Server Security -- only accept self-signed certs
    thisConfig.AcceptOnlySelfSignedServerCertificate = true; <i class="conum" data-value="80"></i><b>(80)</b>

    // end::p2p-act-rep-config-self-cert[]
    // Configure Client Security <i class="conum" data-value="81"></i><b>(81)</b>
    // tag::p2p-act-rep-auth[]
    // Configure basic auth using user credentials
    thisConfig.Authenticator = new BasicAuthenticator("Our Username", "Our Password");

    // end::p2p-act-rep-auth[]
    // tag::p2p-act-rep-config-conflict-full[]
    // tag::p2p-act-rep-config-conflict-builtin[]
    /* Optionally set a conflict resolver call back */ <i class="conum" data-value="82"></i><b>(82)</b>
    // Use built-in resolver
    thisConfig.ConflictResolver = new LocalWinConflictResolver();  //

    // end::p2p-act-rep-config-conflict-builtin[]
    // tag::p2p-act-rep-config-conflict-custom[]
    // optionally use custom resolver
    thisConfig.ConflictResolver = new ConflictResolver(
      (conflict) =&gt; {
        /* define resolver function */
      }
    ); //

    // end::p2p-act-rep-config-conflict-custom[]
    // end::p2p-act-rep-config-conflict-full[]
    // tag::p2p-act-rep-start-full[]
    // Initialize and start a replicator
    // Initialize replicator with configuration data
    var thisReplicator = new Replicator(thisConfig); <i class="conum" data-value="83"></i><b>(83)</b>

    // tag::p2p-act-rep-add-change-listener[]
    // tag::p2p-act-rep-add-change-listener-label[]
    //Optionally add a change listener <i class="conum" data-value="84"></i><b>(84)</b>
    // end::p2p-act-rep-add-change-listener-label[]
    _thisListenerToken =
      thisReplicator.AddChangeListener((sender, args) =&gt;
        {
          if (args.Status.Activity == ReplicatorActivityLevel.Stopped) {
              Console.WriteLine("Replication stopped");
          }
        });

    // end::p2p-act-rep-add-change-listener[]
    // tag::p2p-act-rep-start[]
    // Start replicator
    thisReplicator.Start(); <i class="conum" data-value="85"></i><b>(85)</b>

    // end::p2p-act-rep-start[]
// end::p2p-act-rep-start-full[]
// end::p2p-act-rep-func[]         ***** End p2p-act-rep-func
}

// Additional snippets

    // tag::p2p-act-rep-config-tls-full[]
    // tag::p2p-act-rep-config-cacert[]
    // Configure Server Security -- only accept CA certs
    thisConfig.AcceptOnlySelfSignedServerCertificate = false; <i class="conum" data-value="86"></i><b>(86)</b>

    // end::p2p-act-rep-config-cacert[]
    // tag::p2p-act-rep-config-pinnedcert[]

    // Return the remote pinned cert (the listener's cert)
    byte returnedCert = new byte(thisConfig.getPinnedCertificate()); // Get listener cert if pinned
    // end::p2p-act-rep-config-pinnedcert[]
    // Configure Client Security <i class="conum" data-value="87"></i><b>(87)</b>
    // tag::p2p-act-rep-auth[]
    // Configure basic auth using user credentials
    thisConfig.Authenticator = new BasicAuthenticator("Our Username", "Our Password");

    // end::p2p-act-rep-auth[]
    // end::p2p-act-rep-config-tls-full[]

    // tag::p2p-act-rep-config-cacert-pinned[]
    // Only CA Certs accepted
    thisConfig.AcceptOnlySelfSignedServerCertificate =
      false; <i class="conum" data-value="88"></i><b>(88)</b>

    var thisCert =
      new X509Certificate2(caData); <i class="conum" data-value="89"></i><b>(89)</b>

    thisConfig.PinnedServerCertificate =
      thisCert; <i class="conum" data-value="90"></i><b>(90)</b>

    // end::p2p-act-rep-config-cacert-pinned[]












    // Code to refactor
    Log.i(TAG, "The Replicator is currently " + thisReplicator.Status().getActivityLevel());

    Log.i(TAG, "The Replicator has processed " + t);

    if (thisReplicator.Status().getActivityLevel() == Replicator.ActivityLevel.BUSY) {
          Log.i(TAG, "Replication Processing");
          Log.i(TAG, "It has completed " + thisReplicator.Status().getProgess().getTotal() + " changes");
      }
    // tag::p2p-act-rep-status[]
    _thisReplicator.Stop();
    while (_thisReplicator.Status.Activity != ReplicatorActivityLevel.Stopped) {
        // Database cannot close until replicators are stopped
        Console.WriteLine($"Waiting for replicator to stop (currently {_thisReplicator.Status.Activity})...");
        Thread.Sleep(200);
    }
    _thisDatabase.Close();
    // end::p2p-act-rep-status[]

      // tag::p2p-act-rep-stop[]
      // Stop replication.
      thisReplicator.Stop(); <i class="conum" data-value="91"></i><b>(91)</b>
      // end::p2p-act-rep-stop[]


  }

{
  CouchbaseLite.init(context);
  Database thisDB = new Database("passivepeerdb");  <i class="conum" data-value="92"></i><b>(92)</b>
  // Initialize the listener config
  final URLEndpointListenerConfiguration thisConfig = new URLEndpointListenerConfiguration(database);
  thisConfig.Port(55990)             // &lt;.&gt; Default- port is selected
  thisConfig.DisableTls(false)       // &lt;.&gt; Optional. Defaults to false. You get TLS encryption out-of-box
  thisConfig.EnableDeltaSync(true)   // &lt;.&gt; Optional. Defaults to false.

  // Configure the client authenticator (if using basic auth)
  ListenerPasswordAuthenticator auth = new ListenerPasswordAuthenticator { "Our Username", "Our Password"}; <i class="conum" data-value="93"></i><b>(93)</b>
  thisConfig.Authenticator(auth); <i class="conum" data-value="94"></i><b>(94)</b>

  // Initialize the listener
  final URLEndpointListener listener = new URLEndpointListener( thisConfig ); <i class="conum" data-value="95"></i><b>(95)</b>

  // Start the listener
  listener.Start(); <i class="conum" data-value="96"></i><b>(96)</b>
    }


// tag::createTlsIdentity[]

Map&lt;String, String&gt; X509_ATTRIBUTES = mapOf(
           TLSIdentity.CERT_ATTRIBUTE_COMMON_NAME to "Couchbase Demo",
           TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION to "Couchbase",
           TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION_UNIT to "Mobile",
           TLSIdentity.CERT_ATTRIBUTE_EMAIL_ADDRESS to "noreply@couchbase.com"
       )

TLSIdentity thisIdentity = new TLSIdentity.createIdentity(true, X509_ATTRIBUTES, null, "test-alias");

// end::createTlsIdentity[]


// tag::p2p-tlsid-store-in-keychain[]
. . . work in progress - GetHashCode snippet to be provided
// end::p2p-tlsid-store-in-keychain[]

// tag::deleteTlsIdentity[]
// tag::p2p-tlsid-delete-id-from-keychain[]
TLSIdentity.DeleteIdentity(_store, "alias-to-delete", null);

// end::p2p-tlsid-delete-id-from-keychain[]
// end::deleteTlsIdentity[]

// tag::retrieveTlsIdentity[]
// OPTIONALLY:: Retrieve a stored TLS identity using its alias/label

TLSIdentity thisIdentity = new TLSIdentity.getIdentity("CBL-Demo-Server-Cert")
// end::retrieveTlsIdentity[]


    // Configure the client authenticator (if using Basic Authentication)
    // String validUser = new String("validUsername"); // an example username
    // String validPassword = new String("validPasswordValue"); // an example password

    // ListenerPasswordAuthenticator thisAuth = new ListenerPasswordAuthenticator( <i class="conum" data-value="97"></i><b>(97)</b>
    //   validUser, validPassword -&gt; validUser == "validUsername" &amp;&amp; validPassword == "validPasswordValue" );

    // if (thisAuth) {
    //   thisConfig.Authenticator(auth);
    // }
    // else {
    //   // . . . authentication failed take appropriate exception action
    //   return
    // };




    // tag::old-p2p-act-rep-add-change-listener[]
    ListenerToken thisListener = new thisReplicator.addChangeListener(change -&gt; { <i class="conum" data-value="98"></i><b>(98)</b>
      if (change.Status().getError() != null) {
        Log.i(TAG, "Error code ::  " + change.Status().getError().getCode());
      }
    });

    // end::old-p2p-act-rep-add-change-listener[]



// g u b b i n s
// tag::duff-p2p-tlsid-tlsidentity-with-label[]


    // Configure TLS Cert CA auth using key-stored cert id alias 'doc-sync-server'

    // TLSIdentity thisIdentity = new TLSIdentity.getIdentity("doc-sync-server"); // Get existing TLS ID from sec storage

    // ClientCertificateAuthenticator thisAuth = new ClientCertificateAuthenticator(thisIdentity);

    // thisConfig.Authenticator(thisAuth);



    // USE KEYCHAIN IDENTITY IF EXISTS
    // Check if Id exists in keychain. If so use that Id

    // STILL NEED TO REFACTOR

    do {
      if let thisIdentity = try TLSIdentity.identity(withLabel: "doco-sync-server") {
          print("An identity with label : doco-sync-server already exists in keychain")
          return thisIdentity
          }
    } catch
    {return nil}
    thisAuthenticator.ClientCertificateAuthenticator(identity: thisIdentity )
    thisConfig.thisAuthenticator

    // end::duff-p2p-tlsid-tlsidentity-with-label[]


// tag::old-deleteTlsIdentity[]

String thisAlias = "alias-to-delete";
KeyStore thisKeystore = KeyStore.getInstance("PKCS12"); <i class="conum" data-value="99"></i><b>(99)</b>
thisKeyStore.load= null;
if (thisAlias != null) {
   thisKeystore.deleteEntry(thisAlias);  <i class="conum" data-value="100"></i><b>(100)</b>
}

// end::old-deleteTlsIdentity[]


// cert auth
let rootCertData = SecCertificateCopyData(cert) as Data
let rootCert = SecCertificateCreateWithData(kCFAllocatorDefault, rootCertData as CFData)!
// Listener:
thisConfig.authenticator = ListenerCertificateAuthenticator.init (rootCerts: [rootCert])

SecCertificate thisCert = new SecCertificate(); // populated as nec.

Data rootCertData = new Data(SecCertificateCopyData(thisCert));

let rootCert = SecCertificateCreateWithData(kCFAllocatorDefault, rootCertData as CFData)!
// Listener:
thisConfig.authenticator = ListenerCertificateAuthenticator.init (rootCerts: [rootCert])
// cert auth


// C A L L O U T S

// tag::p2p-act-rep-config-cacert-pinned-callouts[]
&lt;.&gt; Configure to accept only CA certs
&lt;.&gt; Configure the pinned certificate using data from the byte array `cert`
&lt;.&gt; Set the certificate to be compared with that provided by the server
// end::p2p-act-rep-config-cacert-pinned-callouts[]

// tag::??p2p-tlsid-tlsidentity-with-label-callouts[]
&lt;.&gt; PKCS12 data containing private key, public key, and certificates
&lt;.&gt; This is the default value and means that TLS is enabled
// end::??p2p-tlsid-tlsidentity-with-label-callouts[]

// tag::p2p-tlsid-tlsidentity-with-label-callouts[]
&lt;.&gt; Refuse self-signed certificates
&lt;.&gt; Get the identity
&lt;.&gt; Set the Client Certificate Authenticator to require signed certificates with this identity

// end::p2p-tlsid-tlsidentity-with-label-callouts[]


    // tag::old-listener-config-client-root-ca[]
    // Configure the client authenticator
    // to validate using ROOT CA <i class="conum" data-value="101"></i><b>(101)</b>
    byte[] thisCaData; // byte array for CA data
    using (var thisReader = new BinaryReader(stream)) {
      thisCaData = thisReader.ReadBytes(int stream.Length);
    }; // Get cert data

    var thisRootCert = new X509Certificate(thisCaData); //

    thisConfig.Authenticator = new  ListenerCertificateAuthenticator(
      new X509Certificate2Collection(thisRootCert)
    );

    // end::old-listener-config-client-root-ca[]



        // tag::p2p-tlsid-tlsidentity-with-label-per-sam[]
    var db = new Database("other-database");
    _Database = db;
    X509Store _store = new X509Store(StoreName.My);
    TLSIdentity thisIdentity;

    // tag::client-cert-authenticator-root-certs[]

    // Configure the expected server-supplied
    // credentials -- only accept CA Certs
    thisConfig.AcceptOnlySelfSignedServerCertificate = false; <i class="conum" data-value="102"></i><b>(102)</b>

    // Client identity
    thisIdentity =
      TLSIdentity.ImportIdentity(_store,
        clientData,
        "123",
        "CBL-Client-Cert",
        null); <i class="conum" data-value="103"></i><b>(103)</b>

    thisConfig.Authenticator =
      new ClientCertificateAuthenticator(thisIdentity); <i class="conum" data-value="104"></i><b>(104)</b>

    // end::client-cert-authenticator-root-certs[]





    byte[] thisCaData, thisClientData;
    thisClientData = File.ReadAllBytes("C:\\client.p12"); <i class="conum" data-value="105"></i><b>(105)</b>
    thisCaData = File.ReadAllBytes("C:\\client-ca.der");

    // Root certs
    var thisRootCert = new X509Certificate2(thisCaData);
    var thisAuth =
      new ListenerCertificateAuthenticator(
        new X509Certificate2Collection(thisRootCert));

    // Create URL Endpoint Listener
    var thisConfig = new URLEndpointListenerConfiguration(_Database);
    thisConfig.DisableTLS = false; <i class="conum" data-value="106"></i><b>(106)</b>
    thisConfig.Authenticator = thisAuth;
    _listener = new URLEndpointListener(thisConfig);
    _listener.Start();

    // Client identity
    thisIdentity = TLSIdentity.ImportIdentity(_store,
        thisClientData,
        "123",
        "CBL-Client-Cert",
        null);

    // Replicator -- Client
    var database = new Database("client-database");
    var builder = new UriBuilder(
        "wss",
        "localhost",
        _listener.Port,
        $"/{_listener.thisConfig.Database.Name}"
    );

    var url = builder.Uri;
    var target = new URLEndpoint(url);
    var thisConfig = new ReplicatorConfiguration(database, target);
    thisConfig.ReplicatorType = ReplicatorType.PushAndPull;
    thisConfig.Continuous = false;
    thisConfig.Authenticator = new ClientCertificateAuthenticator(thisIdentity);
    thisConfig.AcceptOnlySelfSignedServerCertificate = true;
    thisConfig.PinnedServerCertificate = _listener.TlsIdentity.Certs[0];
    using (var replicator = new Replicator(thisConfig)) {
        replicator.Start();
    }





    // Stop listener after replicator is stopped
    _listener.Stop();

    // end::p2p-tlsid-tlsidentity-with-label-per-sam[]


        // tag::p2p-tlsid-tlsidentity-with-label[]
    // Client identity
    thisIdentity =
      TLSIdentity.ImportIdentity(_store,
        clientData,
        "123",
        "CBL-Client-Cert",
        null); <i class="conum" data-value="107"></i><b>(107)</b>

    thisConfig.Authenticator =
      new ClientCertificateAuthenticator(thisIdentity); <i class="conum" data-value="108"></i><b>(108)</b>

    // end::p2p-tlsid-tlsidentity-with-label[]


// For replications

// BEGIN -- snippets --
//    Purpose -- code samples for use in replication topic

// tag::sgw-repl-pull[]
public class MyClass
{
    public Database Database { get; set; }
    public Replicator Replicator { get; set; } <i class="conum" data-value="1"></i><b>(1)</b>

    public void StartReplication()
    {
        var url = new Uri("ws://localhost:4984/db"); <i class="conum" data-value="2"></i><b>(2)</b>
        var target = new URLEndpoint(url);
        var config = new ReplicatorConfiguration(Database, target)
        {
            ReplicatorType = ReplicatorType.Pull
        };

        Replicator = new Replicator(config);
        Replicator.Start();
    }
}

// end::sgw-repl-pull[]

// tag::sgw-repl-pull-callouts[]
&lt;1&gt; A replication is an asynchronous operation.
To keep a reference to the `replicator` object, you can set it as an instance property.
&lt;2&gt; The URL scheme for remote database URLs has changed in Couchbase Lite 2.0.
You should now use `ws:`, or `wss:` for SSL/TLS connections.
// end::sgw-repl-pull-callouts[]


    // tag::sgw-act-rep-initialize[]
    // initialize the replicator configuration

    var thisUrl = new URLEndpoint("wss://l10.0.2.2:4984/anotherDB"); <i class="conum" data-value="109"></i><b>(109)</b>
    var config = new ReplicatorConfiguration(thisDB, thisUrl);

    // end::sgw-act-rep-initialize[]</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>==== Session Authentication</p>
</div>
<div class="paragraph">
<p>Session authentication is another way to authenticate with Sync Gateway.
A user session must first be created through the <a href="../../../sync-gateway/current/rest-api.html#/session/post__db___session" class="page"><code>POST /{tkn-db}/_session</code></a> endpoint on the Public REST API.
The HTTP response contains a session ID which can then be used to authenticate as the user it was created for.</p>
</div>
<div class="paragraph">
<p><a href="#ex-session-auth">[ex-session-auth]</a> shows how to initiate a one-shot replication with the session ID that is returned from the <code>POST /{tkn-db}/_session</code> endpoint.</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">var url = new Uri("ws://localhost:4984/mydatabase");
var target = new URLEndpoint(url);
var config = new ReplicatorConfiguration(database, target);
config.Authenticator = new SessionAuthenticator("904ac010862f37c8dd99015a33ab5a3565fd8447");

var replicator = new Replicator(config);
replicator.Start();</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="lbl-repl-hdrs" class="paragraph">
<p>=== Custom&#160;Headers</p>
</div>
<div class="paragraph">
<p>Custom headers can be set on the configuration object.
And the replicator will send those header(s) in every request.
As an example, this feature can be useful to pass additional credentials when there is an authentication or authorization step being done by a proxy server (between Couchbase Lite and Sync Gateway).</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">var config = new ReplicatorConfiguration(database, target)
{
    Headers = new Dictionary&lt;string, string&gt;
    {
        ["CustomHeaderName"] = "Value"
    }
};</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="lbl-repl-fltrs" class="paragraph">
<p>=== Replication Filters</p>
</div>
<div class="paragraph">
<p>Replication Filters allow you to have quick control over which documents are stored as the result of a push and/or pull replication.</p>
</div>
<div class="paragraph">
<p>==== Push Filter</p>
</div>
<div class="paragraph">
<p>A push filter allows an app to push a subset of a database to the server, which can be very useful in some circumstances.
For instance, high-priority documents could be pushed first, or documents in a "draft" state could be skipped.</p>
</div>
<div class="paragraph">
<p>The following example filters out documents whose <code>type</code> property is equal to <code>draft</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">var config = new ReplicatorConfiguration(database, target)
{
    Headers = new Dictionary&lt;string, string&gt;
    {
        ["CustomHeaderName"] = "Value"
    }
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The callback should follow the semantics of a <a href="https://en.wikipedia.org/wiki/Pure_function" target="_blank" rel="noopener">pure function</a>.
Otherwise, long running functions would slow down the replicator considerably.
Furthermore, your callback should not make assumptions about what thread it is being called on.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>==== Pull Filter</p>
</div>
<div class="paragraph">
<p>A pull filter gives an app the ability to validate documents being pulled, and skip ones that fail.
This is an important security mechanism in a peer-to-peer topology with peers that are not fully trusted.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Pull replication filters are not a substitute for channels.
Sync Gateway <a href="../../../sync-gateway/current/channels.html" class="page">channels</a> are designed to be scalable (documents are filtered on the server) whereas a pull replication filter is applied to a document once it has been downloaded.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">var config = new ReplicatorConfiguration(database, target)
{
    Headers = new Dictionary&lt;string, string&gt;
    {
        ["CustomHeaderName"] = "Value"
    }
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The callback should follow the semantics of a <a href="https://en.wikipedia.org/wiki/Pure_function" target="_blank" rel="noopener">pure function</a>.
Otherwise, long running functions would slow down the replicator considerably.
Furthermore, your callback should not make assumptions about what thread it is being called on.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Losing access to a document (via the Sync Function) also triggers the pull replication filter.
Filtering out such an event would retain the document locally.
As a result, there would be a local copy of the document disjointed from the one that resides on Couchbase Server.
Further updates to the document stored on Couchbase Server would not be received in pull replications and further local edits could be potentially pushed, which would result in 409 errors since access has been revoked.
</td>
</tr>
</table>
</div>
<div id="lbl-repl-chan" class="paragraph">
<p>=== Channels</p>
</div>
<div class="paragraph">
<p>By default, Couchbase Lite gets all the channels to which the configured user account has access.
This behavior is suitable for most apps that rely on <a href="../../../sync-gateway/current/authentication-users.html" class="page">user authentication</a> and the <a href="../../../sync-gateway/current/sync-function.html" class="page">sync function</a> to specify which data to pull for each user.</p>
</div>
<div class="paragraph">
<p>Optionally, it&#8217;s also possible to specify a comma-separated list of channel names on Couchbase Lite&#8217;s replicator configuration object.
In this case, the replication from Sync Gateway will only pull documents tagged with those channels.</p>
</div>
<div id="lbl-repl-delta" class="paragraph">
<p>=== Delta Sync</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This is an <a href="https://www.couchbase.com/products/editions">Enterprise Edition</a> feature.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With Delta Sync <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>, only the changed parts of a Couchbase document are replicated.
This can result in significant savings in bandwidth consumption as well as throughput improvements, especially when network bandwidth is typically constrained.</p>
</div>
<div class="paragraph">
<p>Replications to a Server (for example, a Sync Gateway, or passive listener) automatically use delta sync if the property is enabled at database level by the server&#8201;&#8212;&#8201;see: <a href="#sync-gateway:ROOT:refer/config-properties.adoc#databases-foo_db-delta_sync" class="page unresolved">databases.$db.delta_sync.enabled</a>.</p>
</div>
<div class="paragraph">
<p><a href="dbreplica.html" class="page">Intra-device Data Sync</a> replications automatically <strong>disable</strong> delta sync, whilst <a href="p2psync-websocket.html" class="page">Peer-to-Peer</a> replications automatically <strong>enable</strong> delta sync.</p>
</div>
<div id="lbl-init-repl" class="paragraph">
<p>== Initialize</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">In this section</dt>
<dd>
<p><a href="#lbl-repl-start">[lbl-repl-start]</a>  | <a href="#lbl-repl-ckpt">[lbl-repl-ckpt]</a></p>
</dd>
</dl>
</div>
<div id="lbl-repl-start" class="paragraph">
<p>=== Start Replicator</p>
</div>
<div class="paragraph">
<p>Use the <code><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html">Replicator</a></code> class&#8217;s <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator__ctor_Couchbase_Lite_Sync_ReplicatorConfiguration_">(ReplicatorConfiguration config)</a> constructor, to initialize the replicator with the configuration you have defined.
You can, optionally, add a change listener (see <a href="#lbl-repl-mon">[lbl-repl-mon]</a>) before starting the replicator running using <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_Start">Start()</a>.</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">// Initialize and start a replicator
// Initialize replicator with configuration data
var thisReplicator = new Replicator(thisConfig); <i class="conum" data-value="1"></i><b>(1)</b>

// Start replicator
thisReplicator.Start(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initialize the replicator with the configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start the replicator</td>
</tr>
</table>
</div>
<div id="lbl-repl-ckpt" class="paragraph">
<p>=== Checkpoint Starts</p>
</div>
<div class="paragraph">
<p>Replicators use <a href="refer-glossary.html#checkpoint" class="page">checkpoints</a> to keep track of documents sent to the target database.
Without <a href="refer-glossary.html#checkpoint" class="page">checkpoints</a> , Couchbase Lite would replicate the entire database content to the target database on each connection, even though previous replications may already have replicated some or all of that content.</p>
</div>
<div class="paragraph">
<p>This functionality is generally not a concern to application developers.
However, if you do want to force the replication to start again from zero, use the <a href="refer-glossary.html#checkpoint" class="page">checkpoint</a> reset method <code>replicator.resetCheckpoint()</code> <strong>before</strong> starting the replicator.</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">// replicator is a Replicator instance
replicator.ResetCheckpoint();
replicator.Start();</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="lbl-repl-mon" class="paragraph">
<p>== Monitor</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">In this section</dt>
<dd>
<p><a href="#lbl-repl-chng">[lbl-repl-chng]</a>  |
<a href="#lbl-repl-status">[lbl-repl-status]</a>  |
<a href="#lbl-repl-evnts">[lbl-repl-evnts]</a> |
<a href="#lbl-repl-pend">[lbl-repl-pend]</a></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can monitor a replications status by using a combination of <a href="#lbl-repl-chng">[lbl-repl-chng]</a> and the <code>replication.status.activity</code> property&#8201;&#8212;&#8201;see; <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorStatus.html#Couchbase_Lite_Sync_ReplicatorStatus_Activity">Activity</a>.
This enables you to know, for example, when the replication is actively transferring data and when it has stopped.</p>
</div>
<div class="paragraph">
<p>You can also choose to monitor document changes&#8201;&#8212;&#8201;see: <a href="#lbl-repl-evnts">[lbl-repl-evnts]</a>.</p>
</div>
<div id="lbl-repl-chng" class="paragraph">
<p>== Change Listeners
Use this to monitor changes and to inform on sync progress; this is an optional step.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Best Practice</div>
You should register the listener before starting your replication, to avoid having to do a restart to activate it &#8230;&#8203; and don&#8217;t forget to save the token so you can remove the listener later
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use the <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html">Replicator</a> class to add a change listener as a callback to the Replicator (<a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_AddChangeListener_System_EventHandler_Couchbase_Lite_Sync_ReplicatorStatusChangedEventArgs__">addChangeListener()</a>)&#8201;&#8212;&#8201;see: <a href="#ex-repl-mon">[ex-repl-mon]</a>.
You will then be asynchronously notified of state changes.</p>
</div>
<div class="paragraph">
<p>Remove your change listener before stopping the replicator&#8201;&#8212;&#8201;use the <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_RemoveChangeListener_Couchbase_Lite_ListenerToken_">RemoveChangeListener(ListenerToken)</a> method to do this.</p>
</div>
<div id="lbl-repl-status" class="paragraph">
<p>== Replicator Status</p>
</div>
<div class="paragraph">
<p>You can use the <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html">Replicator</a> class&#8217;s <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_Status">Replicator.Status</a> property to check the replicator status.
That is, whether it is actively transferring data or if it has stopped&#8201;&#8212;&#8201;see: <a href="#ex-repl-mon">[ex-repl-mon]</a>.</p>
</div>
<div class="paragraph">
<p>The returned <em>ReplicationStatus</em> structure comprises:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorStatus.html#Couchbase_Lite_Sync_ReplicatorStatus_Activity">Activity</a>&#8201;&#8212;&#8201;stopped, offline, connecting, idle or busy&#8201;&#8212;&#8201;see states described in: <a href="#tbl-states">Table 2</a></p>
</li>
<li>
<p><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorStatus.html#Couchbase_Lite_Sync_ReplicatorStatus_Progress">Progress</a></p>
<div class="ulist">
<ul>
<li>
<p>completed&#8201;&#8212;&#8201;the total number of changes completed</p>
</li>
<li>
<p>total&#8201;&#8212;&#8201;the total number of changes to be processed</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.ReplicatorStatus.html#Couchbase_Lite_Sync_ReplicatorStatus_Error">Error</a>&#8201;&#8212;&#8201;the current error, if any</p>
</li>
</ul>
</div>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_adding-a-change-listener"></a>Adding a Change Listener</p>
</li>
<li>
<p><a id="tabset2_using-replicator-status"></a>Using replicator.status</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_adding-a-change-listener">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">_thisListenerToken =
  thisReplicator.AddChangeListener((sender, args) =&gt;
    {
      if (args.Status.Activity == ReplicatorActivityLevel.Stopped) {
          Console.WriteLine("Replication stopped");
      }
    });</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_using-replicator-status">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">_thisReplicator.Stop();
while (_thisReplicator.Status.Activity != ReplicatorActivityLevel.Stopped) {
    // Database cannot close until replicators are stopped
    Console.WriteLine($"Waiting for replicator to stop (currently {_thisReplicator.Status.Activity})...");
    Thread.Sleep(200);
}
_thisDatabase.Close();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="lbl-repl-states" class="paragraph">
<p>=== Replication States
<a href="#tbl-states">Table 2</a> shows the different states, or activity levels, reported in the API; and the meaning of each.</p>
</div>
<table id="tbl-states" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Replicator activity levels</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-center valign-top"><p class="tableblock">State</p></th>
<th class="tableblock halign-left valign-top"><p class="tableblock">Meaning</p></th>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>STOPPED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replication is finished or hit a fatal error.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>OFFLINE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replicator is offline as the remote host is unreachable.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>CONNECTING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replicator is connecting to the remote host.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>IDLE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replication caught up with all the changes available from the server.
The <code>IDLE</code> state is only used in continuous replications.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>BUSY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replication is actively transferring data.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The replication change object also has properties to track the progress (<code>change.status.completed</code> and <code>change.status.total</code>).
Since the replication occurs in batches the total count can vary through the course of a replication.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>=== Replication Status and App Life Cycle</p>
</div>
<div class="paragraph">
<p>Couchbase Lite doesn&#8217;t react to OS backgrounding or foregrounding events and replication(s) will continue running as long as the remote system does not terminate the connection and the app does not terminate.
It is generally recommended to stop replications before going into the background otherwise socket connections may be closed by the OS and this may interfere with the replication process.</p>
</div>
<div id="lbl-repl-evnts" class="paragraph">
<p>== Monitor Document Changes</p>
</div>
<div class="paragraph">
<p>You can choose to register for document updates during a replication.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You should register the listener before starting your replication, to avoid having to do a restart to activate it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, the code snippet in <a href="#ex-reg-doc-listener">[ex-reg-doc-listener]</a> registers a listener to monitor document replication performed by the replicator referenced by the variable <code>replicator</code>.
It prints the document ID of each document received and sent.
Stop the listener as shown in <a href="#ex-stop-doc-listener">[ex-stop-doc-listener]</a>.</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">//
// Program.cs
//
// Copyright (c) 2017 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Cryptography.X509Certificates;
using System.Threading;
using System.Threading.Tasks;

using Couchbase.Lite;
using Couchbase.Lite.Enterprise.Query;
using Couchbase.Lite.Logging;
using Couchbase.Lite.P2P;
using Couchbase.Lite.Query;
using Couchbase.Lite.Sync;
using Newtonsoft.Json;

using SkiaSharp;

namespace api_walkthrough
{
    class Program
    {
        private static Database _Database;
        private static Replicator _Replicator;
        private static URLEndpointListener _listener;
        private static ListenerToken _ListenerToken;
        private static bool _NeedsExtraDocs;

        #region Private Methods

        private static void GettingStarted()
        {
            // tag::getting-started[]
            // Get the database (and create it if it doesn't exist)
            var database = new Database("mydb");
            // Create a new document (i.e. a record) in the database
            string id = null;
            using (var mutableDoc = new MutableDocument()) {
                mutableDoc.SetFloat("version", 2.0f)
                    .SetString("type", "SDK");

                // Save it to the database
                database.Save(mutableDoc);
                id = mutableDoc.Id;
            }

            // Update a document
            using (var doc = database.GetDocument(id))
            using (var mutableDoc = doc.ToMutable()) {
                mutableDoc.SetString("language", "C#");
                database.Save(mutableDoc);

                using (var docAgain = database.GetDocument(id)) {
                    Console.WriteLine($"Document ID :: {docAgain.Id}");
                    Console.WriteLine($"Learning {docAgain.GetString("language")}");
                }
            }

            // Create a query to fetch documents of type SDK
            // i.e. SELECT * FROM database WHERE type = "SDK"
            using (var query = QueryBuilder.Select(SelectResult.All())
                .From(DataSource.Database(database))
                .Where(Expression.Property("type").EqualTo(Expression.String("SDK")))) {
                // Run the query
                var result = query.Execute();
                Console.WriteLine($"Number of rows :: {result.Count()}");
            }

            // Create replicator to push and pull changes to and from the cloud
            var targetEndpoint = new URLEndpoint(new Uri("ws://localhost:4984/getting-started-db"));
            var replConfig = new ReplicatorConfiguration(database, targetEndpoint);

            // Add authentication
            replConfig.Authenticator = new BasicAuthenticator("john", "pass");

            // Create replicator (make sure to add an instance or static variable
            // named _Replicator)
            _Replicator = new Replicator(replConfig);
            _Replicator.AddChangeListener((sender, args) =&gt;
            {
                if (args.Status.Error != null) {
                    Console.WriteLine($"Error :: {args.Status.Error}");
                }
            });

            _Replicator.Start();

            // Later, stop and dispose the replicator *before* closing/disposing the database
            // end::getting-started[]
        }

        private static void TestReplicatorConflictResolver()
        {
            // tag::replication-conflict-resolver[]
            var target = new URLEndpoint(new Uri("ws://localhost:4984/mydatabase"));
            var replConfig = new ReplicatorConfiguration(database, target);
            replConfig.ConflictResolver = new LocalWinConflictResolver();

            var replicator = new Replicator(replConfig);
            replicator.Start();
            // end::replication-conflict-resolver[]
        }

        private static void TestSaveWithConflictHandler()
        {
            // tag::update-document-with-conflict-handler[]
            using (var document = database.GetDocument("xyz"))
            using (var mutableDocument = document.ToMutable()) {
                mutableDocument.SetString("name", "apples");
                database.Save(mutableDocument, (updated, current) =&gt;
                {
                    var currentDict = current.ToDictionary();
                    var newDict = updated.ToDictionary();
                    var result = newDict.Concat(currentDict)
                        .GroupBy(kv =&gt; kv.Key)
                        .ToDictionary(g =&gt; g.Key, g =&gt; g.First().Value);
                    updated.SetData(result);
                    return true;
                });
            }
            // end::update-document-with-conflict-handler[]
        }

        private static bool IsValidCredential(string name, SecureString password) { return true;  } // helper
        private static void TestInitListener()
        {
            var db = new Database("other-database");
            _Database = db;

            // tag::init-urllistener[]
            var config = new URLEndpointListenerConfiguration(_Database);
            config.TlsIdentity = null; // Use with anonymous self-signed cert
            config.Authenticator = new ListenerPasswordAuthenticator((sender, username, password) =&gt;
            {
                if(IsValidCredential(username, password)) {
                    return true;
                }

                return false;
            });

            _listener = new URLEndpointListener(config);
            // end::init-urllistener[]
        }

        private static void TestListenerStart()
        {
            // tag::start-urllistener[]
            // CouchbaseLiteException will be thrown when the listener cannot be started. The most common error
            // would be that the configured port has already been used.
            _listener.Start();
            // end::start-urllistener[]
        }

        private static void TestListenerStop()
        {
            // tag::stop-urllistener[]
            _listener.Stop();
            // end::stop-urllistener[]
        }

        private static void TestCreateSelfSignedCert()
        {
            TLSIdentity identity;
            X509Store _store =
             new X509Store(StoreName.My);
              // The identity will be stored in the secure
              // storage using the given label.
            DateTimeOffset fiveMinToExpireCert = DateTimeOffset.UtcNow.AddMinutes(5);

            // tag::create-self-signed-cert[]
            // tag::listener-config-tls-id-SelfSigned[]
            identity = TLSIdentity.CreateIdentity(true, /* isServer */
                new Dictionary&lt;string, string&gt;() { { Certificate.CommonNameAttribute, "Couchbase Inc" } },
                    // The common name attribute is required
                    // when creating a CSR. If it is not presented
                    // in the cert, an exception is thrown.
                fiveMinToExpireCert,
                    // If the expiration date is not specified,
                    // the certs expiration will be 365 days
                _store,
                "CBL-Server-Cert",
                null);  // The key label to get cert in certificate map.
                        // If null, the same default directory
                        // for a Couchbase Lite db is used for map.

            // end::listener-config-tls-id-SelfSigned[]
            // end::create-self-signed-cert[]
        }

        private static void TestImportTLSIdentity()
        {
            TLSIdentity identity;
            X509Store _store = new X509Store(StoreName.My); // The identity will be stored in the secure storage using the given label
            byte[] data = File.ReadAllBytes("C:\\client.p12"); // PKCS12 data containing private key, public key, and certificates

            // tag::import-tls-identity[]
            // tag::listener-config-tls-id-caCert[]
            identity = TLSIdentity.ImportIdentity(_store,
                data,
                "123", // The password that is needed to access the certificate data
                "CBL-Client-Cert",
                null);  // The key label to get cert in certificate map.
                        // If null, the same default directory
                        // for a Couchbase Lite db is used for map.
            // end::listener-config-tls-id-caCert[]
            // end::import-tls-identity[]
        }

          private static void TestClientCertAuthenticatorRootCerts()
        {
            var db = new Database("other-database");
            _Database = db;

            X509Store _store = new X509Store(StoreName.My);
            TLSIdentity identity;

            // tag::client-cert-authenticator-root-certs[]
            byte[] caData, clientData;
            clientData = File.ReadAllBytes("C:\\client.p12"); // PKCS12 data containing private key, public key, and certificates
            caData = File.ReadAllBytes("C:\\client-ca.der");

            // Root certs
            var rootCert = new X509Certificate2(caData);
            var auth = new ListenerCertificateAuthenticator(new X509Certificate2Collection(rootCert));

            // Create URL Endpoint Listener
            var listenerConfig = new URLEndpointListenerConfiguration(_Database);
            listenerConfig.DisableTLS = false; //The default value is false which means that the TLS will be enabled by default.
            listenerConfig.Authenticator = auth;
            _listener = new URLEndpointListener(listenerConfig);
            _listener.Start();

            // Client identity
            identity = TLSIdentity.ImportIdentity(_store,
                clientData,
                "123",
                "CBL-Client-Cert",
                null);

            // Replicator -- Client
            var database = new Database("client-database");
            var builder = new UriBuilder(
                "wss",
                "localhost",
                _listener.Port,
                $"/{_listener.Config.Database.Name}"
            );

            var url = builder.Uri;
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.ReplicatorType = ReplicatorType.PushAndPull;
            config.Continuous = false;
            config.Authenticator = new ClientCertificateAuthenticator(identity);
            config.AcceptOnlySelfSignedServerCertificate = true;
            config.PinnedServerCertificate = _listener.TlsIdentity.Certs[0];
            using (var replicator = new Replicator(config)) {
                replicator.Start();
            }

            // Stop listener after replicator is stopped
            _listener.Stop();
            // end::client-cert-authenticator-root-cert
        }

        private static void TestClientCertAuthenticator()
        {
            var db = new Database("other-database");
            _Database = db;

            X509Store _store = new X509Store(StoreName.My);
            TLSIdentity identity;

            // tag::client-cert-authenticator[]

            // Create Listener Certificate Authenticator
            var auth = new ListenerCertificateAuthenticator((sender, cert) =&gt;
            {
                if (cert.Count != 1) {
                    return false;
                }

                return cert[0].SubjectName.Name?.Replace("CN=", "") == "couchbase";
            });

            // Create URL Endpoint Listener
            var listenerConfig = new URLEndpointListenerConfiguration(_Database);
            listenerConfig.DisableTLS = false; //The default value is false which means that the TLS will be enabled by default.
            listenerConfig.Authenticator = auth;
            _listener = new URLEndpointListener(listenerConfig);
            _listener.Start();

            // User Identity
            identity = TLSIdentity.CreateIdentity(false,
                new Dictionary&lt;string, string&gt;() { { Certificate.CommonNameAttribute, "couchbase" } },
                null,
                _store,
                ClientCertLabel,
                null);

            // Replicator -- Client
            var database = new Database("client-database");
            var builder = new UriBuilder(
                "wss",
                "localhost",
                _listener.Port,
                $"/{_listener.Config.Database.Name}"
            );

            var url = builder.Uri;
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.ReplicatorType = ReplicatorType.PushAndPull;
            config.Continuous = false;
            config.Authenticator = new ClientCertificateAuthenticator(identity);
            config.AcceptOnlySelfSignedServerCertificate = false;
            config.PinnedServerCertificate = _listener.TlsIdentity.Certs[0];
            using (var replicator = new Replicator(config)) {
                replicator.Start();
            }

            // Stop listener after replicator is stopped
            _listener.Stop();
            // end::client-cert-authenticator[]
        }

        private static void UseEncryption()
        {
            // Enterprise edition only

            // tag::database-encryption[]
            // Create a new, or open an existing database with encryption enabled
            var config = new DatabaseConfiguration
            {
                // Or, derive a key yourself and pass a byte array of the proper size
                EncryptionKey = new EncryptionKey("password")
            };

            using (var db = new Database("seekrit", config)) {
                // Change the encryption key (or add encryption if the DB is unencrypted)
                db.ChangeEncryptionKey(new EncryptionKey("betterpassw0rd"));

                // Remove encryption
                db.ChangeEncryptionKey(null);
            }
            // end::database-encryption[]
        }

        private static void ResetReplicatorCheckpoint()
        {
            var database = _Database;
            var url = new Uri("ws://localhost:4984/db");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            using (var replicator = new Replicator(config)) {
                // tag::replication-reset-checkpoint[]
                // replicator is a Replicator instance
                replicator.ResetCheckpoint();
                replicator.Start();
                // end::replication-reset-checkpoint[]
            }
        }

        private static void Read1xAttachment()
        {
            var db = _Database;
            using (var document = new MutableDocument()) {
                // tag::1x-attachment[]
                var attachments = document.GetDictionary("_attachments");
                var avatar = attachments.GetBlob("avatar");
                var content = avatar?.Content;
                // end::1x-attachment[]
            }
        }

        private static void CreateNewDatabase()
        {
            // tag::new-database[]
            var db = new Database("my-database");
            // end::new-database[]

            _Database = db;
        }

        private static void CloseDatabase()
        {
          // tag::close-database[]
          database.close()

          // end::close-database[]
        }

        private static void ChangeLogging()
        {
            // tag::logging[]
            Database.SetLogLevel(LogDomain.Replicator, LogLevel.Verbose);
            Database.SetLogLevel(LogDomain.Query, LogLevel.Verbose);
            // end::logging[]
        }

        private static void LoadPrebuilt()
        {
            // tag::prebuilt-database[]
            // Note: Getting the path to a database is platform-specific.  For .NET Core / .NET Framework this
            // can be a simple filesystem path.  For UWP, you will need to get the path from your assets.  For
            // iOS you need to get the path from the main bundle.  For Android you need to extract it from your
            // assets to a temporary directory and then pass that path.
            var path = Path.Combine(Environment.CurrentDirectory, "travel-sample.cblite2" + Path.DirectorySeparatorChar);
            if (!Database.Exists("travel-sample", null)) {
                _NeedsExtraDocs = true;
                Database.Copy(path, "travel-sample", null);
            }
            // end::prebuilt-database[]

            _Database.Close();
            _Database = new Database("travel-sample");
        }

        private static void QueryDeletedDocuments()
        {
            // tag::query-deleted-documents[]
            // Query documents that have been deleted
            var query = QueryBuilder
                .Select(SelectResult.Expression(Meta.ID))
                .From(DataSource.Database(db))
                .Where(Meta.IsDeleted);
            // end::query-deleted-documents[]
        }

        private static void CreateDocument()
        {
            var db = _Database;
            // tag::initializer[]
            using (var newTask = new MutableDocument("xyz")) {
                newTask.SetString("type", "task")
                    .SetString("owner", "todo")
                    .SetDate("createdAt", DateTimeOffset.UtcNow);

                db.Save(newTask);
            }
            // end::initializer[]
        }

        private static void UpdateDocument()
        {
            var db = _Database;
            // tag::update-document[]
            using(var document = db.GetDocument("xyz"))
            using (var mutableDocument = document.ToMutable()) {
                mutableDocument.SetString("name", "apples");
                db.Save(mutableDocument);
            }
            // end::update-document[]
        }

        private static void UseTypedAccessors()
        {
            using (var newTask = new MutableDocument()) {
                // tag::date-getter[]
                newTask.SetValue("createdAt", DateTimeOffset.UtcNow);
                var date = newTask.GetDate("createdAt");
                // end::date-getter[]

                Console.WriteLine(date);
            }
        }

        private static void DoBatchOperation()
        {
            var db = _Database;
            // tag::batch[]
            db.InBatch(() =&gt;
            {
                for (var i = 0; i &lt; 10; i++) {
                    using (var doc = new MutableDocument()) {
                        doc.SetString("type", "user");
                        doc.SetString("name", $"user {i}");
                        doc.SetBoolean("admin", false);
                        db.Save(doc);
                        Console.WriteLine($"Saved user document {doc.GetString("name")}");
                    }
                }
            });
            // end::batch[]
        }

        private static void DatabaseChangeListener()
        {
            var db = _Database;

            // tag::document-listener[]
            db.AddDocumentChangeListener("user.john", (sender, args) =&gt;
            {
                using (var doc = Db.GetDocument(args.DocumentID)) {
                    Console.WriteLine($"Status :: {doc.GetString("verified_account")}");
                }
            });
            // end::document-listener[]
        }

        private static void DocumentExpiration()
        {
            var db = _Database;

            // tag::document-expiration[]
            // Purge the document one day from now
            var ttl = DateTimeOffset.UtcNow.AddDays(1);
            db.SetDocumentExpiration("doc123", ttl);

            // Reset expiration
            db.SetDocumentExpiration("doc1", null);

            // Query documents that will be expired in less than five minutes
            var fiveMinutesFromNow = DateTimeOffset.UtcNow.AddMinutes(5).ToUnixTimeMilliseconds();
            var query = QueryBuilder
                .Select(SelectResult.Expression(Meta.ID))
                .From(DataSource.Database(db))
                .Where(Meta.Expiration.LessThan(Expression.Double(fiveMinutesFromNow)));
            // end::document-expiration[]
        }

        private static void UseBlob()
        {
            var db = _Database;
            using (var newTask = new MutableDocument()) {
                // tag::blob[]
                // Note: Reading the data is implementation dependent, as with prebuilt databases
                var image = File.ReadAllBytes("avatar.jpg");
                var blob = new Blob("image/jpeg", image);
                newTask.SetBlob("avatar", blob);
                db.Save(newTask);
                // end::blob[]

                var taskBlob = newTask.GetBlob("avatar");
                using (var bitmap = SKBitmap.Decode(taskBlob.ContentStream)) {
                    Console.WriteLine($"Bitmap dimensions: {bitmap.Width} x {bitmap.Height} ({bitmap.BytesPerPixel} bytes per pixel)");
                }
            }
        }

        private static void CreateIndex()
        {
            var db = _Database;

            // tag::query-index[]
            // For value types, this is optional but provides performance enhancements
            var index = IndexBuilder.ValueIndex(
                ValueIndexItem.Expression(Expression.Property("type")),
                ValueIndexItem.Expression(Expression.Property("name"))); <i class="conum" data-value="1"></i><b>(1)</b>
            db.CreateIndex("TypeNameIndex", index);
            // end::query-index[]
        }

        private static void SelectMeta()
        {
            Console.WriteLine("Select Meta");
            var db = _Database;

            // tag::query-select-meta[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("type"),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Document ID :: {result.GetString("id")}");
                    Console.WriteLine($"Document Name :: {result.GetString("name")}");
                }
            }
            // end::query-select-meta[]
        }

        private static void SelectAll()
        {
            var db = _Database;

            // tag::query-select-all[]
            using (var query = QueryBuilder.Select(SelectResult.All())
                .From(DataSource.Database(db))) {
                // All user properties will be available here
            }
            // end::query-select-all[]

            // tag::live-query[]
            var query = QueryBuilder
                .Select(SelectResult.All())
                .From(DataSource.Database(db));

            // Adds a query change listener.
            // Changes will be posted on the main queue.
            var token = query.AddChangeListener((sender, args) =&gt; <i class="conum" data-value="2"></i><b>(2)</b>
            {
                var allResult = args.Results.AllResults();
                foreach (var result in allResult) {
                    Console.WriteLine(result.Keys);
                    /* Update UI */
                }
            });

            // Start live query.
            query.Execute(); <i class="conum" data-value="1"></i><b>(1)</b>
            // end::live-query[]

            // tag::stop-live-query[]
            query.RemoveChangeListener(token);
            query.Dispose();
            // end::stop-live-query[]
        }

        private static void SelectWhere()
        {
            Console.WriteLine("Where");
            var db = _Database;

            // tag::query-where[]
            using (var query = QueryBuilder.Select(SelectResult.All())
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("hotel")))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    var dict = result.GetDictionary(db.Name);
                    Console.WriteLine($"Document Name :: {dict?.GetString("name")}");
                }
            }
            // end::query-where[]
        }

        private static void UseCollectionContains()
        {
            Console.WriteLine("Collection Operator CONTAINS");
            var db = _Database;

            // tag::query-collection-operator-contains[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"),
                    SelectResult.Property("public_likes"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("hotel"))
                    .And(ArrayFunction.Contains(Expression.Property("public_likes"),
                        Expression.String("Armani Langworth"))))) {
                foreach (var result in query.Execute()) {
                    var publicLikes = result.GetArray("public_likes");
                    var jsonString = JsonConvert.SerializeObject(publicLikes);
                    Console.WriteLine($"Public Likes :: {jsonString}");
                }
            }
            // end::query-collection-operator-contains[]
        }

        private static void UseCollectionIn()
        {
            Console.WriteLine("Collection Operator IN");
            var db = _Database;

            // tag::query-collection-operator-in[]
            var values = new IExpression[]
                { Expression.Property("first"), Expression.Property("last"), Expression.Property("username") };

            using (var query = QueryBuilder.Select(
                    SelectResult.All())
                .From(DataSource.Database(db))
                .Where(Expression.String("Armani").In(values))) {
                foreach (var result in query.Execute()) {
                    var body = result.GetDictionary(0);
                    var jsonString = JsonConvert.SerializeObject(body);
                    Console.WriteLine($"In results :: {jsonString}");
                }
            }
            // end::query-collection-operator-in[]
        }

        private static void SelectLike()
        {
            Console.WriteLine("Like");
            var db = _Database;

            // tag::query-like-operator[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Function.Lower(Expression.Property("name")).Like(Expression.String("Royal Engineers Museum"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-like-operator[]
        }

        private static void SelectWildcardLike()
        {
            Console.WriteLine("Wildcard Like");
            var db = _Database;

            // tag::query-like-operator-wildcard-match[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Function.Lower(Expression.Property("name")).Like(Expression.String("Eng%e%"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-like-operator-wildcard-match[]
        }

        private static void SelectWildcardCharacterLike()
        {
            Console.WriteLine("Wildchard Characters");
            var db = _Database;

            // tag::query-like-operator-wildcard-character-match[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Expression.Property("name").Like(Expression.String("Royal Eng____rs Museum"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-like-operator-wildcard-character-match[]
        }

        private static void SelectRegex()
        {
            Console.WriteLine("Regex");
            var db = _Database;

            // tag::query-regex-operator[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("name"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("landmark"))
                    .And(Expression.Property("name").Regex(Expression.String("\\bEng.*e\\b"))))
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-regex-operator[]
        }

        private static void SelectJoin()
        {
            Console.WriteLine("Join");
            var db = _Database;

            // tag::query-join[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Expression.Property("name").From("airline")),
                    SelectResult.Expression(Expression.Property("callsign").From("airline")),
                    SelectResult.Expression(Expression.Property("destinationairport").From("route")),
                    SelectResult.Expression(Expression.Property("stops").From("route")),
                    SelectResult.Expression(Expression.Property("airline").From("route")))
                .From(DataSource.Database(db).As("airline"))
                .Join(Join.InnerJoin(DataSource.Database(db).As("route"))
                    .On(Meta.ID.From("airline").EqualTo(Expression.Property("airlineid").From("route"))))
                .Where(Expression.Property("type").From("route").EqualTo(Expression.String("route"))
                    .And(Expression.Property("type").From("airline").EqualTo(Expression.String("airline")))
                    .And(Expression.Property("sourceairport").From("route").EqualTo(Expression.String("RIX"))))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Name Property :: {result.GetString("name")}");
                }
            }
            // end::query-join[]
        }

        private static void GroupBy()
        {
            Console.WriteLine("GroupBy");
            var db = _Database;

            // tag::query-groupby[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Function.Count(Expression.All())),
                    SelectResult.Property("country"),
                    SelectResult.Property("tz"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("airport"))
                    .And(Expression.Property("geo.alt").GreaterThanOrEqualTo(Expression.Int(300))))
                .GroupBy(Expression.Property("country"), Expression.Property("tz"))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine(
                        $"There are {result.GetInt("$1")} airports in the {result.GetString("tz")} timezone located in {result.GetString("country")} and above 300 ft");
                }
            }
            // end::query-groupby[]
        }

        private static void OrderBy()
        {
            Console.WriteLine("OrderBy");
            var db = _Database;

            // tag::query-orderby[]
            using (var query = QueryBuilder.Select(
                    SelectResult.Expression(Meta.ID),
                    SelectResult.Property("title"))
                .From(DataSource.Database(db))
                .Where(Expression.Property("type").EqualTo(Expression.String("hotel")))
                .OrderBy(Ordering.Property("title").Ascending())
                .Limit(Expression.Int(10))) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Title :: {result.GetString("title")}");
                }
            }
            // end::query-orderby[]
        }

      // ### EXPLAIN statement
      private static void TestExplainStatement()
      // For Documentation
      {
        var db = _Database;
          // tag::query-explain-all[]
        var query =
          QueryBuilder
            .Select(SelectResult.All())
            .From(DataSource.Database(db))
            .Where(Expression.Property("type").EqualTo(Expression.String("hotel")))
            .GroupBy(Expression.Property("country"))
            .OrderBy(Ordering.Property("title").Ascending()) <i class="conum" data-value="3"></i><b>(3)</b>

          Console.WriteLine(query.Explain()); <i class="conum" data-value="4"></i><b>(4)</b>

          // end::query-explain-all[]
          // tag::query-explain-like[]
var query =
  QueryBuilder
    .Select(SelectResult.All())
    .From(DataSource.Database(db))
    .Where(Expression.Property("type").Like(Expression.String("%hotel%"))
      .And(Function.Lower(Expression.Property("name")).Like(Expression.String("%royal%")))); <i class="conum" data-value="5"></i><b>(5)</b>
  Console.WriteLine(query.Explain());

          // end::query-explain-like[]
          // tag::query-explain-nopfx[]
var query =
  QueryBuilder
    .Select(SelectResult.All())
    .From(DataSource.Database(db))
    .Where(Expression.Property("type").Like(Expression.String("hotel%"))
      .And(Function.Lower(Expression.Property("name")).Like(Expression.String("%royal%")))); <i class="conum" data-value="6"></i><b>(6)</b>

  Console.WriteLine(query.Explain());

          // end::query-explain-nopfx[]
          // tag::query-explain-function[]
var query =
  QueryBuilder
    .Select(SelectResult.All())
    .From(DataSource.Database(db))
    .Where(Function.Lower(Expression.Property("type")).EqualTo(Expression.String("hotel"))); <i class="conum" data-value="7"></i><b>(7)</b>

  Console.WriteLine(query.Explain());

          // end::query-explain-function[]
          // tag::query-explain-nofunction[]
        var query =
          QueryBuilder
            .Select(SelectResult.All())
            .From(DataSource.Database(db))
            .Where(Expression.Property("type")).EqualTo(Expression.String("hotel")); <i class="conum" data-value="8"></i><b>(8)</b>

          Console.WriteLine(query.Explain());

          // end::query-explain-nofunction[]
      }

      // end query-explain





        private static void CreateFullTextIndex()
        {
            var db = _Database;
            if (_NeedsExtraDocs) {
                var tasks = new[] { "buy groceries", "play chess", "book travels", "buy museum tickets" };
                foreach (var task in tasks) {
                    using (var doc = new MutableDocument()) {
                        doc.SetString("type", "task");
                        doc.SetString("name", task);
                        db.Save(doc);
                    }
                }
            }

            // tag::fts-index[]
            var index = IndexBuilder.FullTextIndex(FullTextIndexItem.Property("name")).IgnoreAccents(false);
            db.CreateIndex("nameFTSIndex", index);
            // end::fts-index[]
        }

        private static void FullTextSearch()
        {
            Console.WriteLine("Full text search");
            var db = _Database;

            // tag::fts-query[]
            var whereClause = FullTextExpression.Index("nameFTSIndex").Match("'buy'");
            using (var query = QueryBuilder.Select(SelectResult.Expression(Meta.ID))
                .From(DataSource.Database(db))
                .Where(whereClause)) {
                foreach (var result in query.Execute()) {
                    Console.WriteLine($"Document id {result.GetString(0)}");
                }
            }
            // end::fts-query[]
        }
        private static void StartReplication()
        {
            var db = _Database;

            /*
             * This requires Sync Gateway running with the following config, or equivalent:
             *
             * {
             *     "log":["*"],
             *     "databases": {
             *         "db": {
             *             "server":"walrus:",
             *             "users": {
             *                 "GUEST": {"disabled": false, "admin_channels": ["*"] }
             *             }
             *         }
             *     }
             * }
             */

            // tag::replication[]
            // Note: Android emulator needs to use 10.0.2.2 for localhost (10.0.3.2 for GenyMotion)
            var url = new Uri("ws://localhost:4984/db");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(db, target)
            {
                ReplicatorType = ReplicatorType.Pull
            };

            var replicator = new Replicator(config);
            replicator.Start();
            // end::replication[]

            _Replicator = replicator;
        }

        private static void VerboseReplicatorLogging()
        {
            // tag::replication-logging[]
            // deprecated
            Database.SetLogLevel(LogDomain.Replicator, LogLevel.Verbose);
            Database.SetLogLevel(LogDomain.Network, LogLevel.Verbose);
            // end::replication-logging[]
        }

        private static void ConsoleLogging()
        {
            // tag::console-logging[]
            Database.Log.Console.Domains = LogDomain.All; <i class="conum" data-value="9"></i><b>(9)</b>
            Database.Log.Console.LogLevel = LogLevel.Verbose; <i class="conum" data-value="10"></i><b>(10)</b>

            // end::console-logging[]

            // tag::console-logging-db[]
            Database.Log.Console.Domains = LogDomain.Database;

            // end::console-logging-db[]
        }

        private static void FileLogging()
        {
            // tag::file-logging[]
            var tempFolder = Path.Combine(Service.GetInstance&lt;IDefaultDirectoryResolver&gt;().DefaultDirectory(), "cbllog");
            var config = new LogFileConfiguration(tempFolder) <i class="conum" data-value="11"></i><b>(11)</b>
            {
                MaxRotateCount = 5, <i class="conum" data-value="12"></i><b>(12)</b>
                MaxSize = 10240, <i class="conum" data-value="13"></i><b>(13)</b>
                UsePlainText = false  <i class="conum" data-value="14"></i><b>(14)</b>
            };
            Database.Log.File.Config = config; // Apply configuration
            Database.Log.File.Level = LogLevel.Info; <i class="conum" data-value="15"></i><b>(15)</b>

            // end::file-logging[]
        }

        private static void EnableCustomLogging()
        {
            // tag::set-custom-logging[]
            Database.Log.Custom = new LogTestLogger(); <i class="conum" data-value="16"></i><b>(16)</b>
            or
            Database.Log.Custom = new LogTestLogger { Level = LogLevel.Warning };

            // end::set-custom-logging[]
        }

        private static void WriteConsoleLog()
        {
            // tag::write-console-logmsg[]
            Database.Log.Console.Log(LogLevel.Warning, LogDomain.Replicator, "Any old log message");
            // end::write-console-logmsg[]
        }
        private static void WriteCustomLog()
        {
            // tag::write-custom-logmsg[]
            Database.Log.Custom?.Log(LogLevel.Warning, LogDomain.Replicator, "Any old log message");
            // end::write-custom-logmsg[]
        }


        private static void WriteFileLog()
        {
            // tag::write-file-logmsg[]
            Database.Log.File.Log(LogLevel.Warning, LogDomain.Replicator, "Any old log message");
            // end::write-file-logmsg[]
        }

        private static void EnableBasicAuth()
        {
            var database = _Database;

            // tag::basic-authentication[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.Authenticator = new BasicAuthenticator("john", "pass");

            var replicator = new Replicator(config);
            replicator.Start();
            // end::basic-authentication[]
        }

        private static void EnableSessionAuth()
        {
            var database = _Database;

            // tag::session-authentication[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);
            var config = new ReplicatorConfiguration(database, target);
            config.Authenticator = new SessionAuthenticator("904ac010862f37c8dd99015a33ab5a3565fd8447");

            var replicator = new Replicator(config);
            replicator.Start();
            // end::session-authentication[]
        }

        private static void SetupReplicatorListener()
        {
            var replicator = _Replicator;

            // tag::replication-status[]
            replicator.AddChangeListener((sender, args) =&gt;
            {
                if (args.Status.Activity == ReplicatorActivityLevel.Stopped) {
                    Console.WriteLine("Replication stopped");
                }
            });
            // end::replication-status[]
        }




    //  BEGIN PendingDocuments IB -- 11/Feb/21 --
    private static void ReplicatorPendingDocuments()
    {
        // tag::replication-pendingdocuments[]
        var url = new Uri("ws://localhost:4984/mydatabase");
        var target = new URLEndpoint(url);
        var database = new Database("myDB");
        var config = new ReplicatorConfiguration(database, target);
        config.ReplicatorType  = ReplicatorType.Push;

        // tag::replication-push-pendingdocumentids[]
        var replicator = new Replicator(config);

        var mydocids =
          new HashSet &lt;string&gt; (replicator.GetPendingDocumentIDs()); <i class="conum" data-value="17"></i><b>(17)</b>

        // end::replication-push-pendingdocumentids[]

        if (mydocids.Count &gt; 0)
        {
            Console.WriteLine($"There are {mydocids.Count} documents pending");
            replicator.AddChangeListener((sender, change) =&gt;
            {
                Console.WriteLine($"Replicator activity level is " +
                                  change.Status.Activity.ToString());
                // iterate and report-on previously
                // retrieved pending docids 'list'
                foreach (var thisId in mydocids)
                    // tag::replication-push-isdocumentpending[]
                    if (!replicator.IsDocumentPending(thisId)) <i class="conum" data-value="18"></i><b>(18)</b>
                    {
                        Console.WriteLine($"Doc ID {thisId} now pushed");
                    };
                // end::replication-push-isdocumentpending[]
            });

            replicator.Start();
        }
    // end::replication-pendingdocuments[]
    }


//  END PendingDocuments IB -- 11/Feb/21 --



		private static void ReplicatorDocumentEvent()
        {
            var replicator = _Replicator;

            // tag::add-document-replication-listener[]
            var token = replicator.AddDocumentReplicationListener((sender, args) =&gt;
            {
                var direction = args.IsPush ? "Push" : "Pull";
                Console.WriteLine($"Replication type :: {direction}");
                foreach (var document in args.Documents) {
                    if (document.Error == null) {
                        Console.WriteLine($"Doc ID :: {document.Id}");
                        if (document.Flags.HasFlag(DocumentFlags.Deleted)) {
                            Console.WriteLine("Successfully replicated a deleted document");
                        }
                    } else {
                        // There was an error
                    }
                }
            });

            replicator.Start();
            // end::add-document-replication-listener[]

            // tag::remove-document-replication-listener[]
            replicator.RemoveChangeListener(token);
            // end::remove-document-replication-listener[]
        }

        private static void SetupReplicatorErrorListener()
        {
            // This can be done in the SetupReplicatorListener method
            // But it is separate so that we can have two documentation entries

            var replicator = _Replicator;

            // tag::replication-error-handling[]
            replicator.AddChangeListener((sender, args) =&gt;
            {
                if (args.Status.Error != null) {
                    Console.WriteLine($"Error :: {args.Status.Error}");
                }
            });
            // end::replication-error-handling[]
        }

        private static void DatabaseReplica()
        {
            var db = _Database;
            using (var database2 = new Database("backup")) {
                // EE feature: This code will not compile on the community edition
                // tag::database-replica[]
                var targetDatabase = new DatabaseEndpoint(database2);
                var config = new ReplicatorConfiguration(db, targetDatabase)
                {
                    ReplicatorType = ReplicatorType.Push
                };

                var replicator = new Replicator(config);
                replicator.Start();
                // end::database-replica[]

                _Replicator?.Stop();
                _Replicator = replicator;
            }
        }

        private static void PinCertificate()
        {
            // Note: No certificate is included here, so this code is for show only
            var url = new Uri("wss://localhost:4984/db");
            var target = new URLEndpoint(url);
            var db = _Database;

            // tag::certificate-pinning[]
            // Note: `GetCertificate` is a fake method. This would be the platform-specific method
            // to find and load the certificate as an instance of `X509Certificate2`.
            // For .NET Core / .NET Framework this can be loaded from the filesystem path.
            // For UWP, from the assets directory.
            // For iOS, from the main bundle.
            // For Android, from the assets directory.
            var certificate = GetCertificate("cert.cer");
            var config = new ReplicatorConfiguration(db, target)
            {
                PinnedServerCertificate = certificate
            };
            // end::certificate-pinning[]
        }

        private static void ReplicationCustomHeaders()
        {
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            // tag::replication-custom-header[]
            var config = new ReplicatorConfiguration(database, target)
            {
                Headers = new Dictionary&lt;string, string&gt;
                {
                    ["CustomHeaderName"] = "Value"
                }
            };
            // end::replication-custom-header[]
        }

        private static void PushWithFilter(Database database)
        {
            // tag::replication-push-filter[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            var config = new ReplicatorConfiguration(database, target);
            config.PushFilter = (document, flags) =&gt; <i class="conum" data-value="1"></i><b>(1)</b>
            {
                if (flags.HasFlag(DocumentFlags.Deleted)) {
                    return false;
                }

                return true;
            };

            // Dispose() later
            var replicator = new Replicator(config);
            replicator.Start();
            // end::replication-push-filter[]
        }

        private static void PullWithFilter(Database database)
        {
            // tag::replication-pull-filter[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            var config = new ReplicatorConfiguration(database, target);
            config.PullFilter = (document, flags) =&gt; <i class="conum" data-value="1"></i><b>(1)</b>
            {
                if (document.GetString("type") == "draft") {
                    return false;
                }

                return true;
            };

            // Dispose() later
            var replicator = new Replicator(config);
            replicator.Start();
            // end::replication-pull-filter[]
        }

        public void TestCustomRetryConfig()
        {
        // tag::replication-retry-config[]
            var url = new Uri("ws://localhost:4984/mydatabase");
            var target = new URLEndpoint(url);

            var config = new ReplicatorConfiguration(database, target);

        //  other config as required . . .

        // tag::replication-set-heartbeat[]
            config.Heartbeat = TimeSpan.FromSeconds(120); //  <i class="conum" data-value="19"></i><b>(19)</b>
        // end::replication-set-heartbeat[]
        // tag::replication-set-maxretries[]
            config.MaxRetries = 20; //  <i class="conum" data-value="20"></i><b>(20)</b>
        // end::replication-set-maxretries[]
        // tag::replication-set-maxretrywaittime[]
            config.MaxRetryWaitTime = TimeSpan.FromSeconds(600); //  <i class="conum" data-value="21"></i><b>(21)</b>
        // end::replication-set-maxretrywaittime[]

        //  other config as required . . .

            var repl = new Replicator(config);

        // end::replication-retry-config[]
        }


        private static void UsePredictiveModel()
        {
            using (var db = new Database("mydb")) {
                // tag::register-model[]
                var model = new ImageClassifierModel();
                Database.Prediction.RegisterModel("ImageClassifier", model);
                // end::register-model[]

                // tag::predictive-query-value-index[]
                var index = IndexBuilder.ValueIndex(ValueIndexItem.Property("label"));
                db.CreateIndex("value-index-image-classifier", index);
                // end::predictive-query-value-index[]

                // tag::unregister-model[]
                Database.Prediction.UnregisterModel("ImageClassifier");
                // end::unregister-model[]
            }
        }

        private static void UsePredictiveIndex()
        {
            using (var db = new Database("mydb")) {
                // tag::predictive-query-predictive-index[]
                var input = Expression.Dictionary(new Dictionary&lt;string, object&gt;
                {
                    ["photo"] = Expression.Property("photo")
                });

                var index = IndexBuilder.PredictiveIndex("ImageClassifier", input);
                db.CreateIndex("predictive-index-image-classifier", index);
                // end::predictive-query-predictive-index[]
            }
        }

        private static void DoPredictiveQuery()
        {
            using (var db = new Database("mydb")) {
                // tag::predictive-query[]
                var input = Expression.Dictionary(new Dictionary&lt;string, object&gt;
                {
                    ["photo"] = Expression.Property("photo")
                });
                var prediction = PredictiveModel.predict("ImageClassifier", input); <i class="conum" data-value="1"></i><b>(1)</b>

                using (var q = QueryBuilder.Select(SelectResult.All())
                    .From(DataSource.Database(db))
                    .Where(prediction.Property("label").EqualTo(Expression.String("car"))
                        .And(prediction.Property("probability").GreaterThanOrEqualTo(Expression.Double(0.8))))) {
                    var result = q.Execute();
                    Console.WriteLine($"Number of rows: {result.Count()}");
                }
                // end::predictive-query[]
            }
        }

        static void Main(string[] args)
        {
            // This only needs to be done once for whatever platform the executable is running
            // (UWP, iOS, Android, or desktop)
            Couchbase.Lite.Support.NetDesktop.Activate();

            CreateNewDatabase();
            CreateDocument();
            UpdateDocument();
            UseTypedAccessors();
            DoBatchOperation();
            UseBlob();
            SelectMeta();

            LoadPrebuilt();
            CreateIndex();
            SelectWhere();
            UseCollectionContains();
            SelectLike();
            SelectWildcardLike();
            SelectWildcardCharacterLike();
            SelectRegex();
            SelectJoin();
            GroupBy();
            OrderBy();

            CreateFullTextIndex();
            FullTextSearch();
            StartReplication();
            SetupReplicatorListener();

            _Replicator.Stop();
            while (_Replicator.Status.Activity != ReplicatorActivityLevel.Stopped) {
                // Database cannot close until replicators are stopped
                Console.WriteLine($"Waiting for replicator to stop (currently {_Replicator.Status.Activity})...");
                Thread.Sleep(200);
            }

            _Database.Close();
        }

        #endregion
    }

    /* ----------------------------------------------------------- */
    /* ---------------------  ACTIVE SIDE  ----------------------- */
    /* ---------------  stubs for documentation  ----------------- */
    /* ----------------------------------------------------------- */

    class ActivePeer : IMessageEndpointDelegate
    {
        ActivePeer()
        {
            var id = "";

            // tag::message-endpoint[]
            var database = new Database("dbname");

            // The delegate must implement the `IMessageEndpointDelegate` protocol.
            var messageEndpointTarget = new MessageEndpoint(uid: "UID:123", target: "",
                protocolType: ProtocolType.MessageStream, delegateObject: this);
            // end::message-endpoint[]

            // tag::message-endpoint-replicator[]
            var config = new ReplicatorConfiguration(database, messageEndpointTarget);

            // Create the replicator object
            var replicator = new Replicator(config);
            // Start the replicator
            replicator.Start();
            // end::message-endpoint-replicator[]
        }

        // tag::create-connection[]
        /* implementation of MessageEndpointDelegate */
        public IMessageEndpointConnection CreateConnection(MessageEndpoint endpoint)
        {
            var connection = new ActivePeerConnection(); /* implements MessageEndpointConnection */
            return connection;
        }
        // end::create-connection[]
    }

    class ActivePeerConnection : IMessageEndpointConnection
    {
        private IReplicatorConnection _replicatorConnection;

        public void Disconnect()
        {
            // tag::active-replicator-close[]
            _replicatorConnection?.Close(null);
            // end::active-replicator-close[]
        }

        public void Receive(byte[] data)
        {
            // tag::active-peer-receive[]
            var message = Message.FromBytes(data);
            _replicatorConnection?.Receive(message);
            // end::active-peer-receive[]
        }

        // tag::active-peer-close[]
        /* implementation of MessageEndpointConnection */
        public async Task Close(Exception error)
        {
            // await socket.Close, etc (or do nothing if already closed)
            // throw MessagingException if something goes wrong (though
            // since it is "close" nothing special will happen)
        }
        // end::active-peer-close[]

        // tag::active-peer-open[]
        /* implementation of MessageEndpointConnection */
        public async Task Open(IReplicatorConnection connection)
        {
            _replicatorConnection = connection;
            // await socket.Open(), etc
            // throw MessagingException if something goes wrong
        }
        // end::active-peer-open[]

        // tag::active-peer-send[]
        /* implementation of MessageEndpointConnection */
        public async Task Send(Message message)
        {
            var data = message.ToByteArray();
            // await Socket.Send(), etc
            // throw MessagingException if something goes wrong
        }
        // end::active-peer-send[]
    }

    /* ----------------------------------------------------------- */
    /* ---------------------  PASSIVE SIDE  ---------------------- */
    /* ---------------  stubs for documentation  ----------------- */
    /* ----------------------------------------------------------- */
    class PassivePeerConnection : IMessageEndpointConnection
    {
        private MessageEndpointListener _messageEndpointListener;
        private IReplicatorConnection _replicatorConnection;

        public void StartListener()
        {
            // tag::listener[]
            var database = new Database("mydb");
            var config = new MessageEndpointListenerConfiguration(database, ProtocolType.MessageStream);
            _messageEndpointListener = new MessageEndpointListener(config);
            // end::listener[]
        }

        public void StopListener()
        {
            // tag::passive-stop-listener[]
            _messageEndpointListener?.CloseAll();
            // end::passive-stop-listener[]
        }

        public void AcceptConnection()
        {
            // tag::advertizer-accept[]
            var connection = new PassivePeerConnection(); /* implements MessageEndpointConnection */
            _messageEndpointListener?.Accept(connection);
            // end::advertizer-accept[]
        }

        public void Disconnect()
        {
            // tag::passive-replicator-close[]
            _replicatorConnection?.Close(null);
            // end::passive-replicator-close[]
        }

        public void Receive(byte[] data)
        {
            // tag::passive-peer-receive[]
            var message = Message.FromBytes(data);
            _replicatorConnection?.Receive(message);
            // end::passive-peer-receive[]
        }

        // tag::passive-peer-close[]
        /* implementation of MessageEndpointConnection */
        public async Task Close(Exception error)
        {
            // await socket.Close, etc (or do nothing if already closed)
            // throw MessagingException if something goes wrong (though
            // since it is "close" nothing special will happen)
        }
        // end::passive-peer-close[]

        // tag::passive-peer-open[]
        /* implementation of MessageEndpointConnection */
        public Task Open(IReplicatorConnection connection)
        {
            _replicatorConnection = connection;
            // socket should already be open on the passive side
            return Task.FromResult(true);
        }
        // end::passive-peer-open[]

        // tag::passive-peer-send[]
        /* implementation of MessageEndpointConnection */
        public async Task Send(Message message)
        {
            var data = message.ToByteArray();
            // await Socket.Send(), etc
            // throw MessagingException if something goes wrong
        }
        // end::passive-peer-send[]
    }

    // tag::predictive-model[]
    // `TensorFlowModel` is a fake implementation
    // this would be the implementation of the ml model you have chosen
    class TensorFlowModel
    {
        public static IDictionary&lt;string, object&gt; PredictImage(byte[] data)
        {
            // Do calculations, etc
            return null;
        }
    }

    class ImageClassifierModel : IPredictiveModel
    {
        public DictionaryObject Predict(DictionaryObject input)
        {
            var blob = input.GetBlob("photo");
            if (blob == null) {
                return null;
            }

            var imageData = blob.Content;
            // `TensorFlowModel` is a fake implementation
            // this would be the implementation of the ml model you have chosen
            var modelOutput = TensorFlowModel.PredictImage(imageData);
            return new MutableDictionaryObject(modelOutput); <i class="conum" data-value="1"></i><b>(1)</b>
        }
    }
    // end::predictive-model[]

    // tag::custom-logging[]
    private class LogTestLogger : ILogger
    {
        public LogLevel Level { get; set; }

        public void Reset()
        {
            _lines.Clear();
        }

        public void Log(LogLevel level, LogDomain domain, string message)
        {
            // handle the message, for example piping it to
            // a third party framework
        }
    }
    // end::custom-logging[]

    // tag::local-win-conflict-resolver[]
    class LocalWinConflictResolver : IConflictResolver
    {
        Document Resolve(Conflict conflict)
        {
            return conflict.LocalDocument;
        }
    }
    // end::local-win-conflict-resolver[]

    // tag::remote-win-conflict-resolver[]
    class RemoteWinConflictResolver : IConflictResolver
    {
        public Document Resolve(Conflict conflict)
        {
            return conflict.RemoteDocument;
        }
    }
    // end::remote-win-conflict-resolver[]

    // tag::merge-conflict-resolver[]
    class MergeConflictResolver : IConflictResolver
    {
        public Document Resolve(Conflict conflict)
        {
            var localDict = conflict.LocalDocument.ToDictionary();
            var remoteDict = conflict.RemoteDocument.ToDictionary();
            var result = localDict.Concat(remoteDict)
               .GroupBy(kv =&gt; kv.Key)
               .ToDictionary(g =&gt; g.Key, g =&gt; g.First().Value);
            return new MutableDocument(conflict.DocumentID, result);
        }
    }
    // end::merge-conflict-resolver[]


// N1QL QUERY


  public  List&lt;Result&gt; testN1QLQueryString (Database argDB)
  {
      // For Documentation
      DatabaseConfiguration dbCfg = new DatabaseConfiguration();
      dbCfg.Directory =
          Path.Combine(Service.GetInstance&lt;IDefaultDirectoryResolver&gt;().DefaultDirectory(), username);
      // tag::query-syntax-n1ql[]
      Database thisDb = new Database(dbName, dbCfg);

      var thisQuery =
          thisDb.CreateQuery(
              "SELECT META().id AS thisId FROM $thisDb.name " +
              "WHERE type = $type"); <i class="conum" data-value="22"></i><b>(22)</b>

      thisQuery.Parameters.SetString("type", "hotel"); <i class="conum" data-value="23"></i><b>(23)</b>

      var results = thisQuery.Execute().AllResults();

      return results;
      // end::query-syntax-n1ql[]
  }

    // tag::query-syntax-n1ql-params[]
    tbd
    // end::query-syntax-n1ql-params[]

    // tag::query-access-n1ql[]
    tbd
    // end::query-access-n1ql[]


// QUERY RESULT SET HANDLING EXAMPLES

    public static void testQuerySyntaxAll()
    {
        // For Documentation
        var dbName = "travel-sample";

        string thisDocsId;
        string thisDocsName;
        string thisDocsType;
        string thisDocsCity;
        Dictionary&lt;string,object&gt; hotel = new Dictionary&lt;string,object&gt;();

        // tag::query-syntax-all[]
        var this_Db = new Database("hotels") ;

        var query = QueryBuilder
              .Select(SelectResult.All())
              .From(DataSource.Database(this_Db));

        // end::query-syntax-all[]

        // tag::query-access-all[]
        var results = query.Execute().AllResults();

        if (results?.Count &gt; 0)
        {
            List&lt;Dictionary&lt;string,object&gt;&gt; hotels = new List&lt;Dictionary&lt;string,object&gt;&gt;();
            foreach (var result in results)
            {
                // get the result into our dictionary object
                var thisDocsProps = result.GetDictionary(dbName); <i class="conum" data-value="24"></i><b>(24)</b>

                if (thisDocsProps != null)
                {
                    thisDocsId = thisDocsProps.GetString("id"); <i class="conum" data-value="25"></i><b>(25)</b>
                    thisDocsName = thisDocsProps.GetString("name");
                    thisDocsCity = thisDocsProps.GetString("city");
                    thisDocsType = thisDocsProps.GetString("type");
                    hotel = thisDocsProps.ToDictionary();
                    hotels.Add(hotel);
                }

            }
        }
        // end::query-access-all[]

    // tag::query-access-json[]

    foreach (var result in query.Execute().AsEnumerable()) {

        // get the result into a JSON String
                var thisDocsJSONString = result.ToJSON();<i class="conum" data-value="26"></i><b>(26)</b>

        // Get a native dictionary object using the JSON string
        var dictFromJSONstring =
              JsonConvert.
                DeserializeObject&lt;Dictionary&lt;string, object&gt;&gt;
                  (thisDocsJSONString); <i class="conum" data-value="27"></i><b>(27)</b>

        // use the created dictionary
        if (dictFromJSONstring != null)
        {
            thisDocsId = dictFromJSONstring["id"].ToString();
            thisDocsName = dictFromJSONstring["name"].ToString();
            thisDocsCity = dictFromJSONstring["city"].ToString();
            thisDocsType = dictFromJSONstring["type"].ToString();
        }

        //Get a custom object using the JSON string
        Hotel this_hotel =
            JsonConvert.DeserializeObject&lt;Hotel&gt;(thisDocsJSONString); <i class="conum" data-value="28"></i><b>(28)</b>

        // Store this hotel object in a list of hotels
        hotels.Add(
            this_hotel.Id.ToString(),
                this_hotel);

    } // end foreach result
    // end::query-access-json[]
  }


    private static void testQuerySyntaxProps()
    {
        // For Documentation
        var dbName = "travel-sample";
        // var this_Db = new Database(dbName);

        string thisDocsName;
        string thisDocsType;
        string thisDocsCity;
        // tag::query-syntax-props[]
        var this_Db = new Database("hotels") ;

        Dictionary&lt;string, object&gt; hotel = new Dictionary&lt;string, object&gt;();

        List&lt;Dictionary&lt;string, object&gt;&gt; hotels = new List&lt;Dictionary&lt;string, object&gt;&gt;();

        var query = QueryBuilder.Select(
                SelectResult.Property("type"),
                SelectResult.Property("name"),
                SelectResult.Property("city")).From(DataSource.Database(this_Db));
        // end::query-syntax-props[]

        // tag::query-access-props[]
        var results = query.Execute().AllResults();
        foreach (var result in results)
        {

            // get the returned array of k-v pairs into a dictionary
            hotel = result.ToDictionary();

            // add hotel dictionary to list of hotel dictionaries
            hotels.Add(hotel);

            // use the properties of the returned array of k-v pairs directly
            thisDocsType = result.GetString("type");
            thisDocsName = result.GetString("name");
            thisDocsCity = result.GetString("city");

        }

    // end::query-access-props[]
    } // test-query-access-props



    private static void testQuerySyntaxCount()
    {
        // For Documentation
        var dbName = "travel-sample";
        // var this_Db = new Database(dbName);

        Dictionary&lt;string, object&gt; hotel = new Dictionary&lt;string, object&gt;();
        List&lt;Dictionary&lt;string, object&gt;&gt; hotels = new List&lt;Dictionary&lt;string, object&gt;&gt;();

        // tag::query-syntax-count-only[]
        var this_Db = new Database("hotels") ;

        var query =
          QueryBuilder
            .Select(SelectResult.Expression(Function.Count(Expression.All())).As("mycount")) <i class="conum" data-value="29"></i><b>(29)</b>
            .From(DataSource.Database(this_Db));

        // end::query-syntax-count-only[]


        // tag::query-access-count-only[]

        var results = query.Execute().AllResults();

        foreach (var result in results)
        {

            var numberOfDocs = result.GetInt("mycount"); <i class="conum" data-value="30"></i><b>(30)</b>

        }

        // end::query-access-count-only[]
    }




    private static void ibQueryForID()
    {

        // For Documentation
        var dbName = "travel-sample";
        // var this_Db = new Database(dbName);

        Dictionary&lt;string, object&gt; hotel = new Dictionary&lt;string, object&gt;();
        List&lt;Dictionary&lt;string, object&gt;&gt; hotels = new List&lt;Dictionary&lt;string, object&gt;&gt;();


        // tag::query-syntax-id[]
        var this_Db = new Database("hotels") ;

        var query = QueryBuilder
                .Select(SelectResult.Expression(Meta.ID).As("this_ID"))
                .From(DataSource.Database(this_Db));

        // end::query-syntax-id[]


        // tag::query-access-id[]
        var results = query.Execute().AllResults();
        foreach (var result in results)
        {

            var thisDocsID = result.GetString("this_ID"); <i class="conum" data-value="31"></i><b>(31)</b>
            var doc = this_Db.GetDocument(thisDocsID);
        }

        // end::query-access-id[]
    }


// tag::query-syntax-pagination-all[]
    private static void testQueryPagination()
    {
      // For Documentation
      var dbName = "travel-sample";
      // var this_Db = new Database(dbName);

    // tag::query-syntax-pagination[]
      var this_Db = new Database("hotels") ;

      var thisLimit = 20;
      var thisOffset = 0;

      // get a count of the number of docs matching the query
      var countQuery =
          QueryBuilder
              .Select(SelectResult.Expression(Function.Count(Expression.All())).As("mycount"))
              .From(DataSource.Database(this_Db));
      var numberOfDocs =
          countQuery.Execute().AllResults().ElementAt(0).GetInt("mycount");

      if (numberOfDocs &lt; thisLimit) {
          thisLimit = numberOfDocs;
      }

      while (thisOffset &lt; numberOfDocs)
      {
          var listQuery =
              QueryBuilder
                  .Select(SelectResult.All())
                  .From(DataSource.Database(this_Db))
                  .Limit(Expression.Int(thisLimit), Expression.Int(thisOffset)); <i class="conum" data-value="32"></i><b>(32)</b>

          foreach (var result in listQuery.Execute().AllResults())
          {
              // Display and or process query results batch

          }

          thisOffset = thisOffset + thisLimit;

      } // end while

// end::query-syntax-pagination[]
// end::query-syntax-pagination-all[]
    }

    // JSONAPIMETHODS



        public void JsonApiDocument()
        {

            // tag::tojson-document[]
            Database this_DB = new Database("travel-sample");
            Database newDb = new Database("ournewdb");

            // Get a document
            var thisDoc = this_Db.GetDocument("hotel_10025");

            // Get document data as JSON String
            var thisDocAsJsonString = thisDoc?.ToJSON(); <i class="conum" data-value="33"></i><b>(33)</b>

            // Get Json Object from the Json String
            JObject myJsonObj = JObject.Parse(thisDocAsJsonString);

            // Get Native Object (anhotel) from JSON String
            List&lt;Hotel&gt; thehotels = new List&lt;Hotel&gt;();

            Hotel anhotel = new Hotel();
            anhotel = JsonConvert.DeserializeObject&lt;Hotel&gt;(thisDocAsJsonString);
            thehotels.Add(anhotel);

            // Update the retrieved native object
            anhotel.Name = "A Copy of " + anhotel.Name;
            anhotel.Id = "2001";

            // Convert the updated object back to a JSON string
            var newJsonString = JsonConvert.SerializeObject(anhotel);

            // Update new document with JSOn String
            MutableDocument newhotel =
                new MutableDocument(anhotel.Id, newJsonString); <i class="conum" data-value="34"></i><b>(34)</b>

            foreach (string key in newhotel.ToDictionary().Keys)
            {
                System.Console.WriteLine("Data -- {0} = {1}",
                    key, newhotel.GetValue(key));
            }

            newDb.Save(newhotel);

            var thatDoc = newDb.GetDocument("2001").ToJSON(); <i class="conum" data-value="35"></i><b>(35)</b>
            System.Console.Write(thatDoc);

            // end::tojson-document[]


        //    // tag::tojson-document-output[]
        //    JSON String = { "description":"Very good and central","id":"1000","country":"France","name":"Hotel Ted","type":"hotel","city":"Paris"}
        //             type = hotel
        //             id = 1000
        //             country = France
        //             city = Paris
        //             description = Very good and central
        //             name = Hotel Ted
        //        // end::tojson-document-output[]
        //         */

        } // End JSONAPIDocument


    public void JsonApiArray()
        {
            // Init for docs
            //var this_Db = DataStore.getDbHandle();
            var ourdbname = "ournewdb";

            if (Database.Exists(ourdbname, "/"))
            {
                Database.Delete(ourdbname, "/");
            }

        // tag::tojson-array[]

            Database dbNew = new Database(ourdbname);

            // JSON String -- an Array (3 elements. including embedded arrays)
            var thisJSONstring = "[{'id':'1000','type':'hotel','name':'Hotel Ted','city':'Paris','country':'France','description':'Undefined description for Hotel Ted'},{'id':'1001','type':'hotel','name':'Hotel Fred','city':'London','country':'England','description':'Undefined description for Hotel Fred'},                        {'id':'1002','type':'hotel','name':'Hotel Ned','city':'Balmain','country':'Australia','description':'Undefined description for Hotel Ned','features':['Cable TV','Toaster','Microwave']}]".Replace("'", "\"");

            // Get JSON Array from JSON String
            JArray myJsonObj = JArray.Parse(thisJSONstring);

            // Create mutable array using JSON String Array
            var myArray = new MutableArrayObject();
            myArray.SetJSON(thisJSONstring);  <i class="conum" data-value="36"></i><b>(36)</b>


            // Create a new documenty for each array element
            for (int i = 0; i &lt; myArray.Count; i++)
            {
                var dict = myArray.GetDictionary(i);
                var docid = myArray[i].Dictionary.GetString("id");
                var newdoc = new MutableDocument(docid, dict.ToDictionary()); <i class="conum" data-value="37"></i><b>(37)</b>
                dbNew.Save(newdoc);
            }

            // Get one of the created docs and iterate through one of the embedded arrays
            var extendedDoc = dbNew.GetDocument("1002");
            var features = extendedDoc.GetArray("features");
            <i class="conum" data-value="38"></i><b>(38)</b>
            foreach (string feature in features) {
                System.Console.Write(feature);
                //process array item as required
            }
            var featuresJSON = extendedDoc.GetArray("features").ToJSON(); <i class="conum" data-value="39"></i><b>(39)</b>

            // end::tojson-array[]
        }


        public void JsonApiDictionary()
        {

            var ourdbname = "ournewdb";

            if (Database.Exists(ourdbname, "/"))
            {
                Database.Delete(ourdbname, "/");
            }
            Database dbNew = new Database(ourdbname);

            // tag::tojson-dictionary[]

            // Get dictionary from JSONstring
            var aJSONstring = "{'id':'1002','type':'hotel','name':'Hotel Ned','city':'Balmain','country':'Australia','description':'Undefined description for Hotel Ned','features':['Cable TV','Toaster','Microwave']}".Replace("'", "\"");
            var myDict = new MutableDictionaryObject(json: aJSONstring); <i class="conum" data-value="40"></i><b>(40)</b>

            // use dictionary to get name value
            var name = myDict.GetString("name");


            // Iterate through keys
            foreach (string key in myDict.Keys)
            {
                System.Console.WriteLine("Data -- {0} = {1}", key, myDict.GetValue(key).ToString());

            }
            // end::tojson-dictionary[]

            /*
            // tag::tojson-dictionary-output[]

                mono-stdout: Data -- id = 1002
                mono-stdout: Data -- type = hotel
                mono-stdout: Data -- name = Hotel Ned
                mono-stdout: Data -- city = Balmain
                mono-stdout: Data -- country = Australia
                mono-stdout: Data -- description = Undefined description for Hotel Ned
                mono-stdout: Data -- features = Couchbase.Lite.MutableArrayObject

            // end::tojson-dictionary-output[]
            */
        } /* end of func */


         public void JsonApiBlob()
        {
            // Init
            var ourpath = DataStore.getUserFolder();
            var ourdbname = "ournewdb";
            var userName = "ian";
            //ourpath = Path.Combine(ourpath,userName);

            if (Database.Exists(ourdbname, ourpath))
            {
                Database.Delete(ourdbname, ourpath);
            }
            var dbCfg = new DatabaseConfiguration();
            dbCfg.Directory=ourpath;
            Database dbNew = new Database(ourdbname,dbCfg);

            // tag::tojson-blob[]

            // Initialize base document for blob from a JSON string
            var docId = "1002";
            var aJSONstring = "{'ref':'hotel_1002','type':'hotel','name':'Hotel Ned'," +
                "'city':'Balmain','country':'Australia'," +
                "'description':'Undefined description for Hotel Ned'," +
                "'features':['Cable TV','Toaster','Microwave']}".Replace("'", "\"");
            var myDoc = new MutableDocument(docId, aJSONstring); <i class="conum" data-value="41"></i><b>(41)</b>


            // Get the content (an image), create blob and add to doc)
            var defaultDirectory =
                Path.Combine(Service.GetInstance&lt;IDefaultDirectoryResolver&gt;()
                            .DefaultDirectory(),
                                userName);
            var myImagePath = Path.Combine(defaultDirectory, "avatarimage.jpg");
            var myImageUri = new Uri(myImagePath.ToString());
            var myBlob = new Blob("image/jpg", myImageUri); <i class="conum" data-value="42"></i><b>(42)</b>
            myDoc.SetBlob("avatar", myBlob); <i class="conum" data-value="43"></i><b>(43)</b>


            // This example generates a 'blob not saved' exception
            try { Console.WriteLine("myBlob (unsaved) as JSON = {0}", myBlob.ToJSON());}
                catch (Exception e)
                    {Console.WriteLine("Exception = {0}", e.Message);}

            dbNew.Save(myDoc);

            // Alternatively -- depending on use case
            dbNew.SaveBlob(new Blob("image/jpg", myImageUri)); <i class="conum" data-value="44"></i><b>(44)</b>


            // Retrieve saved doc, get blob as JSON andheck its still a 'blob'
            var sameDoc = dbNew.GetDocument(docId);
            var reconstitutedBlob = new MutableDictionaryObject().
                SetDictionary("blobCOPY", new MutableDictionaryObject(sameDoc.GetBlob("avatar").ToJSON())); <i class="conum" data-value="45"></i><b>(45)</b>

            if (Blob.IsBlob(
                    reconstitutedBlob.GetDictionary("blobCOPY").ToDictionary()))  <i class="conum" data-value="46"></i><b>(46)</b>
            {
               //... process accordingly
               Console.WriteLine("Its a Blob!!");
            }

            // end::tojson-blob[]
            var datavalue = "";
            foreach (string key in myDoc.Keys)
            {
                if (key == "features")
                {
                    datavalue = "features are: ";
                    foreach (string item in myDoc.GetArray(key))
                    {
                        datavalue = datavalue + ", " + item;
                    }
                }
                else if (key == "avatar")
                {
                    datavalue = sameDoc.GetBlob(key).ToJSON();
                }
                else
                {
                    datavalue = sameDoc.GetValue(key).ToString();
                }

                System.Console.WriteLine(" Data -- {0} = {1}", key, datavalue);
            }

            // System.Console.WriteLine(" reconstitutedBlob = {0}", reconstitutedBlob.GetDictionary("blobCOPY").ToJSON());



            //}

            /*
            // tag::tojson-blob-output[]


                Exception = Missing Digest Due To Blob Is Not Saved To Database yet.

                Data -- id = 1002
                Data -- type = hotel
                Data -- name = Hotel Ned
                Data -- city = Balmain
                Data -- country = Australia
                Data -- description = Undefined description for Hotel Ned
                Data -- features = features are: , Cable TV, Toaster, Microwave
                Data -- avatar = {"digest":"sha1-sdCxeOeP3IZV4FEvVVlvtulpWA8=","length":2975,"content_type":"image/jpg","@type":"blob"}

                blobAsJSONstring = {"digest":"sha1-sdCxeOeP3IZV4FEvVVlvtulpWA8=","length":2975,"content_type":"image/jpg","@type":"blob"}

            // end::tojson-blob-output[]
            */
        } /* end of func */




  } // end of class



// p2p sync items


// tag::listener-simple[]
var thisConfig = new URLEndpointListenerConfiguration(thisDB); <i class="conum" data-value="47"></i><b>(47)</b>

thisConfig.Authenticator =
  new ListenerPasswordAuthenticator(
    (sender, username, password) =&gt;
      {
      return username.equals("valid.user")  &amp;&amp; (password == validPassword);
      }
  ); <i class="conum" data-value="48"></i><b>(48)</b>

_thisListener = new URLEndpointListener(thisConfig); <i class="conum" data-value="49"></i><b>(49)</b>

_thisListener.Start(); <i class="conum" data-value="50"></i><b>(50)</b>

// end::listener-simple[]



// tag::replicator-simple[]
var theListenerEndpoint = new URLEndpoint("wss://listener.com:4984/otherDB"); <i class="conum" data-value="51"></i><b>(51)</b>

var thisConfig = new ReplicatorConfiguration(thisDB, theListenerEndpoint); <i class="conum" data-value="52"></i><b>(52)</b>

thisConfig.AcceptOnlySelfSignedServerCertificate = true; <i class="conum" data-value="53"></i><b>(53)</b>

thisConfig.Authenticator =
  new BasicAuthenticator("valid.user", "valid.password.string"); <i class="conum" data-value="54"></i><b>(54)</b>

var thisReplicator = new Replicator(thisConfig); <i class="conum" data-value="55"></i><b>(55)</b>

thisReplicator.Start(); <i class="conum" data-value="56"></i><b>(56)</b>

// end::replicator-simple[]







// PASSIVE PEER STUFF
// Stuff I adapted
//
//
// p2pSync-websockets.cs
//
// Copyright (c) 2017 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Cryptography.X509Certificates;
using System.Threading;
using System.Threading.Tasks;

using Couchbase.Lite;
using Couchbase.Lite.Enterprise.Query;
using Couchbase.Lite.Logging;
using Couchbase.Lite.P2P;
using Couchbase.Lite.Query;
using Couchbase.Lite.Sync;
using Newtonsoft.Json;

using SkiaSharp;
namespace api_walkthrough
{
  class Program
  {
  private static Database _Database;
  private static Replicator _Replicator;
  private static ListenerToken _thisListenerToken;
  private static bool _NeedsExtraDocs;

  #region Private Methods
  private static void GettingStarted()
  {
    // tag::listener-initialize[]

    // tag::listener-config-db[]
    // Initialize the listener config
    var thisConfig = new URLEndpointListenerConfiguration(thisDB); <i class="conum" data-value="57"></i><b>(57)</b>

    // end::listener-config-db[]
    // tag::listener-config-port[]
    thisConfig.Port = 55990; <i class="conum" data-value="58"></i><b>(58)</b>

    // end::listener-config-port[]
    // tag::listener-config-netw-iface[]
    thisConfig.NetworkInterface = "10.1.1.10"; <i class="conum" data-value="59"></i><b>(59)</b>

    // end::listener-config-netw-iface[]
    // tag::listener-config-delta-sync[]
    thisConfig.EnableDeltaSync = true; <i class="conum" data-value="60"></i><b>(60)</b>

    // end::listener-config-delta-sync[]
    // tag::listener-config-tls-full[]
    // tag::listener-config-tls-enable[]
    thisConfig.DisableTLS = false; <i class="conum" data-value="61"></i><b>(61)</b>

    // end::listener-config-tls-enable[]
    // tag::listener-config-tls-id-anon[]
    // Use an Anonymous Self-Signed Cert
    thisConfig.TlsIdentity = null; <i class="conum" data-value="62"></i><b>(62)</b>

    // end::listener-config-tls-id-anon[]
    // tag::listener-config-client-auth-pwd[]
    // Configure the client authenticator
    // Here we are using Basic Authentication) <i class="conum" data-value="63"></i><b>(63)</b>
    SecureString validPassword =  new SecureString(); /* example only */
    // Get SecureString input for validPassword
    var validUser = "valid.username";
    thisConfig.Authenticator = new ListenerPasswordAuthenticator(
      (sender, validUser, validPassword) =&gt;
        {
          return username.equals(validUser)  &amp;&amp; password == validPassword);
        }
      );

    // end::listener-config-client-auth-pwd[]
    // tag::listener-start[]
    // Initialize the listener
    _thisListener = new URLEndpointListener(thisConfig); <i class="conum" data-value="64"></i><b>(64)</b>

    // Start the listener
    thisListener.Start(); <i class="conum" data-value="65"></i><b>(65)</b>

    // end::listener-start[]
    // end::listener-initialize[]
  }

  // tag::old-listener-config-tls-disable[]
  thisConfig.disableTLS = true;
  // end::old-listener-config-tls-disable[]

  // tag::listener-config-tls-id-nil-2[]

  // Use anonymous cert. These are self signed certs created by the system
  thisConfig.TlsIdentity = null;
  // end::listener-config-tls-id-nil-2[]


  // tag::old-listener-config-delta-sync[]
  thisConfig.EnableDeltaSync = true;
  // end::old-listener-config-delta-sync[]


  // tag::listener-status-check[]
  int connectionCount = thisListener.Status.ConnectionCount; <i class="conum" data-value="66"></i><b>(66)</b>
  int activeConnectionCount = thisListener.Status.ActiveConnectionCount;  <i class="conum" data-value="67"></i><b>(67)</b>

  // end::listener-status-check[]


  // tag::listener-stop[]
  thisListener.Stop();

  // end::listener-stop[]

// Additional snippets


// tag::listener-get-network-interfaces[]
foreach(NetworkInterface ni in NetworkInterface.GetAllNetworkInterfaces())
{
  if(ni.NetworkInterfaceType == NetworkInterfaceType.Wireless80211 ||
      ni.NetworkInterfaceType == NetworkInterfaceType.Ethernet)
  {
    // do something with the interface(s)
  }
}

// end::listener-get-network-interfaces[]


// tag::listener-get-url-list[]
var thisConfig = new URLEndpointListenerConfiguration(thisDB);
_thisListener = new URLEndpointListener(thisConfig);

_thisListener.Start();

 Console.WriteLine("URLS are {0} ", thisListener.Urls;

// end::listener-get-url-list[]

    // tag::listener-config-tls-disable[]
    thisConfig.DisableTLS = true; <i class="conum" data-value="68"></i><b>(68)</b>

    // end::listener-config-tls-disable[]

    // tag::listener-local-db[]
    // . . . preceding application logic . . .
    // Get the database (and create it if it doesn't exist)
    var thisDB = new Database("mydb");

    // end::listener-local-db[]

    // tag::listener-config-tls-id-full[]
    // tag::listener-config-tls-id-caCert[]
    // Use CA Cert
    // Create a TLSIdentity from an imported key-pair
    // . . . previously declared variables include ...
    TLSIdentity thisIdentity;
    X509Store _store =
      new X509Store(StoreName.My); // create and label x509 store

    // Get keys and certificates from PKCS12 data
    byte[] thisIdData =
      File.ReadAllBytes("c:client.p12"); <i class="conum" data-value="69"></i><b>(69)</b>
    // . . . other user code . . .

    // tag::import-tls-identity[]
    thisIdentity = TLSIdentity.ImportIdentity(
      _store,
      thisIdData, <i class="conum" data-value="70"></i><b>(70)</b>
      "123", // Password to access certificate data
      "couchbase-demo-cert",
      null); // Label to get cert in certificate map
        // NOTE: If a null label is supplied then the same
        // default directory for a Couchbase Lite database
        // is used for map.

    // end::import-tls-identity[]
    // end::listener-config-tls-id-caCert[]

    // tag::listener-config-tls-id-anon[]
    // Use an Anonymous Self-Signed Cert
    thisConfig.TlsIdentity = null; <i class="conum" data-value="71"></i><b>(71)</b>

    // end::listener-config-tls-id-anon[]
    // tag::listener-config-tls-id-set[]
    // Set the TLS Identity
    thisConfig.TlsIdentity = thisIdentity; <i class="conum" data-value="72"></i><b>(72)</b>

    // end::listener-config-tls-id-set[]
    // end::listener-config-tls-id-full[]

    // tag::listener-config-client-auth-root[]
    // Configure the client authenticator
    // to validate using ROOT CA

    // Get the valid cert chain, in this instance from
    // PKCS12 data containing private key, public key
    // and certificates <i class="conum" data-value="73"></i><b>(73)</b>
    var clientData = File.ReadAllBytes("c:client.p12");
    var ourCaData = File.ReadAllBytes("c:client-ca.der");

    // Get the root certs from the data
    var thisRootCert = new X509Certificate2(ourCaData); <i class="conum" data-value="74"></i><b>(74)</b>

    // Configure the authenticator to use the root certs
    var thisAuth = new ListenerCertificateAuthenticator(new X509Certificate2Collection(thisRootCert));

    thisConfig.Authenticator = thisAuth; <i class="conum" data-value="75"></i><b>(75)</b>

    // Initialize the listener using the config
    _listener = new URLEndpointListener(thisConfig);

    // end::listener-config-client-auth-root[]
    // tag::listener-config-client-auth-lambda[]
    // Configure the client authenticator
    // to validate using application logic

    // Get the valid cert chain, in this instance from
    // PKCS12 data containing private key, public key
    // and certificates <i class="conum" data-value="76"></i><b>(76)</b>
    clientData = File.ReadAllBytes("c:client.p12");
    ourCaData = File.ReadAllBytes("c:client-ca.der");

    // Get the root certs from the data
    var thisRootCert = new X509Certificate2(ourCaData);

    // Configure the authenticator to pass the root certs
    // To a user supplied code block for authentication
    var thisAuth =
      new ListenerCertificateAuthenticator(
        new X509Certificate2Collection(thisRootCert) =&gt; {
          // . . . user supplied code block
          // . . . returns boolean value (true=authenticated)
        }); <i class="conum" data-value="77"></i><b>(77)</b>

    thisConfig.Authenticator = thisAuth; <i class="conum" data-value="78"></i><b>(78)</b>

    // end::listener-config-client-auth-lambda[]



// END Additional






// Listener Callouts

// tag::listener-callouts-full[]

  // tag::listener-start-callouts[]
  &lt;.&gt; Initialize the listener instance using the configuration settings.
  &lt;.&gt; Start the listener, ready to accept connections and incoming data from active peers.
  // end::listener-start-callouts[]


  // tag::listener-status-check-callouts[]

  &lt;.&gt; `connectionCount` -- the total number of connections served by the listener
  &lt;.&gt; `activeConnectionCount` -- the number of active (BUSY) connections currently being served by the listener
  //
  // end::listener-status-check-callouts[]

// tag::listener-config-tls-id-caCert-callouts[]
  &lt;.&gt; Ensure TLS is enabled.
  &lt;.&gt; The identity will be stored in the secure storage using the given label
  &lt;.&gt; PKCS12 data containing private key, public key, and certificates
  &lt;.&gt; The key pair as stored in the byte array
  &lt;.&gt; The password required to access the certificate data
  &lt;.&gt; The key label assigned to the cert in certificate map and used for retrieval
  &lt;.&gt; If null, the same default directory for a Couchbase Lite database is used for map
  &lt;.&gt; Use the TLSIdentity `thisIdentity.`

// end::listener-config-tls-id-caCert-callouts[]

  // tag::listener-config-tls-id-SelfSigned-callouts[]
  &lt;.&gt; Ensure TLS is enabled.
  &lt;.&gt; The identity will be stored in the secure storage using the given label
  &lt;.&gt; When creating a certificate, the common name attribute is required to create a CSR. If the common name is not present in the certificate an exception is thrown.
  &lt;.&gt; If the expiration date is not specified, the expiration date of the certificate is 365 days after creation
  &lt;.&gt; The key label to get cert in certificate map
  &lt;.&gt; If null, the same default directory for a Couchbase Lite database is used for map
  &lt;.&gt; Use the TLSIdentity `thisIdentity.`

  // end::listener-config-tls-id-SelfSigned-callouts[]

// end::listener-callouts-full[]








// tag::old-listener-config-client-auth-root[]
  // cert is a pre-populated object of type:SecCertificate representing a certificate
  // Work in progress. Code snippet to be provided.

  // end::old-listener-config-client-auth-root[]


  // prev content of listener-config-client-auth-self-signed (for ios)
  thisConfig.authenticator = ListenerCertificateAuthenticator.init {
    (cert) -&gt; Bool in
    var cert:SecCertificate
    var certCommonName:CFString?
    let status=SecCertificateCopyCommonName(cert, &amp;certCommonName)
    if (self._allowlistedUsers.contains(["name": certCommonName! as String])) {
      return true
    }
    return false
  }
  // tag::spare-listener-config-client-auth-self-signed[]
  // Work in progress. Code snippet to be provided.

  // end::spare-listener-config-client-auth-self-signed[]

// tag::p2p-ws-api-urlendpointlistener[]
public class URLEndpointListener {
    // Properties <i class="conum" data-value="1"></i><b>(1)</b>
    public let config: URLEndpointListenerConfiguration
    public let port UInt16?
    public let tlsIdentity: TLSIdentity?
    public let urls: Array&lt;URL&gt;?
    public let status: ConnectionStatus?
    // Constructors <i class="conum" data-value="2"></i><b>(2)</b>
    public init(config: URLEndpointListenerConfiguration)
    // Methods <i class="conum" data-value="3"></i><b>(3)</b>
    public func start() throws
    public func stop()
}
// end::p2p-ws-api-urlendpointlistener[]


// tag::p2p-ws-api-urlendpointlistener-constructor[]
let config = URLEndpointListenerConfiguration.init(database: self.oDB)
thisConfig.port = tls ? wssPort : wsPort
thisConfig.disableTLS = !tls
thisConfig.authenticator = auth
self.listener = URLEndpointListener.init(config: config) <i class="conum" data-value="1"></i><b>(1)</b>
// end::p2p-ws-api-urlendpointlistener-constructor[]


// ACTIVE PEER STUFF
// Replication code
//
// Copyright (c) 2019 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

public class Examples {
  private static final String TAG = "EXAMPLE ACTIVE PEER";
  private static final String thisDBNAME = "local-database";
  private final Context context;
  // private Database database;
  // private Replicator replicator;

  public Examples(Context context) { this.context = context; }

  String user = "syncuser";
  String password = "sync9455";
  SecCertificate cert=null;
  String passivePeerEndpoint = "10.1.1.12:8920";
  String passivePeerPort = "8920";
  String passiveDbName = "userdb";
  Database thisDB;
  Replicator thisReplicator;
  ListenerToken replicatorListener;

  //@Test
  public void testActPeerSync() throws CouchbaseLiteException, URISyntaxException {
// tag::p2p-act-rep-func[]
    // . . . preceding code. for example . . .
    private static ListenerToken _thisListenerToken;
    var Database thisDB;
    // . . . other code . . .
    // tag::p2p-act-rep-initialize[]
    // initialize the replicator configuration

    var thisUrl = new URLEndpoint("wss://listener.com:4984/otherDB"); <i class="conum" data-value="79"></i><b>(79)</b>
    var config = new ReplicatorConfiguration(thisDB, thisUrl);

    // end::p2p-act-rep-initialize[]
    // tag::p2p-act-rep-config-type[]

    // Set replicator type
    thisConfig.ReplicatorType = ReplicatorType.PushAndPull;

    // end::p2p-act-rep-config-type[]
    // tag::p2p-act-rep-config-cont[]
    // Configure Sync Mode
    thisConfig.Continuous = true; // default value

    // end::p2p-act-rep-config-cont[]
    // tag::p2p-act-rep-config-self-cert[]
    // Configure Server Security -- only accept self-signed certs
    thisConfig.AcceptOnlySelfSignedServerCertificate = true; <i class="conum" data-value="80"></i><b>(80)</b>

    // end::p2p-act-rep-config-self-cert[]
    // Configure Client Security <i class="conum" data-value="81"></i><b>(81)</b>
    // tag::p2p-act-rep-auth[]
    // Configure basic auth using user credentials
    thisConfig.Authenticator = new BasicAuthenticator("Our Username", "Our Password");

    // end::p2p-act-rep-auth[]
    // tag::p2p-act-rep-config-conflict-full[]
    // tag::p2p-act-rep-config-conflict-builtin[]
    /* Optionally set a conflict resolver call back */ <i class="conum" data-value="82"></i><b>(82)</b>
    // Use built-in resolver
    thisConfig.ConflictResolver = new LocalWinConflictResolver();  //

    // end::p2p-act-rep-config-conflict-builtin[]
    // tag::p2p-act-rep-config-conflict-custom[]
    // optionally use custom resolver
    thisConfig.ConflictResolver = new ConflictResolver(
      (conflict) =&gt; {
        /* define resolver function */
      }
    ); //

    // end::p2p-act-rep-config-conflict-custom[]
    // end::p2p-act-rep-config-conflict-full[]
    // tag::p2p-act-rep-start-full[]
    // Initialize and start a replicator
    // Initialize replicator with configuration data
    var thisReplicator = new Replicator(thisConfig); <i class="conum" data-value="83"></i><b>(83)</b>

    // tag::p2p-act-rep-add-change-listener[]
    // tag::p2p-act-rep-add-change-listener-label[]
    //Optionally add a change listener <i class="conum" data-value="84"></i><b>(84)</b>
    // end::p2p-act-rep-add-change-listener-label[]
    _thisListenerToken =
      thisReplicator.AddChangeListener((sender, args) =&gt;
        {
          if (args.Status.Activity == ReplicatorActivityLevel.Stopped) {
              Console.WriteLine("Replication stopped");
          }
        });

    // end::p2p-act-rep-add-change-listener[]
    // tag::p2p-act-rep-start[]
    // Start replicator
    thisReplicator.Start(); <i class="conum" data-value="85"></i><b>(85)</b>

    // end::p2p-act-rep-start[]
// end::p2p-act-rep-start-full[]
// end::p2p-act-rep-func[]         ***** End p2p-act-rep-func
}

// Additional snippets

    // tag::p2p-act-rep-config-tls-full[]
    // tag::p2p-act-rep-config-cacert[]
    // Configure Server Security -- only accept CA certs
    thisConfig.AcceptOnlySelfSignedServerCertificate = false; <i class="conum" data-value="86"></i><b>(86)</b>

    // end::p2p-act-rep-config-cacert[]
    // tag::p2p-act-rep-config-pinnedcert[]

    // Return the remote pinned cert (the listener's cert)
    byte returnedCert = new byte(thisConfig.getPinnedCertificate()); // Get listener cert if pinned
    // end::p2p-act-rep-config-pinnedcert[]
    // Configure Client Security <i class="conum" data-value="87"></i><b>(87)</b>
    // tag::p2p-act-rep-auth[]
    // Configure basic auth using user credentials
    thisConfig.Authenticator = new BasicAuthenticator("Our Username", "Our Password");

    // end::p2p-act-rep-auth[]
    // end::p2p-act-rep-config-tls-full[]

    // tag::p2p-act-rep-config-cacert-pinned[]
    // Only CA Certs accepted
    thisConfig.AcceptOnlySelfSignedServerCertificate =
      false; <i class="conum" data-value="88"></i><b>(88)</b>

    var thisCert =
      new X509Certificate2(caData); <i class="conum" data-value="89"></i><b>(89)</b>

    thisConfig.PinnedServerCertificate =
      thisCert; <i class="conum" data-value="90"></i><b>(90)</b>

    // end::p2p-act-rep-config-cacert-pinned[]












    // Code to refactor
    Log.i(TAG, "The Replicator is currently " + thisReplicator.Status().getActivityLevel());

    Log.i(TAG, "The Replicator has processed " + t);

    if (thisReplicator.Status().getActivityLevel() == Replicator.ActivityLevel.BUSY) {
          Log.i(TAG, "Replication Processing");
          Log.i(TAG, "It has completed " + thisReplicator.Status().getProgess().getTotal() + " changes");
      }
    // tag::p2p-act-rep-status[]
    _thisReplicator.Stop();
    while (_thisReplicator.Status.Activity != ReplicatorActivityLevel.Stopped) {
        // Database cannot close until replicators are stopped
        Console.WriteLine($"Waiting for replicator to stop (currently {_thisReplicator.Status.Activity})...");
        Thread.Sleep(200);
    }
    _thisDatabase.Close();
    // end::p2p-act-rep-status[]

      // tag::p2p-act-rep-stop[]
      // Stop replication.
      thisReplicator.Stop(); <i class="conum" data-value="91"></i><b>(91)</b>
      // end::p2p-act-rep-stop[]


  }

{
  CouchbaseLite.init(context);
  Database thisDB = new Database("passivepeerdb");  <i class="conum" data-value="92"></i><b>(92)</b>
  // Initialize the listener config
  final URLEndpointListenerConfiguration thisConfig = new URLEndpointListenerConfiguration(database);
  thisConfig.Port(55990)             // &lt;.&gt; Default- port is selected
  thisConfig.DisableTls(false)       // &lt;.&gt; Optional. Defaults to false. You get TLS encryption out-of-box
  thisConfig.EnableDeltaSync(true)   // &lt;.&gt; Optional. Defaults to false.

  // Configure the client authenticator (if using basic auth)
  ListenerPasswordAuthenticator auth = new ListenerPasswordAuthenticator { "Our Username", "Our Password"}; <i class="conum" data-value="93"></i><b>(93)</b>
  thisConfig.Authenticator(auth); <i class="conum" data-value="94"></i><b>(94)</b>

  // Initialize the listener
  final URLEndpointListener listener = new URLEndpointListener( thisConfig ); <i class="conum" data-value="95"></i><b>(95)</b>

  // Start the listener
  listener.Start(); <i class="conum" data-value="96"></i><b>(96)</b>
    }


// tag::createTlsIdentity[]

Map&lt;String, String&gt; X509_ATTRIBUTES = mapOf(
           TLSIdentity.CERT_ATTRIBUTE_COMMON_NAME to "Couchbase Demo",
           TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION to "Couchbase",
           TLSIdentity.CERT_ATTRIBUTE_ORGANIZATION_UNIT to "Mobile",
           TLSIdentity.CERT_ATTRIBUTE_EMAIL_ADDRESS to "noreply@couchbase.com"
       )

TLSIdentity thisIdentity = new TLSIdentity.createIdentity(true, X509_ATTRIBUTES, null, "test-alias");

// end::createTlsIdentity[]


// tag::p2p-tlsid-store-in-keychain[]
. . . work in progress - GetHashCode snippet to be provided
// end::p2p-tlsid-store-in-keychain[]

// tag::deleteTlsIdentity[]
// tag::p2p-tlsid-delete-id-from-keychain[]
TLSIdentity.DeleteIdentity(_store, "alias-to-delete", null);

// end::p2p-tlsid-delete-id-from-keychain[]
// end::deleteTlsIdentity[]

// tag::retrieveTlsIdentity[]
// OPTIONALLY:: Retrieve a stored TLS identity using its alias/label

TLSIdentity thisIdentity = new TLSIdentity.getIdentity("CBL-Demo-Server-Cert")
// end::retrieveTlsIdentity[]


    // Configure the client authenticator (if using Basic Authentication)
    // String validUser = new String("validUsername"); // an example username
    // String validPassword = new String("validPasswordValue"); // an example password

    // ListenerPasswordAuthenticator thisAuth = new ListenerPasswordAuthenticator( <i class="conum" data-value="97"></i><b>(97)</b>
    //   validUser, validPassword -&gt; validUser == "validUsername" &amp;&amp; validPassword == "validPasswordValue" );

    // if (thisAuth) {
    //   thisConfig.Authenticator(auth);
    // }
    // else {
    //   // . . . authentication failed take appropriate exception action
    //   return
    // };




    // tag::old-p2p-act-rep-add-change-listener[]
    ListenerToken thisListener = new thisReplicator.addChangeListener(change -&gt; { <i class="conum" data-value="98"></i><b>(98)</b>
      if (change.Status().getError() != null) {
        Log.i(TAG, "Error code ::  " + change.Status().getError().getCode());
      }
    });

    // end::old-p2p-act-rep-add-change-listener[]



// g u b b i n s
// tag::duff-p2p-tlsid-tlsidentity-with-label[]


    // Configure TLS Cert CA auth using key-stored cert id alias 'doc-sync-server'

    // TLSIdentity thisIdentity = new TLSIdentity.getIdentity("doc-sync-server"); // Get existing TLS ID from sec storage

    // ClientCertificateAuthenticator thisAuth = new ClientCertificateAuthenticator(thisIdentity);

    // thisConfig.Authenticator(thisAuth);



    // USE KEYCHAIN IDENTITY IF EXISTS
    // Check if Id exists in keychain. If so use that Id

    // STILL NEED TO REFACTOR

    do {
      if let thisIdentity = try TLSIdentity.identity(withLabel: "doco-sync-server") {
          print("An identity with label : doco-sync-server already exists in keychain")
          return thisIdentity
          }
    } catch
    {return nil}
    thisAuthenticator.ClientCertificateAuthenticator(identity: thisIdentity )
    thisConfig.thisAuthenticator

    // end::duff-p2p-tlsid-tlsidentity-with-label[]


// tag::old-deleteTlsIdentity[]

String thisAlias = "alias-to-delete";
KeyStore thisKeystore = KeyStore.getInstance("PKCS12"); <i class="conum" data-value="99"></i><b>(99)</b>
thisKeyStore.load= null;
if (thisAlias != null) {
   thisKeystore.deleteEntry(thisAlias);  <i class="conum" data-value="100"></i><b>(100)</b>
}

// end::old-deleteTlsIdentity[]


// cert auth
let rootCertData = SecCertificateCopyData(cert) as Data
let rootCert = SecCertificateCreateWithData(kCFAllocatorDefault, rootCertData as CFData)!
// Listener:
thisConfig.authenticator = ListenerCertificateAuthenticator.init (rootCerts: [rootCert])

SecCertificate thisCert = new SecCertificate(); // populated as nec.

Data rootCertData = new Data(SecCertificateCopyData(thisCert));

let rootCert = SecCertificateCreateWithData(kCFAllocatorDefault, rootCertData as CFData)!
// Listener:
thisConfig.authenticator = ListenerCertificateAuthenticator.init (rootCerts: [rootCert])
// cert auth


// C A L L O U T S

// tag::p2p-act-rep-config-cacert-pinned-callouts[]
&lt;.&gt; Configure to accept only CA certs
&lt;.&gt; Configure the pinned certificate using data from the byte array `cert`
&lt;.&gt; Set the certificate to be compared with that provided by the server
// end::p2p-act-rep-config-cacert-pinned-callouts[]

// tag::??p2p-tlsid-tlsidentity-with-label-callouts[]
&lt;.&gt; PKCS12 data containing private key, public key, and certificates
&lt;.&gt; This is the default value and means that TLS is enabled
// end::??p2p-tlsid-tlsidentity-with-label-callouts[]

// tag::p2p-tlsid-tlsidentity-with-label-callouts[]
&lt;.&gt; Refuse self-signed certificates
&lt;.&gt; Get the identity
&lt;.&gt; Set the Client Certificate Authenticator to require signed certificates with this identity

// end::p2p-tlsid-tlsidentity-with-label-callouts[]


    // tag::old-listener-config-client-root-ca[]
    // Configure the client authenticator
    // to validate using ROOT CA <i class="conum" data-value="101"></i><b>(101)</b>
    byte[] thisCaData; // byte array for CA data
    using (var thisReader = new BinaryReader(stream)) {
      thisCaData = thisReader.ReadBytes(int stream.Length);
    }; // Get cert data

    var thisRootCert = new X509Certificate(thisCaData); //

    thisConfig.Authenticator = new  ListenerCertificateAuthenticator(
      new X509Certificate2Collection(thisRootCert)
    );

    // end::old-listener-config-client-root-ca[]



        // tag::p2p-tlsid-tlsidentity-with-label-per-sam[]
    var db = new Database("other-database");
    _Database = db;
    X509Store _store = new X509Store(StoreName.My);
    TLSIdentity thisIdentity;

    // tag::client-cert-authenticator-root-certs[]

    // Configure the expected server-supplied
    // credentials -- only accept CA Certs
    thisConfig.AcceptOnlySelfSignedServerCertificate = false; <i class="conum" data-value="102"></i><b>(102)</b>

    // Client identity
    thisIdentity =
      TLSIdentity.ImportIdentity(_store,
        clientData,
        "123",
        "CBL-Client-Cert",
        null); <i class="conum" data-value="103"></i><b>(103)</b>

    thisConfig.Authenticator =
      new ClientCertificateAuthenticator(thisIdentity); <i class="conum" data-value="104"></i><b>(104)</b>

    // end::client-cert-authenticator-root-certs[]





    byte[] thisCaData, thisClientData;
    thisClientData = File.ReadAllBytes("C:\\client.p12"); <i class="conum" data-value="105"></i><b>(105)</b>
    thisCaData = File.ReadAllBytes("C:\\client-ca.der");

    // Root certs
    var thisRootCert = new X509Certificate2(thisCaData);
    var thisAuth =
      new ListenerCertificateAuthenticator(
        new X509Certificate2Collection(thisRootCert));

    // Create URL Endpoint Listener
    var thisConfig = new URLEndpointListenerConfiguration(_Database);
    thisConfig.DisableTLS = false; <i class="conum" data-value="106"></i><b>(106)</b>
    thisConfig.Authenticator = thisAuth;
    _listener = new URLEndpointListener(thisConfig);
    _listener.Start();

    // Client identity
    thisIdentity = TLSIdentity.ImportIdentity(_store,
        thisClientData,
        "123",
        "CBL-Client-Cert",
        null);

    // Replicator -- Client
    var database = new Database("client-database");
    var builder = new UriBuilder(
        "wss",
        "localhost",
        _listener.Port,
        $"/{_listener.thisConfig.Database.Name}"
    );

    var url = builder.Uri;
    var target = new URLEndpoint(url);
    var thisConfig = new ReplicatorConfiguration(database, target);
    thisConfig.ReplicatorType = ReplicatorType.PushAndPull;
    thisConfig.Continuous = false;
    thisConfig.Authenticator = new ClientCertificateAuthenticator(thisIdentity);
    thisConfig.AcceptOnlySelfSignedServerCertificate = true;
    thisConfig.PinnedServerCertificate = _listener.TlsIdentity.Certs[0];
    using (var replicator = new Replicator(thisConfig)) {
        replicator.Start();
    }





    // Stop listener after replicator is stopped
    _listener.Stop();

    // end::p2p-tlsid-tlsidentity-with-label-per-sam[]


        // tag::p2p-tlsid-tlsidentity-with-label[]
    // Client identity
    thisIdentity =
      TLSIdentity.ImportIdentity(_store,
        clientData,
        "123",
        "CBL-Client-Cert",
        null); <i class="conum" data-value="107"></i><b>(107)</b>

    thisConfig.Authenticator =
      new ClientCertificateAuthenticator(thisIdentity); <i class="conum" data-value="108"></i><b>(108)</b>

    // end::p2p-tlsid-tlsidentity-with-label[]


// For replications

// BEGIN -- snippets --
//    Purpose -- code samples for use in replication topic

// tag::sgw-repl-pull[]
public class MyClass
{
    public Database Database { get; set; }
    public Replicator Replicator { get; set; } <i class="conum" data-value="1"></i><b>(1)</b>

    public void StartReplication()
    {
        var url = new Uri("ws://localhost:4984/db"); <i class="conum" data-value="2"></i><b>(2)</b>
        var target = new URLEndpoint(url);
        var config = new ReplicatorConfiguration(Database, target)
        {
            ReplicatorType = ReplicatorType.Pull
        };

        Replicator = new Replicator(config);
        Replicator.Start();
    }
}

// end::sgw-repl-pull[]

// tag::sgw-repl-pull-callouts[]
&lt;1&gt; A replication is an asynchronous operation.
To keep a reference to the `replicator` object, you can set it as an instance property.
&lt;2&gt; The URL scheme for remote database URLs has changed in Couchbase Lite 2.0.
You should now use `ws:`, or `wss:` for SSL/TLS connections.
// end::sgw-repl-pull-callouts[]


    // tag::sgw-act-rep-initialize[]
    // initialize the replicator configuration

    var thisUrl = new URLEndpoint("wss://l10.0.2.2:4984/anotherDB"); <i class="conum" data-value="109"></i><b>(109)</b>
    var config = new ReplicatorConfiguration(thisDB, thisUrl);

    // end::sgw-act-rep-initialize[]</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">

</div>
</div>
<div class="paragraph">
<p>{param-leader}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">replicator.RemoveChangeListener(token);</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>=== Document Access Removal Behavior</p>
</div>
<div class="paragraph">
<p>When access to a document is removed on Sync Gateway (see: Sync Gateway&#8217;s <a href="../../../sync-gateway/current/sync-function.html" class="page">Sync Function</a>), the document replication listener sends a notification with the <code>AccessRemoved</code> flag set to <code>true</code> and subsequently purges the document from the database.</p>
</div>
<div id="lbl-repl-pend" class="paragraph">
<p>== Documents Pending Push</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_IsDocumentPending_System_String_">Replicator.IsDocumentPending()</a> is quicker and more efficient.
Use it in preference to returning a list of pending document IDs, where possible.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can check whether documents are waiting to be pushed in any forthcoming sync by using either of the following API methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_GetPendingDocumentIDs">Replicator.GetPendingDocumentIDs()</a> method, which returns a list of document IDs that have local changes, but which have not yet been pushed to the server.</p>
<div class="paragraph">
<p>This can be very useful in tracking the progress of a push sync, enabling the app to provide a visual indicator to the end user on its status, or decide when it is safe to exit.</p>
</div>
</li>
<li>
<p>Use the <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_IsDocumentPending_System_String_">Replicator.IsDocumentPending()</a> method to quickly check whether an individual document is pending a push.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">var url = new Uri("ws://localhost:4984/mydatabase");
var target = new URLEndpoint(url);
var database = new Database("myDB");
var config = new ReplicatorConfiguration(database, target);
config.ReplicatorType  = ReplicatorType.Push;

var replicator = new Replicator(config);

var mydocids =
  new HashSet &lt;string&gt; (replicator.GetPendingDocumentIDs()); <i class="conum" data-value="1"></i><b>(1)</b>


if (mydocids.Count &gt; 0)
{
    Console.WriteLine($"There are {mydocids.Count} documents pending");
    replicator.AddChangeListener((sender, change) =&gt;
    {
        Console.WriteLine($"Replicator activity level is " +
                          change.Status.Activity.ToString());
        // iterate and report-on previously
        // retrieved pending docids 'list'
        foreach (var thisId in mydocids)
            if (!replicator.IsDocumentPending(thisId)) <i class="conum" data-value="2"></i><b>(2)</b>
            {
                Console.WriteLine($"Doc ID {thisId} now pushed");
            };
    });

    replicator.Start();
}</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_GetPendingDocumentIDs">Replicator.GetPendingDocumentIDs()</a> returns a list of the document IDs for all documents waiting to be pushed.
This is a snapshot and may have changed by the time the response is received and processed.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_IsDocumentPending_System_String_">Replicator.IsDocumentPending()</a> returns <code>true</code> if the document is waiting to be pushed, and <code>false</code> otherwise.</td>
</tr>
</table>
</div>
<div id="lbl-repl-stop" class="paragraph">
<p>== Stop</p>
</div>
<div class="paragraph">
<p>Stopping a replication is straightforward.
It is done using <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_Stop">Stop()</a>.
This initiates an asynchronous operation and so is not necessarily immediate.
Your app should account for this potential delay before attempting any subsequent operations, for example closing the database.</p>
</div>
<div class="paragraph">
<p>You can find further information on database operations in {xref-cbl-gp-database}.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Best Practice</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When you start a change listener, save the returned token, you will need it when you remove the listener</p>
</li>
<li>
<p>Remove any active change listener prior to stopping your replication</p>
</li>
<li>
<p>Ensure the replication has completely stopped by checking for a replication status = STOPPED, before closing any associated database</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">// Stop replication.
thisReplicator.Stop(); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First we stop our change listener</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here we initiate the stopping of the replication using the <a href="https://ibsoln.github.io/api/mobile/3.0/couchbase-lite-net/api/Couchbase.Lite.Sync.Replicator.html#Couchbase_Lite_Sync_Replicator_Stop">Stop()</a> method.<br>
Remove any active <a href="#lbl-repl-chng">change listener</a> before stopping the replicator.</td>
</tr>
</table>
</div>
<div id="lbl-nwk-errs" class="paragraph">
<p>== Error Handling</p>
</div>
<div class="paragraph">
<p>When <em>replicator</em> detects a network error it updates its status depending on the error type (permanent or temporary) and returns an appropriate HTTP error code.</p>
</div>
<div class="paragraph">
<p>The following code snippet adds a <code>Change Listener</code>, which monitors a replication for errors and logs the the returned error code.</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">replicator.AddChangeListener((sender, args) =&gt;
{
    if (args.Status.Error != null) {
        Console.WriteLine($"Error :: {args.Status.Error}");
    }
});</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>For permanent network errors</strong> (for example, <code>404</code> not found, or <code>401</code> unauthorized):
<em>Replicator</em> will stop permanently, whether <code>setContinuous</code>  is <em>true</em> or <em>false</em>. Of course, it sets its status to <code>STOPPED</code></p>
</div>
<div class="paragraph">
<p><strong>For recoverable or temporary errors:</strong> <em>Replicator</em> sets its status to <code>OFFLINE</code>, then:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <code>setContinuous=<em>true</em></code> it retries the connection indefinitely</p>
</li>
<li>
<p>If <code>setContinuous=<em>false</em></code> (one-shot) it retries the connection a limited number of times.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following error codes are considered temporary by the Couchbase Lite replicator and thus will trigger a connection retry.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>408</code>: Request Timeout</p>
</li>
<li>
<p><code>429</code>: Too Many Requests</p>
</li>
<li>
<p><code>500</code>: Internal Server Error</p>
</li>
<li>
<p><code>502</code>: Bad Gateway</p>
</li>
<li>
<p><code>503</code>: Service Unavailable</p>
</li>
<li>
<p><code>504</code>: Gateway Timeout</p>
</li>
<li>
<p><code>1001</code>: DNS resolution error</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>== Load Balancers</p>
</div>
<div class="paragraph">
<p>Couchbase Lite <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> uses WebSockets as the communication protocol to transmit data.
Some load balancers are not configured for WebSocket connections by default (NGINX for example);
so it might be necessary to explicitly enable them in the load balancer&#8217;s configuration (see <a href="../../../sync-gateway/current/load-balancer.html" class="page">Load Balancers</a>).</p>
</div>
<div class="paragraph">
<p>By default, the WebSocket protocol uses compression to optimize for speed and bandwidth utilization.
The level of compression is set on Sync Gateway and can be tuned in the configuration file (<a href="#sync-gateway:ROOT:refer/config-properties.adoc#replicator_compression" class="page unresolved"><code>replicator_compression</code></a>).</p>
</div>
<div id="lbl-cert-pinning" class="paragraph">
<p>== Certificate Pinning</p>
</div>
<div class="paragraph">
<p>Couchbase Lite for C#.Net supports certificate pinning.</p>
</div>
<div class="paragraph">
<p>Certificate pinning is a technique that can be used by applications to "pin" a host to its certificate.
The certificate is typically delivered to the client by an out-of-band channel and bundled with the client.
In this case, Couchbase Lite uses this embedded certificate to verify the trustworthiness of the server (for example, a Sync Gateway) and no longer needs to rely on a trusted third party for that (commonly referred to as the Certificate Authority).</p>
</div>
<div class="paragraph">
<p>The following steps describe how to configure certificate pinning between Couchbase Lite and Sync Gateway.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="../../../sync-gateway/current/authentication-certs.html#creating-your-own-self-signed-certificate" class="page">Create your own self-signed certificate</a> with the <code>openssl</code> command.
After completing this step, you should have 3 files: <code>cert.pem</code>, <code>cert.cer</code> and <code>privkey.pem</code>.</p>
</li>
<li>
<p><a href="../../../sync-gateway/current/authentication-certs.html#installing-the-certificate" class="page">Configure Sync Gateway</a> with the <code>cert.pem</code> and <code>privkey.pem</code> files.
After completing this step, Sync Gateway is reachable over <code>https</code>/<code>wss</code>.</p>
</li>
<li>
<p>On the Couchbase Lite side, the replication must point to a URL with the <code>wss</code> scheme and configured with the <code>cert.cer</code> file created in step 1.</p>
<div class="paragraph">
<p>This example loads the certificate from the application sandbox, then converts it to the appropriate type to configure the replication object.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">// Note: `GetCertificate` is a fake method. This would be the platform-specific method
// to find and load the certificate as an instance of `X509Certificate2`.
// For .NET Core / .NET Framework this can be loaded from the filesystem path.
// For UWP, from the assets directory.
// For iOS, from the main bundle.
// For Android, from the assets directory.
var certificate = GetCertificate("cert.cer");
var config = new ReplicatorConfiguration(db, target)
{
    PinnedServerCertificate = certificate
};</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build and run your app.
The replication should now run successfully over https/wss with certificate pinning.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more on pinning certificates see the blog entry: <a href="https://blog.couchbase.com/certificate-pinning-android-with-couchbase-mobile/" target="_blank" rel="noopener">Certificate Pinning with Couchbase Mobile</a></p>
</div>
<div id="lbl-trouble" class="paragraph">
<p>== Troubleshooting</p>
</div>
<div class="paragraph">
<p>=== Logs
As always, when there is a problem with replication, logging is your friend.
You can increase the log output for activity related to replication with Sync Gateway&#8201;&#8212;&#8201;see <a href="#ex-logs">[ex-logs]</a>.</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/csharp/examples/code_snippets/Program.cs">// deprecated
Database.SetLogLevel(LogDomain.Replicator, LogLevel.Verbose);
Database.SetLogLevel(LogDomain.Network, LogLevel.Verbose);</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For more on troubleshooting with logs, see: <a href="troubleshooting-logs.html" class="page">Using Logs</a>.</p>
</div>
<div class="paragraph">
<p>=== Authentication Errors
If Sync Gateway is configured with a self signed certificate but your app points to a <code>ws</code> scheme instead of <code>wss</code> you will encounter an error with status code <code>11006</code>&#8201;&#8212;&#8201;see: <a href="#ex-11006">[ex-11006]</a></p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">CouchbaseLite Replicator ERROR: {Repl#2} Got LiteCore error: WebSocket error 1006 "connection closed abnormally"</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>If Sync Gateway is configured with a self signed certificate, and your app points to a <code>wss</code> scheme but the replicator configuration isn&#8217;t using the certificate you will encounter an error with status code <code>5011</code>&#8201;&#8212;&#8201;see: <a href="#ex-5011">[ex-5011]</a></p>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">CouchbaseLite Replicator ERROR: {Repl#2} Got LiteCore error: Network error 11 "server TLS certificate is self-signed or has unknown root cert"</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>== Related Content</p>
</div>
<div class="card-row three-column-row">
<div class="paragraph column">
<p>====== 
.Learn more &#8230;&#8203;</p>
</div>
<div class="paragraph column">
<div class="title"></div>
<p>====== 
.Reference material &#8230;&#8203;
.</p>
</div>
<div class="paragraph column">
<p>====== 
.Community Resources &#8230;&#8203;</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Couchbase Mobile 2.5+
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. From 2.0
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span> 2021 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script id="site-script" src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
</body>
</html>
