<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Integrating External Stores | Couchbase Docs</title>
    <link rel="canonical" href="https://ibsoln.github.io/myStaging/sync-gateway/2.7/integrating-external-stores.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="sync-gateway">
    <meta name="dcterms.identifier" content="2.7">
    <meta name="generator" content="Antora 2.0.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://ibsoln.github.io/myStaging">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="#">Server</a></li>
                  <li><a href="../../server//n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server//fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server//analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server//eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="#">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.1/index.html">Lite</a></li>
                  <li><a href="index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server//sdk/overview.html">SDKs</a></li>
                  <li><a href="#">C</a></li>
                  <li><a href="#">.NET</a></li>
                  <li><a href="#">Go</a></li>
                  <li><a href="#">Java</a></li>
                  <li><a href="#">Node.js</a></li>
                  <li><a href="#">PHP</a></li>
                  <li><a href="#">Python</a></li>
                  <li><a href="#">Scala</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server//connectors/intro.html">Connectors</a></li>
                  <li><a href="#">Elasticsearch</a></li>
                  <li><a href="../../server//connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="#">Kafka</a></li>
                  <li><a href="#">Spark</a></li>
                  <li><a href="#">Talend</a></li>
                  <li><a href="../../server//connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <a class="navbar-item component" href="index.html"><span class="title">Sync Gateway</span> <span class="version">2.7</span></a>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Introduction</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="introduction.html">Introduction</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="index.html">What&#8217;s New</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="getting-started.html">Getting Started</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="data-modeling.html">Data Modeling</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Access Control</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="users-and-roles.html">Users and Roles</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="authentication.html">Authentication</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sync-gateway-channels.html">Sync Gateway Channels</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="read-access.html">Read Access</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="write-access.html">Write Access</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sync-function.html">Sync Function</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Learn</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="config-properties.html">Configuration File</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="command-line-options.html">CLI</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="shared-bucket-access.html">Mobile-Server Data Sync</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-tombstones.html">Tombstones</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="indexing.html">Indexing</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="server-integration.html">Webhooks and Changes Feed</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="resolving-conflicts.html">Resolving Conflicts</a>
    </span>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="integrating-external-stores.html">Integrating External Stores</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="running-replications.html">Inter-cluster Replication</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="rest-api-client.html">REST API Client</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Manage</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="logging.html">Logging</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="stats-monitoring.html">Stats Monitoring</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sgcollect-info.html">SGCollect Info</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="deployment.html">Deployment</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Sync Gateway on Kubernetes</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="kubernetes/deploy-cluster.html">Deploy a Cluster</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="kubernetes/manage-cluster.html">Manage a Cluster</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="upgrade.html">Upgrade</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="security.html">Security</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="load-balancer.html">Load Balancer</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="database-offline.html">Taking Databases Offline and Online</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="os-level-tuning.html">OS Level Tuning</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">API References</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="rest-api.html">Public REST API</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="admin-rest-api.html">Admin REST API</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Release Notes &amp; Compatibility</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="release-notes.html">Release Notes</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="supported-os.html">Supported OS</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compatibility-matrix.html">Compatibility Matrix</a>
    </span>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Sync Gateway</a></li>
    <li class="crumb">Learn</li>
    <li class="crumb"><a href="integrating-external-stores.html">Integrating External Stores</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="file:///Users/ianbridge/Documents/CouchbaseDocs/sg/modules/ROOT/pages/integrating-external-stores.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Integrating External Stores</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Sync Gateway REST API is divided in two categories: the Public REST API available on port 4984 and the Admin REST API accessible on port 4985.
Those are the default ports and they can be changed in the configuration file of Sync Gateway.</p>
</div>
<div class="paragraph">
<p>In this guide, you will learn how to run the following operations on the Admin REST API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bulk importing of documents.</p>
</li>
<li>
<p>Exporting via the changes feed.</p>
</li>
<li>
<p>Importing attachments.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="external-store"><a class="anchor" href="#external-store"></a>External Store</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, you will use a simple movies API as the external data store. <a href="https://cl.ly/140P313l0p23/external-store.zip">Download the stub data and API server</a> and unzip the content into a new directory.
To start the server of the external store run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd external-store
npm install
node server.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can open a browser window at <code>http://localhost:8000/movies</code> to view the JSON data.</p>
</div>
<div class="paragraph">
<p>The external store supports two endpoints:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">GET <code>/movies</code></dt>
<dd>
<p>Retrieves all movies (from <strong>movies.json</strong>).</p>
</dd>
<dt class="hdlist1">POST <code>/movies</code></dt>
<dd>
<p>Takes one movie as the request body and updates the item with the same <code>_id</code> in <strong>movies.json</strong>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="importing-documents"><a class="anchor" href="#importing-documents"></a>Importing Documents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Sync Gateway Swagger JS library is a handy tool to send HTTP requests without having to write your own HTTP API wrapper.
It relies on the Couchbase Mobile Swagger specs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We do not guarantee that the swagger spec will be aligned with the latest version of the REST API.
The REST API must be considered as the source of truth and in case of any deviations, the REST API will override the swagger spec.
So please consider the spec as a starting point and make any relevant changes as needed to ensure that it is in conformance with the REST API.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this case, you will use the <a href="admin-rest-api.html" class="page">Admin REST API spec</a>.
In the same directory, install the following dependencies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">npm install swagger-client &amp;&amp; request-promise</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.couchbase.com/downloads#couchbase-mobile">Download Sync Gateway</a> and start it from the command line with a database called <code>movies_lister</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">~/Downloads/couchbase-sync-gateway/bin/sync_gateway -dbname movies_lister</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Sync Gateway database is now available at <code>http://localhost:4985/movies_lister/</code>.
Create a new file called <code>import.js</code> with the following to retrieve the movies and insert them in the Sync Gateway database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">var request = require('request-promise')
  , Swagger = require('swagger-client');

var api = 'http://localhost:8000/movies'
  , db = 'movies_lister';

var client = new Swagger({
  url: 'https://docs.couchbase.com/sync-gateway/current/_attachments/sync-gateway-public.yaml',
  usePromise: true
}).then(function (client) {
  var data = [];
  // 1
  request({uri: api, json: true})
    // 2
    .then(function (movies) {
      data = movies;
      return client.database.post_db_bulk_docs({db: db, BulkDocsBody: {docs: movies}});
    })
    .then(function (res) {
      return res.obj;
    })
    // 3
    .each(function (row) {
      var movie = data.filter(function (movie) {
        return movie._id == row.id ? true : false
      })[0];
      movie._rev = row.rev;
      var options = {
        method: 'POST',
        uri: api,
        body: movie,
        headers: {
          'Content-Type': 'application/json'
        },
        json: true
      };
      return request(options);
    })
    .then(function (res) {
      console.log('Revs of ' + res.length + ' imported');
    });
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s what the code above is doing:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the <a href="https://github.com/request/request-promise">request-promise</a> library to retrieve the movies from the external store.</p>
</li>
<li>
<p>Save the movies to Sync Gateway.
The <code>post_db_bulk_docs</code> method takes a db name (<code>movies_lister</code>) and the documents to save in the request body.
Notice that the response from the external store is an array and must be wrapped in a JSON object of the form <code>{docs: movies}</code>.</p>
</li>
<li>
<p>The response of the <code>/{db}/_bulk_docs</code> request contains the generated revision numbers which are written back to the external store.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Admin REST API Swagger spec is dynamically loaded.
You can use the <code>.help()</code> method to query the available object and methods.
This method is very helpful during development as it offers the documentation on the fly in the console.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">client.help(); // prints all the tags to the console
client.database.help(); // prints all the database methods to the console
client.database.post_db_bulk_docs.help(); // prints all the parameters (querystring and request body)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Start the program from the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">node import.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>To verify that the movie documents have been imported, you can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Monitor the Sync Gateway sequence number returned by the database endpoint (<a href="rest-api.html#/database/get__db__" class="page"><code>GET /{db}/</code></a>).
The sequence number increments for every change that happens on the Sync Gateway database.</p>
</li>
<li>
<p>Query a document by ID on the Sync Gateway REST API (<a href="rest-api.html#/document/get__db___doc_" class="page"><code>GET /{db}/{id}</code></a>).</p>
</li>
<li>
<p>Query a document from the Query Workbench on the Couchbase Server Console.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notice that the <code>_rev</code> property is also stored on each record on the external store, <code>movies.json</code>.</p>
</div>
<div class="paragraph">
<p>Run the program again, the same number of documents are visible in Sync Gateway.
This time with a 2nd generation revision number.
This update operation was successful because the parent revision number was sent as part of the request body.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="exporting-documents"><a class="anchor" href="#exporting-documents"></a>Exporting Documents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To export documents from Couchbase Mobile to the external system you will use a changes feed request to subscribe to changes and persist them to the external store.</p>
</div>
<div class="paragraph">
<p>Install the following modules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">npm install swagger-client &amp;&amp; request</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a new file called <code>export.js</code> with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">var request = require('request')
  , Swagger = require('swagger-client');

var api = 'http://localhost:8000/movies'
  , db = 'movies_lister';

var client = new Swagger({
  url: 'https://docs.couchbase.com/sync-gateway/current/_attachments/sync-gateway-admin.yaml',
  success: function () {

    // 1
    client.database.get_db({db: db}, function (res) {
      // 2
      getChanges(res.obj.update_seq);
    });

    function getChanges(seq) {
      // 3
      var options = {db: db, feed: 'longpoll', since: seq, include_docs: true};
      client.database.get_db_changes(options, function (res) {

        var results = res.obj.results;
        for (var i = 0; i &lt; results.length; i++) {
          var row = results[i];
          console.log("Document with ID " + row.id);
          // 4
          var options = {
            url: api,
            method: 'POST',
            body: JSON.stringify(row.doc),
            headers: {
              'Content-Type': 'application/json'
            }
          };
          request(options, function (error, response, body) {
            if (!error &amp;&amp; response.statusCode == 200) {
              var json = JSON.parse(body);
              console.log(json);
              console.log("Wrote update for doc " + json.id + " to external store.");
            }
          });
        }

        getChanges(res.obj.last_seq);
      });
    }

  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s what the code above is doing:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Gets the last sequence number of the database.</p>
</li>
<li>
<p>Calls the <code>getChanges</code> method with the last sequence number.</p>
</li>
<li>
<p>Sends changes request to Sync Gateway with the following parameters:</p>
<div class="ulist">
<ul>
<li>
<p><code>feed=longpoll</code></p>
</li>
<li>
<p><code>include_docs=true</code></p>
</li>
<li>
<p><code>since=X</code> (where X is the sequence number)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Write the document to the external store.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Run the program from the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">node export.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Update a document through the Sync Gateway REST API.
Notice that the change is also updated in the external store.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/export-update.gif" alt="export update">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="importing-attachments"><a class="anchor" href="#importing-attachments"></a>Importing Attachments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Every movie in the stub API has a link to a thumbnail (in the <code>posters.thumbnail</code> property).
Before sending the <code>_bulk_docs</code> request, you will fetch the thumbnail for each movie and embed it as a base64 string under the <code>_attachments</code> property.</p>
</div>
<div class="paragraph">
<p>Install the following dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">npm install request-promise &amp;&amp; swagger-client</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a new file called <code>attachments.js</code> with the following to retrieve the movies, their thumbnails and insert them in the Sync Gateway database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">var request = require('request-promise')
  , Swagger = require('swagger-client');

var api = 'http://localhost:8000/movies'
  , db = 'movies_lister';

var movies = [];

var client = new Swagger({
  url: 'https://docs.couchbase.com/sync-gateway/current/_attachments/sync-gateway-admin.yaml',
  usePromise: true
}).then(function (client) {
  // Get movies from stub API
  request({uri: api, json: true})
    .then(function (res) {
      movies = res;
      // return array of links
      return movies.map(function (movie) {
        return movie.posters.thumbnail;
      });
    })
    .map(function (link) {
      // Fetch each thumbnail, the program continues once
      // all 24 thumbnails are downloaded
      return request({uri: link, encoding: null});
    })
    .then(function (thumbnails) {
      // Save the attachment on each document
      for (var i = 0; i &lt; movies.length; i++) {
        var base64 = thumbnails[i].toString('base64');
        movies[i]._attachments = {
          image: {
            content_type: 'image\/jpg',
            data: base64
          }
        };
      }
      return movies;
    })
    .then(function (movies) {
      // Save the documents and attachments in the same request
      return client.database.post_db_bulk_docs({db: db, BulkDocsBody: {docs: movies}});
    })
    .then(function (res) {
      console.log(res);
    });
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart Sync Gateway to have an empty database and run the program.
The documents are saved with the attachment metadata.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/admin-ui-attachment.png" alt="admin ui attachment">
</div>
</div>
<div class="paragraph">
<p>You can view the thumbnail at <code>http://localhost:4984/movies_lister/{db}/{doc}/{attachment}/</code> (note it&#8217;s on the public port 4984).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sg-attachment.png" alt="sg attachment">
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
